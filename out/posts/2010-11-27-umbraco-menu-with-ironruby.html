<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Creating a menu in Umbraco with IronRuby | LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Creating a menu in Umbraco with IronRuby</h1>
                <h2>27th November 2010</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/ironruby.html"><span>ironruby</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">11th December 2010</span>
                            <h3><a href="/posts/2010-12-11-mercurial-101-for-umbraco-developers.html">Mercurial 101 as an Umbraco developer</a></h3>
                        </header>
                        <p>A Mercurial primer for Umbraco developers</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/mercurial.html"><span>mercurial</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th September 2012</span>
                            <h3><a href="/posts/2012-09-05-text-casing-and-examine.html">Text casing and Examine</a></h3>
                        </header>
                        <p>A few times I&#39;ve seen questions posted on the Umbraco forums which ask how to deal with case insensitivity text with Examine, and itâ€™s also something that we&#39;ve had to handle a few times within our...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/examine.html"><span>examine</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">25th June 2012</span>
                            <h3><a href="/posts/2012-06-25-i-helped-kill-umbraco-5.html">I helped kill Umbraco 5</a></h3>
                        </header>
                        <p>Hi, my name&#39;s Aaron Powell and I was involved in killing Umbraco 5.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-5.html"><span>umbraco-5</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/opinionated.html"><span>opinionated</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">13th June 2012</span>
                            <h3><a href="/posts/2012-06-13-introducing-umbraco-contributor-list.html">Introducing the Umbraco contributor mailing list</a></h3>
                        </header>
                        <p>Keen discuss contributing to Umbraco&#39;s core, join the discussion now!</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">12th June 2012</span>
                            <h3><a href="/posts/2012-06-12-using-mvc-in-umbraco-4.html">Using ASP.NET MVC in Umbraco 4</a></h3>
                        </header>
                        <p>How to combine ASP.Net MVC applications with an Umbraco project</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>Recently I&#39;ve been help a client migrate a number of unmanaged microsites into an Umbraco instance, and since it&#39;s well known that <a href="/why-im-not-a-fan-of-xslt">I&#39;m not a fan of XSLT</a> an alternative is in order. While working at <a href="http://thefarmdigital.com.au">TheFarm</a> I wrote a blog about the different macro options and what <a href="http://farmcode.org/post/2010/07/13/TheFARMe28099s-guide-to-Macros.aspx">we were doing back then</a>. Since moving on I&#39;ve been wanting to avoid using XSLT at all.</p>
<p>Umbraco has supported DLR languages like <a href="http://ironpython.net">IronPython</a> and <a href="http://ironruby.net">IronRuby</a> for quite some time, so I decided to look into it for this new project.</p>
<p>So with the help of fellow Readifarian <a href="http://twitter.com/#!/thomasjo">Thomas Johansen</a> we set about doing a migration of the microsites and running IronRuby where possible (Thomas is a Ruby fan so that&#39;s why we&#39;re choosing IronRuby here).</p>
<p>One of the most common macros I was still writing in XSLT is a navigation, so lets look at how we can do this with IronRuby.</p>
<p><em>Note: With this I&#39;m working on an Umbraco 4.5.2 version of Umbraco, using .NET 3.5</em></p>
<h2>Getting your script ready</h2>
<p>One of the nice things about XSLT is that you can load in XSLT extensions, you know that section at the top of your XSLT file which you need specify <code>xmlns:umbraco.library=&quot;urn:umbraco.library&quot;</code> and so on, well we need to do a similar thing in IronRuby so we have access to the <code>umbraco.library</code> object.</p>
<p>But what&#39;s different here is we just need to open the appropriate objects:</p>
<pre class="highlighted"><code class="ini"><span class="setting">Library = <span class="value">Object.const_get(<span class="string">"umbraco"</span>).const_get(<span class="string">"library"</span>)</span></span></code></pre>
<p>What this is doing is opening the <code>umbraco</code> namespace and then getting the <code>library</code> object from within it (you can chain as many namespaces together as you need to do this too).</p>
<h2>Getting the starting node</h2>
<p>At the moment our sites are only one level deep so we&#39;re being a bit lazy with the loading of the root most node, but basically we want to find a parent some way. Like an XSLT DLR script are provided with the current page node in the form of a <code>currentPage</code> object, so we&#39;ll grab it from here:</p>
<pre class="highlighted"><code class="php"><span class="keyword">parent</span> = currentPage.<span class="keyword">Parent</span></code></pre>
<h2>Building our HTML</h2>
<p>Now that we have our starting node we need to start constructing a navigation, that&#39;s as easy as just writing HTML to the screen:</p>
<pre class="highlighted"><code class="xml">puts '<span class="tag">&lt;<span class="title">nav</span>&gt;</span><span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"navigation"</span>&gt;</span>'

parent.Children.find_all { |c| c.GetProperty("umbracoNaviHide").Value != "1" }.each_with_index do |child, i|
  puts %Q{
    <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">"#{'first' if i == 0}"</span>&gt;</span>
      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#{Library.NiceUrl(child.Id)}"</span> <span class="attribute">class</span>=<span class="value">"#{'selected' if child.Id == currentPage.Id}"</span> <span class="attribute">target</span>=<span class="value">"_self"</span> <span class="attribute">title</span>=<span class="value">"Go to #{child.Name}"</span>&gt;</span>#{child.Name}<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">li</span>&gt;</span>
  }
end

puts '<span class="tag">&lt;/<span class="title">ul</span>&gt;</span><span class="tag">&lt;/<span class="title">nav</span>&gt;</span></code></pre>
<p>Here what we&#39;re doing is creating some HTML which is a HTML5 <code>&lt;nav&gt;</code> element that then encloses a <code>&lt;ul&gt;</code> element. What&#39;s primarily of interest in this script section is the loop.</p>
<p>We&#39;re doing a few things here, first we&#39;re using the <a href="http://ruby-doc.org/core/classes/Enumerable.html#M003124"><code>find_all</code></a> method (you could use a <code>select</code> instead if you want, Ruby has a dozen ways to do the same thing :P). This method we&#39;re doing a filter on the children, ignoring the ones which we want to hide, but you can add what ever conditions you want in there (the <code>c</code> variable is an instance of <code>Node</code> from the Umbraco API). Once we&#39;re got our filtered collection we are then looping through each one using the <a href="http://ruby-doc.org/core/classes/Enumerable.html#M003137"><code>each_with_index</code></a> method which provides us again with the instance of a <code>Node</code> and the position in the array (which is <code>i</code> if you&#39;re not following).</p>
<p>A really cool thing about Ruby is how you can do string formatting, unlike .NET you can put complex logic in your string formatting, which is denoted by the <code>#{ ... }</code> syntax, here we&#39;re doing a few things such as:</p>
<pre class="highlighted"><code class="cs"><span class="preprocessor">#{'first' <span class="keyword">if</span> i == 0}</span></code></pre>
<p>What this does is returns a value of <code>first</code> when the <code>if</code> condition is true, and this is how we can put a class on the first item in the navigation.</p>
<p>We&#39;re also capable of doing other complex things like</p>
<pre class="highlighted"><code class="vala"><span class="preprocessor">#{Library.NiceUrl(child.Id)}</span></code></pre>
<p>And get the URL of the page in-place.</p>
<h2>Wrapping it all up</h2>
<p>Here&#39;s the completed script:</p>
<pre class="highlighted"><code class="xml">Library = Object.const_get("umbraco").const_get("libary")
parent = currentPage.Parent
puts '<span class="tag">&lt;<span class="title">nav</span>&gt;</span><span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"navigation"</span>&gt;</span>'

parent.Children.find_all { |c| c.GetProperty("umbracoNaviHide").Value != "1" }.each_with_index do |child, i|
  puts %Q{
    <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">"#{'first' if i == 0}"</span>&gt;</span>
      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#{Library.NiceUrl(child.Id)}"</span> <span class="attribute">class</span>=<span class="value">"#{'selected' if child.Id == currentPage.Id}"</span> <span class="attribute">target</span>=<span class="value">"_self"</span> <span class="attribute">title</span>=<span class="value">"Go to #{child.Name}"</span>&gt;</span>#{child.Name}<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">li</span>&gt;</span>
  }
end

puts '<span class="tag">&lt;/<span class="title">ul</span>&gt;</span><span class="tag">&lt;/<span class="title">nav</span>&gt;</span>'</code></pre>
<p>That&#39;s a total of 13 lines (including whitespace, which can be condensed to just 7 lines if you change whitespace and HTML formatting) of Ruby code which can build a navigation which will suite a lot of needs. Compare this to the template for <code>NavigationPrototype.xslt</code> which ships within an Umbraco install that is 40 lines (ok, fine it <strong>does</strong> have comments :P). Not bad me things, not bad...</p>
<h2>Conclusion</h2>
<p>IronRuby is a great alternative to writing small macros in Umbraco, it&#39;s a great alternative to using XSLT. If you&#39;re a developer I strongly recommend you look into the DLR support for your Umbraco projects.</p>
<h1>Bonus - making a recursive menu system</h1>
<p>In the above code we&#39;ve make a simple menu system that has a known starting point, but as I pointed out it&#39;s not great if you wanted to have a recursive one? Well let&#39;s have a look at what is required to do that.</p>
<h2>Recursively finding a parent</h2>
<p>The first thing we need to do is work out how to translate this XPath statement (that&#39;s from the template shipped in Umbraco):</p>
<pre class="highlighted"><code class="ruby"><span class="variable">$currentPage</span>/ancestor-<span class="keyword">or</span>-<span class="symbol">self:</span><span class="symbol">:node</span> [<span class="variable">@level</span>=<span class="variable">$level</span>]/node [string(data [<span class="variable">@alias</span>=<span class="string">'umbracoNaviHide'</span>]) != <span class="string">'1'</span>]</code></pre>
<p>into something in Ruby.</p>
<p>But there&#39;s a problem, we&#39;re checking against the <code>@level</code> attribute in XSLT, but the <code>Node</code> object in the Umbraco API <strong>doesn&#39;t have a Level property</strong>! Damn that&#39;s going to make my life harder isn&#39;t it... Well good news is you can get around this with a bit of trickery. What we&#39;re going to do is work against the <code>Id</code> property... but hang on, we don&#39;t <em>know</em> what the Id is of the node at the level we want, and like hell do I want to hard code that anywhere. Well here&#39;s where the trickery comes in.</p>
<p>The <code>Node</code> object has a property on it for the <code>Path</code>, we can use that to <em>fake</em> the level. Since a path is always in a known format, a comma-separated string, we can make that into an array, and then path-from-there ;).</p>
<pre class="highlighted"><code class="ini"><span class="setting">level = <span class="value"><span class="number">2</span></span></span>
<span class="setting">target_parent_id = <span class="value">currentPage.Path.split(',')[level].to_i rescue -<span class="number">1</span></span></span></code></pre>
<p>Since we&#39;re working with microsites here I don&#39;t want the upper-most navigation point for the site, I want the point from the current microsite, so I&#39;m finding the ID of the node at level 2, if you were doing a full site specify the array index position (aka level) to be <code>1</code>.</p>
<p>We&#39;re also doing a <code>rescue</code> here, and that will cause -1 to be returned if we for some reason don&#39;t have an array that is at least 3 items long (it&#39;s not required but it&#39;s just safer and easier to recover from if you have an unexpected error).</p>
<p>You&#39;ll also notice the <code>to_i</code> on the end, this method will convert the string (ie: &quot;1234&quot;) into a number (ie: 1234).</p>
<p>Next we to actually find the parent, so we want to simulate the <code>ancestor-or-self</code> XPath select, which is really just a recursive function, and if there&#39;s something that dynamic languages are great for that&#39;s recursive functions.</p>
<pre class="highlighted"><code class="php"><span class="keyword">parent</span> = currentPage
<span class="keyword">parent</span> = <span class="keyword">parent</span>.<span class="keyword">Parent</span> until <span class="keyword">parent</span>.nil? || <span class="keyword">parent</span>.Id == target_parent_id</code></pre>
<p>So what we&#39;re doing here is calling the <code>until</code> loop method and assigning the value of <code>parent</code> to <code>parent.Parent</code> until one of the conditions returns true. This is similar to a <code>do {...} while(...)</code> statement in .NET languages, just a bit funkier ;).</p>
<h2>Bringing it all together</h2>
<p>In addition to adding recursive parent lookups we&#39;ve also decided to fix the script so that no navigation HTML is generated if there is no navigation to display. This can be done with a single-line <code>if</code> statement, which looks kind of cool:</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">return</span> <span class="keyword">if</span> (parent &amp;&amp; (parent<span class="variable">.Children</span><span class="variable">.empty</span>? || parent<span class="variable">.Children</span><span class="variable">.any</span>? {|c| c<span class="variable">.GetProperty</span>(<span class="string">"umbracoNaviHide"</span>)<span class="variable">.Value</span> != <span class="string">"1"</span> })) || parent<span class="variable">.nil</span>?</code></pre>
<p>That&#39;ll cause the script to exit if the parent wasn&#39;t found or there aren&#39;t any children to display.</p>
<p>Here&#39;s what the whole script looks like now:</p>
<pre class="highlighted"><code class="xml">Library = Object.const_get("umbraco").const_get("library")

target_parent_id = currentPage.Path.split(',')[2].to_i rescue -1
parent = currentPage
parent = parent.Parent until parent.nil? || parent.Id == target_parent_id

return if (parent &amp;&amp; (parent.Children.empty? || parent.Children.any? {|c| c.GetProperty("umbracoNaviHide").Value != "1" })) || parent.nil?

puts '<span class="tag">&lt;<span class="title">nav</span>&gt;</span><span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"navigation"</span>&gt;</span>'

parent.Children.find_all { |c| c.GetProperty("umbracoNaviHide").Value != "1" }.each_with_index do |child, i|
  puts %Q{
    <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">"#{'first' if i == 0}"</span>&gt;</span>
      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#{Library.NiceUrl(child.Id)}"</span> <span class="attribute">class</span>=<span class="value">"#{'selected' if child.Id == currentPage.Id}"</span> <span class="attribute">target</span>=<span class="value">"_self"</span> <span class="attribute">title</span>=<span class="value">"Go to #{child.Name}"</span>&gt;</span>#{child.Name}<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">li</span>&gt;</span>
  }

end

puts '<span class="tag">&lt;/<span class="title">ul</span>&gt;</span><span class="tag">&lt;/<span class="title">nav</span>&gt;</span>'</code></pre>
<p>Happy Ruby-ing :)</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/umbraco-menu-with-ironruby';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
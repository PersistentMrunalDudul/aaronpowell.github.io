<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Going beyond the browser with QUnit - Part 2 - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Going beyond the browser with QUnit - Part 2</h1>
                <h2>5th September 2011</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/nodejs.html"><span>nodejs</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/qunit.html"><span>qunit</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd July 2013</span>
                            <h3><a href="/posts/2013-07-22-array-like-objects.html">Array-like objects</a></h3>
                        </header>
                        <p>Just because it looks like a duck, walks like a duck, quacks like a duck doesn&#39;t mean it&#39;s a duck. There&#39;s dangers with making assumptions of your JavaScript objects based on their surface area.</p>
<p>That said, a lot of power can be gleamed by these seemingly innocent assumptions.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th July 2013</span>
                            <h3><a href="/posts/2013-07-14-javascript-new-operator.html">The JavaScript new operator</a></h3>
                        </header>
                        <p>Time to revisit something that was overlooked in the last post, the <code>new</code> operator in JavaScript and what it does.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th July 2013</span>
                            <h3><a href="/posts/2013-07-10-implementing-indexers-in-javascript.html">Implementing "indexers" in JavaScript</a></h3>
                        </header>
                        <p>My colleague Luke Drumm challenged me to implement C# style indexers in JavaScript.</p>
<p>So let&#39;s have a look at how you can do that, and how you can make some very interesting JavaScript objects that are self replicating. We&#39;ll build on the knowledge of using <code>bind</code> and <code>apply</code> from the last two posts.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2013</span>
                            <h3><a href="/posts/2013-07-05-javascript-binding-currying-and-arrows.html">JavaScript bind, currying and arrow functions</a></h3>
                        </header>
                        <p>After confusing my colleagues with how to invoke functions with a modifided set of arguments at a single time the next evolutionary point was to confuse them with creating functions that are always called with a different state.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">4th July 2013</span>
                            <h3><a href="/posts/2013-07-04-javascript-call-and-apply.html">JavaScript call and apply</a></h3>
                        </header>
                        <p>After having confused one of my colleagues with some code that used the JavaScript <code>apply</code> method and giving them an answer that didn&#39;t leave them completely bemused I thought I&#39;d share my explanation with the world.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In my <a href="http://www.aaron-powell.com/javascript/qunit-beyond-the-browser-part-1">last post</a> I talked about what you need to do if you want to monitor changes and run tests automatically under Node.js but there was a few assumptions in there. One of the main assumptions I had was that you weren&#39;t doing any DOM interactions.</p>
<p>In this part we&#39;re going to look at how you can use DOM interactions in your QUnit tests and still run them under Node.js.</p>
<h1>Working in a DOM-less JavaScript environment</h1>
<p>One thing that can trip people up when they first come to Node.js is they don&#39;t realise that JavaScript isn&#39;t tied to the browser. In reality JavaScript is just a language that happens to be used predominately in the browser, meaning that the <code>window</code> object isn&#39;t part of the JavaScript specification, it&#39;s just something that&#39;s part of the runtime.</p>
<p>So when you&#39;re running your code under Node.js you can&#39;t just <code>document.getElementById</code> or <code>$(&#39;#foo&#39;)</code>. Uh-oh, how are we going to run tests against the DOM, after all if you want to test a library like Knockout.Unobtrusive you kind of need to be able to do that!</p>
<p>Well don&#39;t fear, the smart people in the Node.js community have solved this problem with a nice little package, <a href="http://search.npmjs.org/#/jsdom">jsdom</a>!</p>
<p>jsdom is essentially an implementation of the DOM in Node.js allowing you do create a <code>document</code> object, a <code>window</code> object and interact with it as though it was in a browser.</p>
<p><em>Note: There are limitations to <code>jsdom</code>, it doesn&#39;t do everything you&#39;d want but it&#39;s a great way to do basic interactions such as we want to do in our tests.</em></p>
<h1>Updating out test runner</h1>
<p>In my previous post I showed you how to set up a basic test runner in your Cakefile. For our tests we&#39;re going to need to add some new stuff into our runtime (Node.js) and to do that we can use the <code>dep</code> option when we set up the runner:</p>
<pre class="highlighted"><code class="ruby">test = 
  <span class="symbol">deps:</span> [<span class="string">"./tests/test-env.js"</span>]
  <span class="symbol">code:</span> <span class="string">"./<span class="subst">#{output}</span>/<span class="subst">#{file}</span>.js"</span>,
  <span class="symbol">tests:</span> <span class="string">"./tests/<span class="subst">#{file}</span>.tests.js"</span></code></pre>
<p>What I&#39;m going to do is create a <code>test-env.js</code> file which will be executed before the tests, allowing me to set up our pesudo-DOM.</p>
<h1>Creating our test environment</h1>
<p>I&#39;m going to set up a few new variables:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> jsdom = <span class="keyword">require</span>(<span class="string">'jsdom'</span>),
    fs = <span class="keyword">require</span>(<span class="string">'fs'</span>),
    dom = fs.readFileSync(<span class="string">"./tests/knockout.unobtrusive.tests.html"</span>).toString(),
    document = jsdom.jsdom(dom, <span class="keyword">null</span>, { features: { QuerySelector: <span class="keyword">true</span> } }),
    window = document.createWindow(),
    navigator = {
      userAgent: <span class="string">'node-js'</span>
    };</code></pre>
<p>First thing I&#39;m doing here is importing <code>jsdom</code> and <code>fs</code>. This will mean I can work with <code>jsdom</code> and the file system.</p>
<p>The next step is to pull in our test HTML page as a string. We&#39;ve got some base HTML which we&#39;ll be interacting with during our tests. This is also the HTML we&#39;d be running in our browser for our browser-based tests because keep in mind we want to share our tests between Node.js and the browser.</p>
<p>Now that we have our DOM as a string we&#39;ll create our <code>document</code> object from it. One other thing we are doing is specifying that we do want <code>querySelector</code> and <code>querySelectorAll</code> available, and this is done with the <code>{ features: { QuerySelector: true } }</code> argument to <code>jsdom</code>.</p>
<p>Lastly we need to create a <code>window</code> object and a <code>navigator</code> object.</p>
<p>So when we have all these local variables we need to make sure that they&#39;ll be available everywhere:</p>
<pre class="highlighted"><code class="avrasm">global<span class="preprocessor">.window</span> = window<span class="comment">;</span>
global<span class="preprocessor">.navigator</span> = navigator<span class="comment">;</span>
global<span class="preprocessor">.document</span> = window<span class="preprocessor">.document</span><span class="comment">;</span></code></pre>
<p>Unlike the browser Node.js&#39;s global object is called <code>global</code>, once we add our variables to that they&#39;ll be available in any of the other files we use in the runner.</p>
<h1>Augmenting our tests</h1>
<p>In the original set of tests that were in the Knockout.Unobtrusive project there was a heavy reliance on jQuery. Now admittedly there is a <a href="http://search.npmjs.org/#/jquery">jQuery npm package</a> but I couldn&#39;t get it running on Node.js 0.4.10 but it&#39;s not really important (I&#39;d prefer not to rely on jQuery in my tests anyway).</p>
<p>So I&#39;m going to do a check for jQuery (our Node.js tests wont have it):</p>
<pre class="highlighted"><code class="haskell"><span class="title">var</span> get, getAll, camalizer, <span class="typedef"><span class="keyword">data</span>,</span>
  <span class="typedef">dataMatcher = /<span class="keyword">data</span>-<span class="container">(.+)</span>/,</span>
  dashAlphaMatcher = /-([a-z])/ig;

<span class="title">if</span>(<span class="typedef">typeof $ !== 'undefined') <span class="container">{
  <span class="title">getAll</span> = <span class="title">get</span> = $;
}</span> else <span class="container">{
  <span class="title">camalizer</span> = <span class="title">function</span>(<span class="title">x</span>, <span class="title">letter</span>) {
    <span class="title">return</span> <span class="title">letter</span>.<span class="title">toUpperCase</span>();
  }</span>;</span>

  <span class="typedef"><span class="keyword">data</span> = function<span class="container">(<span class="title">el</span>)</span> <span class="container">{
    <span class="title">var</span> <span class="title">attribute</span>,
        <span class="title">attributes</span> = <span class="title">el</span>.<span class="title">attributes</span>,
        <span class="title">data</span> = {}</span>;</span>

    for(var i = <span class="number">0</span>, il = attributes.length; i &lt; il; i++) {
      attribute = attributes[i];
      <span class="keyword">if</span>(<span class="typedef">dataMatcher.test<span class="container">(<span class="title">attribute</span>.<span class="title">name</span>)</span>) <span class="container">{
        <span class="title">data</span>[<span class="title">attribute</span>.<span class="title">name</span>.<span class="title">match</span>(<span class="title">dataMatcher</span>)[1].<span class="title">replace</span>(<span class="title">dashAlphaMatcher</span>, <span class="title">camalizer</span>)] = <span class="title">attribute</span>.<span class="title">value</span>;
      }</span></span>
    }

    return function(attr) {
      return <span class="typedef"><span class="keyword">data</span>[attr];</span>
    };
  };

  get = function(id) {
    <span class="keyword">if</span>(id.indexOf('#') === <span class="number">0</span>) {
      id = id.substring(<span class="number">1</span>, id.length);
    }

    var el = document.getElementById(id);

    <span class="keyword">if</span>(!el) {
      el = document.querySelectorAll(id)[<span class="number">0</span>];
    }

    el.<span class="typedef"><span class="keyword">data</span> = <span class="keyword">data</span><span class="container">(<span class="title">el</span>)</span>;</span>
    return el;
  };

  getAll = function(selector) {
    var el,
        elements = document.querySelectorAll(selector);

    <span class="keyword">if</span>(elements[<span class="number">0</span>] &amp;&amp; !elements[<span class="number">0</span>].<span class="typedef">dataset) <span class="container">{
      <span class="title">for</span>(<span class="title">var</span> <span class="title">i</span>=0, <span class="title">il</span>=<span class="title">elements</span>.<span class="title">length</span>; <span class="title">i</span> &lt; <span class="title">il</span>; <span class="title">i</span>++) {
        <span class="title">el</span> = <span class="title">elements</span>[<span class="title">i</span>];
        <span class="title">el</span>.<span class="title">data</span> = <span class="title">data</span>(<span class="title">el</span>);
      }</span></span>
    }

    elements.each = function(fn) {
      var that = this;
      that.forEach(function(value, index) {
        fn.apply(that, [index, value]);
      });
    };

    return elements;
  };</code></pre>
<p>Ok so the obvious first step is to check for jQuery and then we&#39;re deferring everything to that, but instead of just exposing <code>$</code> I&#39;m going to expose two methods, <code>get</code> and <code>getAll</code>. The former will be useful for getting a single element, the latter for multiple elements.</p>
<p>Next I&#39;m creating two helper methods, the first being a camel case method (handy for working with <code>data-*</code> and the second simulating the <code>.data</code> API which you get from jQuery itself.</p>
<p><em>Note: The data method isn&#39;t exactly the same as using the $.data API, but I&#39;m only replicating what I need at the current time.</em></p>
<p>In our simulated data API it will iterate through all the attributes and find any <code>data-*</code> ones (using a regex to look for them) then turning them into camel cased strings (like the spec, so <code>data-foo-bar</code> becomes <code>fooBar</code>). It&#39;s probably a bit more complicated than it needs to be but it works nicely as I want.</p>
<p>The only other interesting point of note is that the <code>getAll</code> method will also simulate the <code>.each</code> API from jQuery so that we can use those loops in our tests.</p>
<p>And there you go you&#39;re essentially done. Once you replace all your usages of jQuery in your tests for the <code>get</code> and <code>getAll</code> API then you&#39;ll be ready to roll!</p>
<h1>Be careful with DOM manipulations</h1>
<p>Something that I got tripped up with when porting the Knockout.Unobtrusive tests was that you don&#39;t want your DOM manipulations to persist across the tests.</p>
<p>If you&#39;ve done work with QUnit you&#39;ll know that if you a DOM element with an <code>id</code> of <code>qunit-fixture</code> then it&#39;ll get rebuilt after every single test.</p>
<p>Well there&#39;s a problem, the Node.js implementation of QUnit isn&#39;t designed to work with the DOM so naturally this doesn&#39;t work. But it&#39;s an easy one to get around, QUnit exposes a method called <code>reset</code> that you can use to force a reset of the <code>qunit-fixture</code> element. Since the Node.js one doesn&#39;t worry about the DOM it doesn&#39;t have this method.</p>
<p>To implement this ourselves we&#39;ll create a <code>module</code> for our test that we can have a <code>teardown</code> method on the end of it:</p>
<pre class="highlighted"><code class="coffeescript">QUnit.module(<span class="string">'createBindings'</span>, {
  teardown: <span class="reserved">function</span>() {
    <span class="keyword">if</span>(!QUnit.reset) {
      <span class="regexp">//</span><span class="keyword">do</span> the reset
    }
  }
});</code></pre>
<p><em>Note: you need to either access <code>module</code> via <code>QUnit.module</code> or assign that to <code>module</code> yourself because <code>module</code> is a reserved word in Node.js.</em></p>
<p>For the reset method I&#39;ve created a helper function back in the <code>test-env.js</code> file:</p>
<pre class="highlighted"><code class="avrasm">global<span class="preprocessor">.rebuildDom</span> = function() {
  global<span class="preprocessor">.document</span> = jsdom<span class="preprocessor">.jsdom</span>(dom, null, { features: { QuerySelector: true } })<span class="comment">;</span>
  global<span class="preprocessor">.window</span> = global<span class="preprocessor">.document</span><span class="preprocessor">.createWindow</span>()<span class="comment">;</span>
}<span class="comment">;</span></code></pre>
<p>This will rebuild both the <code>document</code> and <code>window</code> objects from the original DOM string. So we can update our module like so:</p>
<pre class="highlighted"><code class="erlang"><span class="variable">QUnit</span>.module('create<span class="variable">Bindings</span>', <span class="tuple">{
  teardown: <span class="keyword">fun</span><span class="function_name">ction</span>() <span class="tuple">{
    if(!<span class="variable">QUnit</span>.reset) <span class="tuple">{
      <span class="function_name">rebuildDom</span>();
    }</span>
  }
});</code></pre>
<h1>Conclusion</h1>
<p>I&#39;m aware that this has been a bit of a long and complicated post but hopefully it gives you some starting points for how you could approach doing online &amp; offline JavaScript tests.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/javascript/qunit-beyond-the-browser-part-2';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
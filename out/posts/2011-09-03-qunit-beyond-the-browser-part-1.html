<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Going beyond the browser with QUnit - Part 1 - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Going beyond the browser with QUnit - Part 1</h1>
                <h2>3rd September 2011</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/nodejs.html"><span>nodejs</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/qunit.html"><span>qunit</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">2nd July 2011</span>
                            <h3><a href="/posts/2011-07-02-postman.html">Introducing Postman - A JavaScript Messaging Library</a></h3>
                        </header>
                        <h1>Prelude</h1>
<p>Back in May I presented at DDD Melbourne on JavaScript design patterns. One of the patterns that I was talking about was the idea of [pub/ sub][1].</p>
<p>Let me start by saying that this isn&#39;...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/postman.html"><span>postman</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/coffeescript.html"><span>coffeescript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">7th January 2013</span>
                            <h3><a href="/posts/2013-01-07-thoughts-on-typescript.html">Thoughts on TypeScript</a></h3>
                        </header>
                        <p>Some of my impressions from trying to implement something in TypeScript</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">2nd October 2012</span>
                            <h3><a href="/posts/2012-10-02-pubsub-in-typescript.html">PubSub in TypeScript</a></h3>
                        </header>
                        <p>It&#39;s that time again, time for more Pub/Sub!</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th September 2012</span>
                            <h3><a href="/posts/2012-09-14-creating-classes.html">Creating classes in WinJS</a></h3>
                        </header>
                        <p>A look at how you can create JavaScript classes in WinJS</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/winjs.html"><span>winjs</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/windows8.html"><span>windows8</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>When it comes to unit testing my JavaScript my preferred framework is <a href="http://docs.jquery.com/Qunit">QUnit</a>. If you&#39;re not familiar with QUnit it&#39;s the test framework for <a href="http://jquery.com">jQuery</a> so I think it&#39;s reasonably well up to the task of testing JavaScript.</p>
<p>Recently I wrote an article on a <a href="http://www.aaron-powell.com/javascript/knockoutjs-preparser">preparser I&#39;ve written for Knockout</a>. Interestingly enough at the same time Brendan Satrom had <a href="http://bsatrom.github.com/Knockout.Unobtrusive/">the same idea</a>. I quite like the approach that Brendan has taken so I decided to have a poke around in the code and see if we could even merge the two projects.</p>
<p>The first thing I noticed when looking into the code was that it was written using <a href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a>. The second thing I noticed was that the tests were all written using QUnit and were to be run in the browser. But there was a bit of a nuisance, the tests were against the compiles JavaScript, not the raw CoffeeScript (it was running against the generated file), to do any modifications, and test them, you have to copy the CoffeeScript to the online compiler, the back to the compiled file and then run the tests.</p>
<p>I&#39;m sure you can see where the problems can come into this solution.</p>
<p>Well I&#39;ve done a few small projects using CoffeeScript in the past and I&#39;ve also included some tests into it so I decided at having a crack at getting this to work.</p>
<h1>Getting your tools together</h1>
<p>So to get started I&#39;m using Windows and I&#39;m going to be using Node.js to do the browser-less coding. Although I&#39;m aware there is a version of Node.js for Windows I&#39;m still using a self-compiled version with cygwin because <a href="http://npmjs.org">npm</a> works fine under cygwin but not with the Windows compiled version.</p>
<p>Additionally I&#39;m going to be using a few npm packages:</p>
<ul>
<li><a href="http://search.npmjs.org/#/coffee-script">CoffeeScript</a></li>
<li><a href="http://search.npmjs.org/#/qunit">QUnit</a></li>
<li><a href="http://search.npmjs.org/#/colors">Colors</a></li>
</ul>
<h1>Getting started by watching cake</h1>
<p>If you&#39;ve done much work with CoffeeScript you&#39;ll probably have come across the concept of a <a href="http://jashkenas.github.com/coffee-script/#cake">Cakefile</a>, if you haven&#39;t, a Cakefile is a CoffeeScript version of a <a href="http://rake.rubyforge.org/files/doc/rakefile_rdoc.html">Rakefile</a> (or MSBuild is a similar concept if you&#39;re coming from .NET just a lot more horrible), so I&#39;m going to start off by using Cake to create a file system watcher.</p>
<p>The basic idea if I want to have a Cake task which will monitor for changes on the file system (specifically our CoffeeScript file) and when a change happens we&#39;ll compile it to JavaScript and run our tests.</p>
<p>First off I&#39;ll define some constants in our Cakefile:</p>
<pre class="highlighted"><code class="ini"><span class="setting">fs = <span class="value">require 'fs'</span></span>
<span class="setting">path = <span class="value">require 'path'</span></span>
<span class="setting">CoffeeScript = <span class="value">require 'coffee-script'</span></span>
<span class="setting">file = <span class="value">'knockout.unobtrusive'</span></span>
<span class="setting">source = <span class="value">'coffee'</span></span>
<span class="setting">output = <span class="value">'js'</span></span></code></pre>
<p>Next it&#39;s time to setup our <code>watch</code> task:</p>
<pre class="highlighted"><code class="vbscript">task <span class="comment">'watch', 'Watch prod source files and build changes', -&gt;</span>
    msg = <span class="string">"Watching for changes in #{source}"</span>
    console.<span class="built_in">log</span> msg

    fs.watchFile <span class="string">"#{source}/#{file}.coffee"</span>, (curr, prev) -&gt;
        <span class="keyword">if</span> +curr.mtime isnt +prev.mtime
            console.<span class="built_in">log</span> <span class="string">"Saw change in #{source}/#{file}.coffee"</span>
            try
              invoke <span class="comment">'build'</span>
              console.<span class="built_in">log</span> <span class="comment">'build complete'</span>
              invoke <span class="comment">'tests'</span>
            catch e
              msg = <span class="comment">'Error with CoffeeScript build'</span>
              console.<span class="built_in">log</span> msg
              console.<span class="built_in">log</span> e</code></pre>
<p>We&#39;re using the standard <code>watchFile</code> method in Node and in the callback we&#39;ll ensure that the change times aren&#39;t equal (double-checking for false positives) and if there&#39;s a valid change we want to execute the following two tasks:</p>
<ul>
<li><code>build</code></li>
<li><code>tests</code></li>
</ul>
<p>Additionally we&#39;re wrapping this in a <code>try/ catch</code> so that if it fails we can provide a useful message but have the watcher keep running (say if you save while you&#39;re half-way through a change you wont get a major failure or anything).</p>
<p>Now let&#39;s have a look at the <code>build</code> task. This task will allow us to compile our coffee file into JavaScript. This is just going to be a standard Cake task as well so you can use it elsewhere if you want:</p>
<pre class="highlighted"><code class="ruby">task <span class="string">'build'</span>, <span class="string">"builds <span class="subst">#{file}</span>"</span>, -&gt;
    console.log <span class="string">"building <span class="subst">#{file}</span> from coffeescript"</span>
    code = fs.readFileSync <span class="string">"<span class="subst">#{source}</span>/<span class="subst">#{file}</span>.coffee"</span>, <span class="string">'utf8'</span>
    fs.writeFile <span class="string">"<span class="subst">#{output}</span>/<span class="subst">#{file}</span>.js"</span>, <span class="constant">CoffeeScript</span>.compile code</code></pre>
<p>Since Node (well JavaScript) is a callback-based programming model generally speaking you&#39;ll be doing asynchronous operations, even with the file system. Node has provided some changes though to allow for <em>synchronous</em> programming. In this case I&#39;m going to be using the synchronous read operation. The main reason for this is so that I don&#39;t have to pass around a callback which will then do the tests (this could get messy in the Cakefile).</p>
<p>Once the read operation is completed we pipe the output into the CofeeScript compiler API (which we can call from CoffeeScript/ JavaScript) and write the output of that into a JavaScript file.</p>
<p>When the <code>build</code> task is done the next step in our watcher is to call out to our test runner. As mentioned above I wanted to reuse the QUnit tests that already shipped in source of Knockout.Unobtrusive I plan to use the Node.js implementation of QUnit. It&#39;s rather simple and again we&#39;ll create a Cake task:</p>
<pre class="highlighted"><code class="vhdl">task <span class="attribute">'tests</span>', <span class="string">"run tests for #{file}"</span>, -&gt;
    console.log <span class="attribute">'Time</span> <span class="keyword">for</span> some tests! '
    runner = require <span class="attribute">'qunit</span>'
    sys = require <span class="attribute">'sys</span>'
    colors = require <span class="attribute">'colors</span>'
    test = 
      code: <span class="string">"./#{output}/#{file}.js"</span>,
      tests: <span class="string">"./tests/#{file}.tests.js"</span>

    runner.options.summary = false

    <span class="keyword">report</span> = (r) -&gt;
      <span class="keyword">if</span> r.errors
        msg = <span class="string">"Uh oh, there were errors"</span>
        sys.puts msg.bold.red
      <span class="keyword">else</span>
        msg = <span class="attribute">'All</span> test pass'
        sys.puts msg.green

    runner.run test, <span class="keyword">report</span></code></pre>
<p>So a few things of note:</p>
<ul>
<li>We&#39;re using the runner which comes with QUnit for Node.js</li>
<li>We&#39;re creating an object with our tests info which includes:<ul>
<li>The file under test</li>
<li>The tests to execute</li>
</ul>
</li>
<li>I&#39;m suppressing the summary (we execute the tests a lot so there&#39;s no need to see it)</li>
<li>Lastly there&#39;s a callback for when the runner finishes which will either dump a message on success or failure (with a pretty colour!)</li>
</ul>
<p>From the point of view of the Cakefile that&#39;s really all we have a need for, we&#39;ve got our watcher up and running and we can just kick it off:</p>
<pre class="highlighted"><code class="nginx"><span class="title">cake</span> watch</code></pre>
<p>Now whenever we edit our CoffeeScript file it&#39;ll go nicely.</p>
<h1>Wrapping up</h1>
<p>So this wraps up the first part of migrating our tests out of the browser to make a more automated series of JavaScript tests.</p>
<p>Next time we&#39;ll look at how to deal with some of the limitations of working in a DOM-less environment.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/javascript/qunit-beyond-the-browser-part-1';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
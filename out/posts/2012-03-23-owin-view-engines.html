<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>OWIN and View Engines - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">OWIN and View Engines</h1>
                <h2>23rd March 2012</h2>
                <ul class="tags">
    
        
            <li><a class="icon icon-tag" href="/tagged/owin.html"><span>owin</span></a></li>
        
            <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
        
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">12th January 2014</span>
                            <h3><a href="/posts/2014-01-12-integration-testing-katana-with-auth.html">Integration testing authenticated Katana applications</a></h3>
                        </header>
                        <p>A look at how you can write integration tests with the new ASP.Net Katana project web applications when they are behind an authentication layer.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/owin.html"><span>owin</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/katana.html"><span>katana</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/testing.html"><span>testing</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th January 2013</span>
                            <h3><a href="/posts/2013-01-14-ie10-console-thoughts.html">Making the Internet Explorer JavaScript tools better, again</a></h3>
                        </header>
                        <p>A look at what&#39;s changed since I last pointed out the failings of the IE dev tools</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web-dev.html"><span>web-dev</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">18th October 2012</span>
                            <h3><a href="/posts/2012-10-18-dbjs-chrome.html">Chrome support for db.js</a></h3>
                        </header>
                        <p>A little word on the db.js support for Chrome</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/chrome.html"><span>chrome</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In the <a href="http://www.aaron-powell.com/web/owin-responses">last post</a> we looked at improving our responses in OWIN by adding some extensions methods to the response object and the next logical step for this is to think about HTML. While what we&#39;ve brought together thus far is useful if you&#39;re creating something that is just a web API if  you want to create an actual web site you probably need to respond with some HTML.</p>
<p>To this end we&#39;re going to need to think about creating a <em>View Engine</em> that will be responsible for our HTML generation. The reason I want to go down this path is it makes it nicer if we want to add some level of dynamic data to the HTML we&#39;re serving, say insert a user name or other things like that.</p>
<h1 id="picking-our-language">Picking our language</h1>
<p>HTML isn&#39;t a language that has dynamic features to it so we need to look at a templating language to leverage for this. If you look around there&#39;s plenty of different HTML templating languages like HAML, Spark, Jade or even Razor.</p>
<p>Since I want to make it something easy to understand for the .NET developer I&#39;m going to use Razor as my templating language, and I&#39;m going to use the <a href="http://razorengine.codeplex.com/">RazorEngine</a> project to help me out (it saves me writing all the bootstrapping code).</p>
<h1 id="approaching-the-view-engine">Approaching the View Engine</h1>
<p>So we&#39;re going to use Razor but <em>how</em> are we going to use it? We need some way to &quot;create&quot; our View Engine and then we will want to interact with it.</p>
<p>Since the View Engine could be a little bit complex I&#39;m going to create a class which will represent the engine. This will also mean that I can do some caching within the View Engine to ensure optimal performance.</p>
<p>With that in mind how are we going to interact with the View Engine? We obviously don&#39;t want to spin it up every single time, instead I want it to always be available. So this means that I&#39;m going to have a static that lives <em>somewhere</em> which I&#39;ll want to interact with.</p>
<p>Finally how will we get that View Engine instance? Do we have it magically created or do we want it lazy-loaded?</p>
<p>These are all things to be considered but my approach is going to be:</p>
<ul>
<li>Use a singleton for the View Engine</li>
<li>Have a <code>ViewEngineActivator</code> which we access it through</li>
<li>The user must explicitly register the <code>ViewEngine</code> they want to use in code</li>
</ul>
<h2 id="coding-the-view-engine">Coding the View Engine</h2>
<p>Thinking about the View Engine there&#39;s not a lot that the class would have to publicly expose, in fact I really think you only want two methods, one that takes a view name, one which takes a view name and a model.</p>
<p>So the View Engine will look something like this:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">class</span> RazorViewEngine
{
    <span class="keyword">public</span> <span class="keyword">string</span> Parse(<span class="keyword">string</span> viewName)
    {
        <span class="keyword">return</span> Parse&lt;<span class="keyword">object</span>&gt;(viewName, <span class="keyword">null</span>);
    }

    <span class="keyword">public</span> <span class="keyword">string</span> Parse&lt;T&gt;(<span class="keyword">string</span> viewName, T model)
    {
        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
    }
}</code></pre>
<p>Cool that&#39;s not very complex, let&#39;s start on the activator:</p>
<pre class="highlighted"><code class="actionscript"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewEngineActivator</span>
{</span>
    <span class="keyword">public</span> <span class="keyword">static</span> RazorViewEngine ViewEngine { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}</code></pre>
<p>And now we&#39;ll make it possible to register a View Engine:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">static</span> IAppBuilder UseViewEngine&lt;TViewEngine&gt;(<span class="keyword">this</span> IAppBuilder builder)
    <span class="keyword">where</span> TViewEngine: RazorViewEngine, <span class="keyword">new</span>()
{
    ViewEngineActivator.ViewEngine = <span class="keyword">new</span> TViewEngine();
}

<span class="comment">/* snip */</span>
builder.UseViewEngine&lt;RazorViewEngine&gt;();</code></pre>
<p>Now  that the infrastructure code is all there we need to think about how we would go about reading in the views and turning them into something we can send down as a response. In our View Engine we&#39;re going to need to know where to find the views. I like conventions so I&#39;m going to expect them to be in the <code>views</code> folder at the application root. But I&#39;m a nice guy so I think it should be possible to put the views into another folder if you desire so I&#39;ll add some constructors like so:</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">public</span> RazorViewEngine()
    : <span class="keyword">this</span>(<span class="string">"views"</span>, <span class="string">"_layout"</span>)
{
}

<span class="keyword">public</span> RazorViewEngine(string viewFolder, string layoutViewName)
{
    ViewFolder = Path<span class="variable">.Combine</span>(AppDomain<span class="variable">.CurrentDomain</span><span class="variable">.BaseDirectory</span>, viewFolder);
    LayoutViewName = layoutViewName;

    <span class="keyword">if</span> (!Directory<span class="variable">.Exists</span>(ViewFolder))
        <span class="keyword">throw</span> new DirectoryNotFoundException(<span class="string">"The view folder specified cannot be located.\r\nThe folder should be in the root of your application which was resolved as "</span> + AppDomain<span class="variable">.CurrentDomain</span><span class="variable">.BaseDirectory</span>);
}</code></pre>
<p>I&#39;m also going to check to make sure that the views folder <em>does</em> exist. I&#39;m also wanting support a &quot;layout&quot; view so that you can do reusable HTML; it just makes sense.</p>
<p>Since you&#39;re now able to specify the Views folder I&#39;ll add another extension method so you can provide that instead of using the default way:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">static</span> IAppBuilder UseViewEngine&lt;TViewEngine&gt;(<span class="keyword">this</span> IAppBuilder builder, TViewEngine viewEngine)
    <span class="keyword">where</span> TViewEngine: RazorViewEngine
{
    ViewEngineActivator.ViewEngine = viewEngine;
}</code></pre>
<p>This also means that you could super-class the <code>RazorViewEngine</code> if you want and provide additional functionality.</p>
<p>Next up we&#39;ll start implementing our <code>Parse&lt;T&gt;</code> method. </p>
<pre class="highlighted"><code class="avrasm">public string Parse&lt;T&gt;(string viewName, T model)
{
    viewName = viewName<span class="preprocessor">.ToLower</span>()<span class="comment">;</span>

    if (!viewCache<span class="preprocessor">.ContainsKey</span>(viewName))
    {
        var layout = FindView(LayoutViewName)<span class="comment">;</span>
        var view = FindView(viewName)<span class="comment">;</span>

        if (!view<span class="preprocessor">.Exists</span>)
            throw new FileNotFoundException(<span class="string">"No view with the name '"</span> + view + <span class="string">"' was found in the views folder ("</span> + ViewFolder + <span class="string">").\r\nEnsure that you have a file with that name and an extension of either cshtml or vbhtml"</span>)<span class="comment">;</span>

        var content = File<span class="preprocessor">.ReadAllText</span>(view<span class="preprocessor">.FullName</span>)<span class="comment">;</span>

        if (layout<span class="preprocessor">.Exists</span>)
            content = File<span class="preprocessor">.ReadAllText</span>(layout<span class="preprocessor">.FullName</span>)<span class="preprocessor">.Replace</span>(<span class="string">"@Body"</span>, content)<span class="comment">;</span>

        viewCache[viewName] = content<span class="comment">;</span>
    }

    return Razor<span class="preprocessor">.Parse</span>(viewCache[viewName], model)<span class="comment">;</span>
}</code></pre>
<p>What you&#39;ll see here is I&#39;m creating a cache of views that get discovered for performance so it&#39;s all shoved into a static dictionary that I&#39;ve got*. Assuming that this is the first time we&#39;ll look for the layout view and current view, raise an error if the view isn&#39;t found, and then combine them all together.</p>
<p><em>*This is pretty hacky code and doesn&#39;t take concurrency into account; make sure you do double-lock checking!</em></p>
<p>One convention I&#39;m adding myself is that the &quot;body&quot; (aka, the current view) will be rendered where ever you place an <code>@Body</code> directive. This is because we&#39;re using Razor <em>the language</em> which is slightly different to MVC&#39;s Razor. The language doesn&#39;t include the <code>RenderBody</code> method, that&#39;s specific for the implementation. When creating your own view engine though you&#39;re at liberty to do this how ever you want. You could alternatively create your own base class that handles the body better, me, I&#39;m lazy and want a quick demo.</p>
<p>I finish off caching the generated template so that next time we can skip a bunch of the lookup steps and then get RazorEngine to parse the template and send back the HTML*.</p>
<p><em>*I&#39;m not sure if this is the best way to do it with RazorEngine, I think you can do it better for caching but meh. Also, you don&#39;t have to return HTML, you could use this engine to output any angled-bracket content.</em></p>
<h1 id="using-our-view-engine">Using our View Engine</h1>
<p>Now that we have our View Engine written we need to work out how we&#39;ll actually use it. Like we did in the last post I&#39;m going to use extension methods on the Response object to provide the functionality:</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> View(<span class="keyword">this</span> Response res, string view)
{
    var output = ViewEngineActivator<span class="variable">.ViewEngine</span><span class="variable">.Parse</span>(view);

    res<span class="variable">.ContentType</span> = <span class="string">"text/html"</span>;
    res<span class="variable">.Status</span> = <span class="string">"200 OK"</span>;
    res<span class="variable">.End</span>(output);
}

<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> View&lt;T&gt;(<span class="keyword">this</span> Response res, string view, T model)
{
    var output = ViewEngineActivator<span class="variable">.ViewEngine</span><span class="variable">.Parse</span>(view, model);

    res<span class="variable">.ContentType</span> = <span class="string">"text/html"</span>;
    res<span class="variable">.Status</span> = <span class="string">"200 OK"</span>;
    res<span class="variable">.End</span>(output);
}</code></pre>
<p>This is pretty simple, we&#39;re really just acting as a bridge between the response and the view engine. Sure I&#39;m also making the assumption that it&#39;s <code>text/html</code> that we&#39;re returning despite saying above we can do any angled-bracket response, changing that can be your exercise dear reader.</p>
<h1 id="bringing-it-all-together">Bringing it all together</h1>
<p>So we&#39;ve got everything written let&#39;s start using it:</p>
<pre class="highlighted"><code class="avrasm">builder
    <span class="preprocessor">.UseViewEngine</span>&lt;RazorViewEngine&gt;()
    <span class="preprocessor">.Get</span>(<span class="string">"/razor/basic"</span>, (req, res) =&gt;
    {
        res<span class="preprocessor">.View</span>(<span class="string">"Basic"</span>)<span class="comment">;</span>
    })<span class="comment">;</span></code></pre>
<p>Pretty simple to use our View Engine now isn&#39;t it!</p>
<h1 id="conclusion">Conclusion</h1>
<p>In this post we&#39;ve had a look at what it&#39;d take to produce a basic View Engine on top of OWIN, building on top of the knowledge and concepts of the last few posts.</p>
<p>In the next post I&#39;m going to take the idea of a View Engine one step further and give the user a lot more power.</p>
<p>As always you can check out the full code up on the <a href="https://github.com/aaronpowell/Owin.HelloWorld">GitHub repository</a>.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/web/owin-view-engines';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Xamlizer - How to implement something silly in JavaScript - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Xamlizer - How to implement something silly in JavaScript</h1>
                <h2>24th October 2011</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/doing-it-wrong.html"><span>doing-it-wrong</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2013</span>
                            <h3><a href="/posts/2013-07-05-javascript-binding-currying-and-arrows.html">JavaScript bind, currying and arrow functions</a></h3>
                        </header>
                        <p>After confusing my colleagues with how to invoke functions with a modifided set of arguments at a single time the next evolutionary point was to confuse them with creating functions that are always called with a different state.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">4th July 2013</span>
                            <h3><a href="/posts/2013-07-04-javascript-call-and-apply.html">JavaScript call and apply</a></h3>
                        </header>
                        <p>After having confused one of my colleagues with some code that used the JavaScript <code>apply</code> method and giving them an answer that didn&#39;t leave them completely bemused I thought I&#39;d share my explanation with the world.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">21st June 2013</span>
                            <h3><a href="/posts/2013-06-21-walking-a-javascript-object.html">Walking a JavaScript object</a></h3>
                        </header>
                        <p>Ever had a path to a path to a property on a JavaScript object that you want to walk? Something along the lines of <code>foo.bar.baz</code>.</p>
<p>Recently I was trying to solve this problem and came across a nifty little trick</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th January 2013</span>
                            <h3><a href="/posts/2013-01-14-ie10-console-thoughts.html">Making the Internet Explorer JavaScript tools better, again</a></h3>
                        </header>
                        <p>A look at what&#39;s changed since I last pointed out the failings of the IE dev tools</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web-dev.html"><span>web-dev</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>I&#39;ve never done much Xaml development, I started reading a WPF book and played around with it only to realise I didn&#39;t have any understanding of this concept of a stateful application or how layouts were going to work. And as a web developer who never saw the appeal of Flash I also never got into Silverlight as there was never a problem in my life that it would solve.</p>
<p>The one thing I do remember from my brief foray into that scary other world is the reliance on <code>INotifyPropertyChanged</code> and <code>INotifyPropertyChanging</code> interfaces. I&#39;ve always thought that the idea behind these two interfaces was a good one, the primary problem though is how you actually have to implement them. Seriously, there&#39;s a lot of shit code you have to implement.</p>
<p>So I decided to do something a bit silly, I decided to implement the two interfaces in JavaScript.</p>
<h3>A dumb idea with a point</h3>
<p>Now I see no real reason to use the code that I&#39;m going to look at in any current development (I&#39;ll explain why later) but more importantly I want to look at something that is part of ECMAScript 5 that doesn&#39;t get the attention it deserves, <a href="http://es5.github.com/#x15.2.3.6"><code>Object.defineProperty</code></a>.</p>
<h1>JavaScript properties throughout history</h1>
<p>JavaScript, unlike languages such as C#, doesn&#39;t really have this concept of a property like you get there, the idea of a <em>get</em> and <em>set</em> operating being something that you can control. Really this is how a <em>class</em> in JavaScript with some public properties looks:</p>
<pre class="highlighted"><code class="smalltalk">var person = {
    <span class="method">firstName:</span> <span class="string">'Aaron'</span>,
    <span class="method">lastName:</span> <span class="string">'Powell'</span>
};</code></pre>
<p>And when we want to update a property we&#39;d do something like this:</p>
<pre class="highlighted"><code class="profile"><span class="filename">person.firstName = 'John';</code></pre>
<p>Now there&#39;s nothing wrong with this, it does what you&#39;ll want to do <em>in a lot of scenarios</em>, the problem is when you&#39;re wanting a slightly more complex scenario, say you want to react to a change to the <code>firstName</code> property, maybe perform some validation.</p>
<p>Let&#39;s assume we want to have an <code>age</code> property on our <code>person</code>. Obviously we want to make sure that <code>age</code> is at least 0 and probably less than 110 (sounds reasonable :P), well how do you do this?</p>
<ul>
<li>Validation before assigning the property?<ul>
<li>That&#39;ll work, but what if we&#39;re exposing it to external API&#39;s? How can we enforce the validation to them?</li>
</ul>
</li>
</ul>
<h3>Functions as properties</h3>
<p>The general way which this problem is solved is to rather than use assignable properties you use functions as properties, making your code look like this:</p>
<pre class="highlighted"><code class="scala"><span class="keyword">var</span> person = (function() {
    <span class="keyword">var</span> _age;

    <span class="keyword">return</span> {
        <span class="comment">//firstName, lastName, etc</span>
        age: function(<span class="keyword">val</span>) {
              <span class="keyword">if</span>(<span class="keyword">val</span> !== undefined &amp;&amp; (<span class="keyword">val</span> &gt;= <span class="number">0</span> &amp;&amp; <span class="keyword">val</span> &lt;= <span class="number">100</span>) {
                _age = <span class="keyword">val</span>;
              } <span class="keyword">else</span> {
                <span class="comment">//Raise an error</span>
              }
              <span class="keyword">return</span> _age;
        }
    }
})();</code></pre>
<p>Now we use the <code>age</code> property like so:</p>
<pre class="highlighted"><code class="avrasm">person<span class="preprocessor">.age</span>(<span class="number">27</span>)<span class="comment">;</span>
console<span class="preprocessor">.log</span>(person<span class="preprocessor">.age</span>())<span class="comment">; //outputs 27</span></code></pre>
<p>Now this isn&#39;t really <em>that</em> bad, the main pain point to it is that we now have a different way to assign the value, we do it through a function invocation rather than through an assignment statement. This can come to light if you&#39;re writing a JavaScript templating engine, you need to check if the <em>property</em> is actually a property or a function property. But we do get some nice stuff like the fact that in JavaScript you don&#39;t need to do overloads so we can have the one function perform both the <code>get</code> and <code>set</code> operation for our property.</p>
<p>Libraries such as <a href="http://knockoutjs.com">KnockoutJS</a> use this pattern for properties to do their UI binding but it can cause confusion, like in KnockoutJS if you want to bind to a property you&#39;d do something like this: <code>data-bind=&quot;css: { someClass: someBoolean }&quot;</code> which Knockout will understand it&#39;s an observable property and bind to the result of the function, but if you want to use the <strong>false</strong> value you need to do <code>data-bind=&quot;css: { someClass: !someBoolean() }&quot;</code>. Note that this time it&#39;s <strong>invoked the property as a function</strong> rather than just using the property.</p>
<p>The can be a bit confusing and I&#39;ve seen more than one developer (including myself) getting stumped as to why their bindings weren&#39;t working only to realise that it&#39;d because they are binding to <code>!someBoolean</code> which equates to <code>!function() { }</code> rather than the <strong>result</strong> of the function. It&#39;s a very face-palm moment.</p>
<h1>Introducing ES5 properties</h1>
<p>As part of the ECMAScript 5 spec the concept of properties was addresses and has resulted in the <code>Object.defineProperty</code> API (and an API to define multiple at once, being <code>Object.defineProperties</code>) and this allows us to (among other things) define <code>get</code> and <code>set</code> method bodies for our properties.</p>
<p>Let&#39;s revisit our <code>person.age</code> property example from above, but do it using an ECMAScript 5 property:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">var</span> person = (function() {
    <span class="keyword">var</span> _age;

    <span class="keyword">var</span> newPerson = { 
        firstName: <span class="string">'Aaron'</span>,
        lastName: <span class="string">'Powell'</span>
    };

    Object.defineProperty(newPerson, <span class="string">'age'</span>, {
        <span class="keyword">get</span>: function() { <span class="keyword">return</span> _age; },
        <span class="keyword">set</span>: function(<span class="keyword">value</span>) {
            <span class="keyword">if</span>(<span class="keyword">value</span> &amp;&amp; <span class="keyword">value</span> &gt;= <span class="number">0</span> &amp;&amp; <span class="keyword">value</span> &lt;= <span class="number">110</span>) {
                _age = <span class="keyword">value</span>
            } <span class="keyword">else</span> {
                <span class="comment">//raise error</span>
            }
        }
    });

    <span class="keyword">return</span> newPerson;
})();
person.age = <span class="number">27</span>;
console.log(person.age);</code></pre>
<p>Hopefully you can see here the difference between the <em>function property</em> and the ES5 property.</p>
<p>With ES5 the property with a function body <em>looks just like a public field</em>. Now there&#39;s a few other things you can do here, such as make properties read-only and exclude them from <code>for...in</code> loops, and for that check out the <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object/defineProperty">MDN</a> (you can also do body-less properties), but it makes it very easy to build smarts into your objects. Also like .NET if you want to provide a <code>get</code>/<code>set</code> you need to have a backing store, but that&#39;s easy to get around with closure scope.</p>
<p>So that covers a basic look ES5 properties. Now back to our bad idea...</p>
<h1>Implementing INotifyPropertyChange in JavaScript</h1>
<p>As I demonstrated above it is possible to add a body to your properties let&#39;s do something with that idea.</p>
<p>If you&#39;re not familiar with <code>INotifyPropertyChang*</code> then you should read the <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.inotifypropertychanged.aspx">MSDN</a> <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.inotifypropertychanging.aspx">docs</a>. The <strong>TL;DR</strong> is that you use trigger the <code>Changing</code> event before you assign the property and then the <code>Changed</code> event after it&#39;s assigned and the UI can react.</p>
<p>As I said I think there&#39;s a lot of value in this pattern, it&#39;s just that as most Xaml devs will tell you implementing it is a real pain in the ass.</p>
<p>So say you wanted to implement it in JavaScript, it&#39;s not overly hard, ultimately we need to do something like this:</p>
<pre class="highlighted"><code class="applescript">Object.defineProperty(foo, '<span class="keyword">prop</span>', {
    <span class="keyword">get</span>: function() { <span class="constant">return</span> _<span class="keyword">prop</span>; },
    <span class="keyword">set</span>: function(val) {
        propertyChanging(this, '<span class="keyword">prop</span>');
        _<span class="keyword">prop</span> = val;
        propertyChanged(this, '<span class="keyword">prop</span>');    
    }
});</code></pre>
<p>I&#39;ve ignored the guff code like what the <code>propertyChang*</code> methods are doing as well as subscribing handlers to the events but you get the idea. This really don&#39;t look any different to the C# version though does it? So what&#39;s the point?</p>
<h2>Making it better through the magic of JavaScript</h2>
<p>As you can see there&#39;s a lot of boilerplate code that you need to get this working. In .NET there&#39;s no real way to avoid this (unless you do some magic under the covers). But one of the cool things about JavaScript being a dynamic language is that we can modify an object pretty damn easily. Let&#39;s go back to our <code>person</code> object:</p>
<pre class="highlighted"><code class="smalltalk">var person = {
    <span class="method">firstName:</span> <span class="string">'Aaron'</span>,
    <span class="method">lastName:</span> <span class="string">'Powell'</span>,
    <span class="method">age:</span> <span class="number">27</span>
};</code></pre>
<p>Now imagine that I want to implement my JavaScript version of <code>INotifyPropertyChang*</code> on it so that my UI can react whenever I update the values, but I don&#39;t want to be going through and writing this all out myself, I&#39;ve got a bunch of objects that I want to <em>promote</em> to implementing the interfaces.</p>
<p>Well since JavaScript doesn&#39;t actually have interfaces in the language it&#39;s a bit tricky, and this is where my funky little script comes in.</p>
<p><strong>Hello Xamlizer!</strong></p>
<p>So I&#39;ve created a little JavaScript code snippet which I&#39;ve called <strong><a href="https://gist.github.com/1318702">Xamlizer</a></strong> that&#39;ll take an object and implement <code>INotifyPropertyChang*</code> on it. Now the script isn&#39;t really that smart, all it does is goes through all the properties of the object and then converts them into properties that implement our pattern.</p>
<p>You can then use it like this:</p>
<pre class="highlighted"><code class="erlang">var person = <span class="tuple">{
    first<span class="variable">Name</span>: '<span class="variable">Aaron</span>',
    last<span class="variable">Name</span>: '<span class="variable">Powell</span>',
    age: <span class="number">27</span>
}</span>;

<span class="function"><span class="title">xamlizer</span><span class="params">(person)</span>;
<span class="title">person</span>.<span class="title">addPropertyChanging</span><span class="params">(<span class="keyword">fun</span><span class="function_name">ction</span>(object, property) <span class="tuple">{
    console.<span class="function_name">log</span>('<span class="variable">Property</span> ' + property + 'changing');
}</span>);

person.age = <span class="number">28</span>;</code></pre>
<p>And there we go, we&#39;ve got a script that&#39;ll turn our normal JavaScript objects into something that can notify subscribers when the property changes.</p>
<p>If you dig into the code for Xamlizer you&#39;ll see that it doesn&#39;t do anything really complex, it just modifies some properties. <em>Note: As I said it&#39;s not really that smart, it actually modifies anything public on the object, so if you have a function that is public it might get crazy :P. But hey, it&#39;s just demo code!</em></p>
<p>And if you want to see it in action check out the <a href="http://jsfiddle.net/slace/Zemxm/">jsfiddle</a>.</p>
<h1>Conclusion</h1>
<p>Well this wraps up our look at the limitations in how you have to do properties in ES3, the changes which ES5 provides you with (although their usefulness at the moment is debatable since we have to support ES3 browsers for a while still) and finished off with looking at how to implement a generic library to change fields to properties with debatable usefulness.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/javascript/xamlizer-implementing-something-silly-in-javascript';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
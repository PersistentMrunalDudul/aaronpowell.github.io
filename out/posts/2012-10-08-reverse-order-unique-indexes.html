<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Reverse order unique queries in IndexedDB | LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Reverse order unique queries in IndexedDB</h1>
                <h2>8th October 2012</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th March 2012</span>
                            <h3><a href="/posts/2012-03-14-hello-owin.html">Hello OWIN</a></h3>
                        </header>
                        <p>An introduction to OWIN and building a server.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/owin.html"><span>owin</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">30th May 2013</span>
                            <h3><a href="/posts/2013-05-30-libraries.html">Flight Mode - Libraries</a></h3>
                        </header>
                        <p>Throughout the last few posts we&#39;ve looked at the different ways which we can store data offline in browsers and then created a basic little API that will help is with doing that. The <code>FlightMode</code> ...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/localStorage.html"><span>localStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/sessionStorage.html"><span>sessionStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th April 2013</span>
                            <h3><a href="/posts/2013-04-10-wdc13.html">IndexedDB at Web Directions Code 13</a></h3>
                        </header>
                        <p>Upcoming speaking on IndexedDB</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/speaking.html"><span>speaking</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p><a href="http://www.aaron-powell.com/web/dbjs-indexes-and-queries">In my post my db.js querying</a> I covered how to do reverse unique queries with db.js using the <code>desc().distinct()</code> method chaining which will query an index for the unique items, but it&#39;ll do it in reverse order, essentially it will set a <a href="http://www.w3.org/TR/IndexedDB/#cursor-concept"><code>IDBCursor</code> direction of <code>prevunique</code></a>.</p>
<p>When covering off I mentioned that the way it works is a little unusual and here I&#39;ll explain why.</p>
<h1>How an index &quot;looks&quot;</h1>
<p>So you&#39;ve got an index in your object store, an index which is non-unique, and it contains duplicate values. Say you created an index like this:</p>
<pre class="highlighted"><code class="smalltalk">store.createIndex(<span class="string">'foo'</span>, <span class="string">'foo'</span>, { <span class="method">unique:</span> <span class="keyword">false</span> });</code></pre>
<p>Next you&#39;ve pushed a few items into it:</p>
<pre class="highlighted"><code class="css"><span class="tag">store</span><span class="class">.add</span>(<span class="rules">{ <span class="rule"><span class="attribute">foo</span>:<span class="value"> <span class="string">'bar'</span> }</span></span></span>);
<span class="tag">store</span><span class="class">.add</span>(<span class="rules">{ <span class="rule"><span class="attribute">foo</span>:<span class="value"> <span class="string">'bar'</span> }</span></span></span>);
<span class="tag">store</span><span class="class">.add</span>(<span class="rules">{ <span class="rule"><span class="attribute">foo</span>:<span class="value"> <span class="string">'baz'</span> }</span></span></span>);</code></pre>
<p>The data which has been stored in the index can be visualised as so:</p>
<table>
    <thead>
        <tr>
            <th>Key</th>
            <th>Value</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>bar</code></td>
            <td>
                
{
    id: 1,
    foo: &#39;bar&#39;
}
                
            </td>
        </tr>
        <tr>
            <td><code>bar</code></td>
            <td>
                
{
    id: 2,
    foo: &#39;bar&#39;
}
                
            </td>
        </tr>
        <tr>
            <td><code>baz</code></td>
            <td>
                
{
    id: 3,
    foo: &#39;baz&#39;
}
                
            </td>
        </tr>
    </tbody>
</table>

<h1>Walking our index</h1>
<p>From the diagram you can see the order of the data in our index, let&#39;s assume we&#39;re wanting to just walk through the index normally, using the <code>next</code> direction (the default if you don&#39;t set anything). We&#39;ll get back the records in the order of id 1, 2, 3, or by their key, <code>bar</code>, <code>bar</code>, <code>baz</code>. Now this makes sense, we&#39;re walking top-to-bottom just as the spec states and as we&#39;d expect from looking at our index.</p>
<p>Now let&#39;s turn that into a <code>nextunique</code> query, this time we get back the records with the id 1, 3, or the index keys <code>bar</code>, <code>baz</code>.</p>
<p>This is again to be expected, if you review the spec it states (emphasis is mine):</p>
<blockquote>
<p>&quot;nextunique&quot;. This direction causes the cursor to be opened at the start of the source. When iterated, the cursor should not yield records with the same key, but otherwise yield all records, in monotonically increasing order of keys. <strong>For every key with duplicate values, only the first record is yielded.</strong> When the source is an object store or a unique index, this direction has the exact same behavior as &quot;next&quot;.</p>
</blockquote>
<p>So what&#39;s interesting here is that there are deterministic rules as to how the item to be returned is selected from the index, basically it&#39;s what ever is first in the index for that key. This is basically what we&#39;d expect, no surprised so far.</p>
<h1>Walking backwards through our index</h1>
<p>We&#39;ve looked at walking forward through our index, but what if we want to walk backwards through it? Well that&#39;s where the <code>prev</code> cursor direction is for. Say we were to do a read-all operation using a <code>prev</code> cursor, we&#39;ll have the records in the order of id 3, 2, 1, or <code>baz</code>, <code>bar</code>, <code>bar</code>.</p>
<p>Not particularly shocking here, again that&#39;s what we&#39;d be expecting, we&#39;ve started at the end of the index and we&#39;ve grabbed the item then gone to the one before it in the index and so on.</p>
<p>Now it&#39;s over to the <code>prevunique</code> query so that we can get just a unique item for each index key from our index. The items we get back have an ID order of 3, 1 or the index keys <code>baz</code>, <code>bar</code>. Wait something doesn&#39;t look right there, the ID&#39;s were:</p>
<pre class="highlighted"><code class="lisp"><span class="number">3</span>
<span class="number">1</span></code></pre>
<p>And this is where it starts getting confusing...</p>
<h2>Understanding <code>prevunique</code></h2>
<p>Let&#39;s have a look at the spec for <code>prevunique</code> (emphasis is mine):</p>
<blockquote>
<p>&quot;prevunique&quot;. This direction causes the cursor to be opened at the end of the source. When iterated, the cursor should not yield records with the same key, but otherwise yield all records, in monotonically decreasing order of keys. <strong>For every key with duplicate values, only the first record is yielded</strong>. When the source is an object store or a unique index, this direction has the exact same behavior as &quot;prev&quot;.</p>
</blockquote>
<p>Do you see the confusing point, it states that when a duplicate item is found of a key you take <em>the first record</em> and this is where I was tripped up. When I first read this I took it as the first record <em>found</em> in the index, so when walking backwards in our example index above, we would get the ID of <code>2</code> as it was the first record with the <code>bar</code> key. But this is not the case, it is actually the first record <em>in the index</em> with that key, and since the record with the id <code>1</code> appears first in the index it will be returned. The key order is correct, we&#39;ve reverse-walked it based on that, but it was the item order that trips people up. In fact I raised a <a href="http://code.google.com/p/chromium/issues/detail?id=152879">bug on Chrome</a> as I was assuming that they had got it wrong. The bug has since been closed as it is implemented correctly.</p>
<p>The order can be summed up as:</p>
<blockquote>
<p>Reverse order by keys, items by index position</p>
</blockquote>
<h1>Conclusion</h1>
<p>The way IndexedDB handles reverse index walking is a little bit confusing on first read, but the more you review it the more that it starts to make some sense.</p>
<p>Currently IE10 doesn&#39;t handle this correctly though, it incorrectly reverses the order of the items in the index, I raised the question to them and you can find out more in the <a href="http://lists.w3.org/Archives/Public/public-webapps/2012OctDec/0043.html">thread on the mailing list</a>.</p>
<p>Admittedly this is a pretty esoteric problem to come across though, I can&#39;t think of an instance where the ordering of items in an index when traversed in reverse would be important, but then that may really just be a failure of imagination. If order is <em>really</em> that important you&#39;re probably best structuring your data so that the key can be unique.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/web/reverse-order-unique-indexes';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
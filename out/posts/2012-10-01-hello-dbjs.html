<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Hello db.js - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Hello db.js</h1>
                <h2>1st October 2012</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/winjs.html"><span>winjs</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">15th March 2012</span>
                            <h3><a href="/posts/2012-03-15-owin-and-middleware.html">OWIN and Middleware</a></h3>
                        </header>
                        <p>In my <a href="http://www.aaron-powell.com/web/hello-owin">last post</a> I looked at getting started with the basics of OWIN and how to create a server which wont do anything overly useful. In this post I wan...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/owin.html"><span>owin</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">30th May 2013</span>
                            <h3><a href="/posts/2013-05-30-libraries.html">Flight Mode - Libraries</a></h3>
                        </header>
                        <p>Throughout the last few posts we&#39;ve looked at the different ways which we can store data offline in browsers and then created a basic little API that will help is with doing that. The <code>FlightMode</code> ...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/localStorage.html"><span>localStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/sessionStorage.html"><span>sessionStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th April 2013</span>
                            <h3><a href="/posts/2013-04-10-wdc13.html">IndexedDB at Web Directions Code 13</a></h3>
                        </header>
                        <p>Upcoming speaking on IndexedDB</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/speaking.html"><span>speaking</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p><em>I&#39;m going to make the assumption you&#39;re somewhat familiar with IndexedDB in this post, if you&#39;re not check out <a href="https://developer.mozilla.org/en-US/docs/IndexedDB/Using_IndexedDB">this tutorial</a>.</em></p>
<p>If you&#39;ve spent any time looking at <a href="http://www.w3.org/TR/IndexedDB/">IndexedDB</a> you&#39;ll have to agree that the API leaves a lot to be desired. Look IndexedDB is a great feature of modern browsers but the problem is that its API is not really designed around modern JavaScript practices.</p>
<p>In particular I really dislike that you have to do stuff like this:</p>
<pre class="highlighted"><code class="sql">request.onerror = function(event) {
  // <span class="operator"><span class="keyword">Do</span> something <span class="keyword">with</span> request.errorCode!
};</span>
request.onsuccess = function(event) {
  // <span class="operator"><span class="keyword">Do</span> something <span class="keyword">with</span> request.result!
};</span></code></pre>
<p>It really starts getting convoluted when you&#39;re working with the events on the different request objects. Even opening the initial database can be quite ugly, if the version number has changed then you need to handle that event before the success event, doing migrations and all kinds of stuff.</p>
<p>The other ugliness starts coming into play when you want to hide your database code behind a public facing API, you&#39;re constantly having to take in callback arguments and it&#39;s Christmas trees all around.</p>
<p>On top of this if you look at the code above it feels very reminiscent of old-IE event wire-ups, <code>onclick</code> and all that fun stuff, but today the <a href="http://wiki.commonjs.org/wiki/Promises">Promise</a> callback pattern is a much more popular one (<a href="http://www.aaron-powell.com/doing-it-wrong/blinking-marquee">you&#39;ve probably seen it in jQuery</a>) as it does a great job of standardizing how you provide callbacks.</p>
<p>This was my impression when I started with IndexedDB so I decided that I&#39;d address it in my own way.</p>
<h1>Hello db.js</h1>
<p>I created a simple little library called <a href="https://github.com/aaronpowell/db.js">db.js</a> which aims to simplify the problems I was finding with IndexedDB&#39;s API. It&#39;s open source, it&#39;s up on GitHub and it&#39;s currently in production running my <a href="http://pinboard.aaron-powell.com">Pinboard for Windows 8 application</a>.</p>
<h1>Addressing callbacks</h1>
<p>The first design goal of db.js was to address the way callbacks were handled. As I said above I really dislike the <code>.onsuccess = function () { ... };</code> syntax that IndexedDB uses and I really like the Promise API.</p>
<p>For db.js I decided that everything would be handled through Promises to keep consistencies with the various callbacks that would be happening. Another decision was that I wouldn&#39;t take a dependency on any existing library that provides a Promise API (like jQuery) to keep db.js as agnostic as possible. So I implemented my own Promise API, as per the CommonJS specification that would power db.js (the Promise spec is pretty easy to implement really).</p>
<h1>Opening a connection</h1>
<p>There&#39;s a few things that you need to do when opening a server connection, you need to:</p>
<ul>
<li>Provide the name of the server</li>
<li>Provide a schema version<ul>
<li>If the schema version is newer then you have to handle a schema change</li>
</ul>
</li>
<li>Listen of a success or fail method and react accordingly</li>
</ul>
<p>Rather than through a series of properties or arguments that you set I went with an object literal, so creating a connection is like so:</p>
<pre class="highlighted"><code class="smalltalk">var promise = db.open({
    <span class="method">server:</span> <span class="string">'my-app'</span>,
    <span class="method">version:</span> <span class="number">1</span>,
    <span class="method">schema:</span> { 
        <span class="method">people:</span> { }
    }
});</code></pre>
<p>This opens a connection to the database server <code>my-app</code> on the current domain and the version of that server is <code>1</code>, which uses the provided schema, which has a single store (aka, table) called <code>people</code>. If you want more object stores then just add another property to the <code>schema</code> object, each named property becomes an object store name.</p>
<p>This returns a <code>Promise</code> object which is implemented as per the CommonJS spec so you have to listen for the success handler to move on:</p>
<pre class="highlighted"><code class="matlab"><span class="transposed_variable">promise.</span>done(<span class="function"><span class="keyword">function</span> <span class="params">(server)</span> {</span>
    <span class="transposed_variable">window.</span>server = server;
});</code></pre>
<p>It can get a bit tricky there, you don&#39;t have an active server connection <em>until</em> the <code>done</code> function is called. The argument it is provided is a db.js <code>Server</code> object which maintains the active connection. <strong>Make sure you expose that out otherwise your server connection will be lost!</strong></p>
<p><em>Note: Since opening the connection is an asynchronous operation you need to make sure any code that will use the server is told to wait for it. The connection generally opens quickly but when you can use it isn&#39;t known. This is something that can easily trip you up.</em></p>
<h2>Persisting the connection</h2>
<p>What you&#39;ll notice from the above code is that it is making the server a <em>global</em> object in my application. The expectation of db.js is that you only ever have one <code>Server</code> object, if you descope it you loose your access to the connection, but this does not <em>close</em> the connection. IndexedDB only allows one connection per server to be open at any given time, so keep that in mind in your application.</p>
<p>That said db.js will try and be smart about connection management, it caches the connections internally so if you try and re-open a connection it will return you the existing one.</p>
<h2>Closing the connection</h2>
<p>Since our connection is a singleton there may be times you don&#39;t need it hanging around, to do this you need to close it off:</p>
<pre class="highlighted"><code class="avrasm">server<span class="preprocessor">.close</span>()<span class="comment">;</span></code></pre>
<p>Be aware though that the connection <em>may not</em> close immediately, <a href="http://www.w3.org/TR/IndexedDB/#dfn-steps-for-closing-a-database-connection">IndexedDB has steps it must follow</a> to close a connection. Once the connection is closed the <code>Server</code> instance that db.js provided you with will raise an error any time you try and work against it.</p>
<h1>Accessing a store</h1>
<p>Now that you have a connection db.js will be smart about what stores you have available. What it does is go through all the stores on your connection and create them as properties of the server, allowing quick access to them. Let&#39;s see how that works by adding some data.</p>
<h2>Adding data</h2>
<p>IndexedDB has a really nice feature when it comes to adding data (well doing any operation really), it has transaction support! The problem is that because of this everything takes lot more code to do. With db.js this is seemlessly handled for you and when you&#39;re doing bulk inserts it&#39;ll even take care of that:</p>
<pre class="highlighted"><code class="vbscript">var promise = <span class="built_in">server</span>.people
    .add({
        firstName: <span class="comment">'Aaron',</span>
        lastName: <span class="comment">'Powell'</span>
    }, {
        firstName: <span class="comment">'John',</span>
        lastName: <span class="comment">'Smith'</span>
    });</code></pre>
<p>Here you&#39;ll notice we&#39;re accessing the <code>people</code> property on our <code>server</code>, this tells db.js which of our object stores we want to work against. Next you pass in one or more items that represent the objects you want to store and then the method returns a Promise. To know when you have added all records use a <code>done</code> handler:</p>
<pre class="highlighted"><code class="matlab"><span class="transposed_variable">promise.</span>done(<span class="function"><span class="keyword">function</span> <span class="params">(records, server)</span> {</span>
    <span class="transposed_variable">console.</span><span class="built_in">log</span>(records);
});</code></pre>
<p>The <code>done</code> method will be provided with the records <em>after</em> they go into IndexedDB, this means that if you&#39;re using an auto-incrementing key it&#39;ll have been added to the record so you can then access it.</p>
<p><em>Note: I&#39;ll cover off how to set up a key on an object store in a future post.</em></p>
<h3>Promise <code>progress</code> method</h3>
<p>If you&#39;ve read the Promise spec you&#39;ll notice that it includes a reference to a <code>progress</code> method. This is used to keep the application &quot;in the loop&quot; when an asynchronous job is running. When you are using the <code>add</code> method in db.js it will trigger the <code>progress</code> method <strong>for each record that is inserted</strong>. This is because there are two levels of asynchronous jobs happening in the <code>add</code> process, you have the overall <code>transaction</code> status and the individual record status. I see the main use for this is when you are doing a large insert into IndexedDB (say the first time the user comes to the application) and you want them to know not to hit refresh.</p>
<h2>Removing data</h2>
<p>Removing records is just as simple as adding them:</p>
<pre class="highlighted"><code class="matlab"><span class="transposed_variable">server.</span>people
    .remove(<span class="number">1</span>)
    .done(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
        <span class="transposed_variable">console.</span><span class="built_in">log</span>(<span class="string">'removed record with key `1`'</span>);
    });</code></pre>
<p>You need to provide the key of the record you wish to remove and it&#39;ll go off and do it.</p>
<p><em>Note: Currently db.js doesn&#39;t support bulk removal.</em></p>
<h2>Accessing a record</h2>
<p>You&#39;ve got a record into your store, how about getting it back out again?</p>
<pre class="highlighted"><code class="matlab"><span class="transposed_variable">server.</span>people
    .get(<span class="number">1</span>)
    .done(<span class="function"><span class="keyword">function</span> <span class="params">(person)</span> {</span>
        <span class="transposed_variable">console.</span><span class="built_in">log</span>(<span class="string">'The person with the primary key `1` is... '</span>, person);
    });</code></pre>
<p>The <code>get</code> method takes a single key and returns the record that matches it. Essentially it&#39;s a pass through to the <a href="http://www.w3.org/TR/IndexedDB/#widl-IDBObjectStore-get-IDBRequest-any-key">native <code>get</code> metohd of IndexedDB</a>.</p>
<h2>Accessing multiple records</h2>
<p>If you want to get back multiple records db.js has a very extensive query API which supports all of the IndexedDB query methods, as well as adding some additional sugar on top. Here&#39;s a basic &quot;get all&quot; operation:</p>
<pre class="highlighted"><code class="avrasm">server<span class="preprocessor">.people</span>
    <span class="preprocessor">.query</span>()
    <span class="preprocessor">.all</span>()
    <span class="preprocessor">.execute</span>()
    <span class="preprocessor">.done</span>(function (people) {
        console<span class="preprocessor">.log</span>(people)<span class="comment">;</span>
    })<span class="comment">;</span></code></pre>
<p>There&#39;s a few steps you need to go through, first all the querying is done via the <code>query</code> API. From here we use the <code>all</code> method which is exposed, it tells IndexedDB to get back each record in an unfiltered manner. Once we&#39;re done setting up our query we call the <code>execute</code> method which tells db.js to take the rules we&#39;ve specified and pass them through to IndexedDB. Ultimately a <code>Promise</code> is returned and we can listen for the resulting data.</p>
<p>The reason for the <code>execute</code> method is because there&#39;s a lot more we can do from the query. Through this we have a nice fluent chaining API that we can structure our query before it is run. In my next post we&#39;ll look at how to do more powerful querying with db.js.</p>
<h1>Conclusion</h1>
<p>This has been a very quick overview of <a href="http://github.com/aaronpowell/db.js">db.js</a> and the approach I&#39;ve taken to simplify working with IndexedDB.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/web/hello-dbjs';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Testable email sending - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Testable email sending</h1>
                <h2>28th August 2010</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/testing.html"><span>testing</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">27th May 2010</span>
                            <h3><a href="/posts/2010-05-27-lucene-analyzer.html">Analyzers in Lucene.Net</a></h3>
                        </header>
                        <h2>What is an Analyzer?</h2>
<p>When you want to insert data into a Lucene index, or when you want to get the data back out of the index you will need to use an Analyzer to do this.</p>
<p>Lucene ships with ma...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/examine.html"><span>examine</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-examine.html"><span>umbraco-examine</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">24th September 2012</span>
                            <h3><a href="/posts/2012-09-24-check-if-file-exists.html">How to check if a file exists in Windows 8</a></h3>
                        </header>
                        <p>Ever wondered how to check if a file exists in Windows 8?</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/windows8.html"><span>windows8</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/winjs.html"><span>winjs</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/winrt.html"><span>winrt</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th July 2010</span>
                            <h3><a href="/posts/2010-07-10-building-an-application-with-lucene-net.html">Building an application with Lucene.Net</a></h3>
                        </header>
                        <p>A more in-depth look at how to use Lucene for storage and building a simple application</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene.html"><span>lucene</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2010</span>
                            <h3><a href="/posts/2010-07-05-dynamics-library.html">Dynamics Library</a></h3>
                        </header>
                        <p>A series of helper methods for working with the DLR in C# 4.0</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/dynamic.html"><span>dynamic</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">3rd July 2010</span>
                            <h3><a href="/posts/2010-07-03-documents-in-lucene-net.html">Documents in Lucene.Net</a></h3>
                        </header>
                        <p>As you&#39;re most likely already aware Lucene.Net is a Document Database, which means that it&#39;s essentially a key/ value store, with the crux of the interaction through <em>Documents</em></p>
<h2>But what is a Do...</h2>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>Yesterday <a href="http://twitter.com/shazwazza">Shannon</a> finally got with the times and learnt about the <code>System.Net</code> and how it can be used to <a href="http://farmcode.org/post/2009/07/16/Testing-Outgoing-SMTP-Emails-So-Simple!.aspx">dump emails to your file system</a>.</p>
<p>Something I then mentioned to him on Twitter was that you can also use this method to test the email that was sent.</p>
<p>First off lets write ourselves a very basic email sending test:</p>
<pre class="highlighted"><code class="avrasm">[TestMethod]
public void EmailSender() {
    var mail = new MailMessage()<span class="comment">;</span>
    mail<span class="preprocessor">.To</span><span class="preprocessor">.Add</span>(<span class="string">"example@somewhere.com"</span>)<span class="comment">;</span>
    mail<span class="preprocessor">.From</span> = new MailAddress(<span class="string">"example2@somewhere.com"</span>)<span class="comment">;</span>
    mail<span class="preprocessor">.Subject</span> = <span class="string">"Testing Email"</span><span class="comment">;</span>
    mail<span class="preprocessor">.Body</span> = <span class="string">"Sending Email. Woo!"</span><span class="comment">;</span>
    var smtp = new SmtpClient()<span class="comment">;</span>
    smtp<span class="preprocessor">.Send</span>(mail)<span class="comment">;</span>
}</code></pre>
<p>So we&#39;re assuming that we&#39;ve set our config up so that we&#39;re dumping the email to the file system. This is all well and good but how do we assert that the email was sent to the right person, and that the body/ subject was what we wanted? Well that can easily be done, if you know the structure of the .eml file which is generated when dumping the mail to the file system.</p>
<p>I wrote a handy little class which can do this:</p>
<pre class="highlighted"><code class="vbscript"><span class="keyword">public</span> sealed <span class="keyword">class</span> EmlHelper
{
    <span class="keyword">public</span> <span class="built_in">string</span> Path { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    <span class="keyword">public</span> <span class="built_in">string</span> From { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    <span class="keyword">public</span> <span class="built_in">string</span> <span class="keyword">To</span> { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    <span class="keyword">public</span> <span class="built_in">string</span> Subject { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    <span class="keyword">public</span> <span class="built_in">string</span> Urls { <span class="keyword">get</span>; <span class="keyword">set</span>; }

    <span class="keyword">public</span> EmlHelper(<span class="built_in">string</span> path)
    {
        Path = path;
        <span class="built_in">string</span> fc = <span class="keyword">new</span> StreamReader(path).ReadToEnd();
        From = Regex.Matches(fc, <span class="string">"From: (.+)"</span>)[<span class="number">0</span>].ToString().<span class="built_in">Replace</span>(<span class="string">"From: "</span>, <span class="built_in">string</span>.<span class="literal">Empty</span>).<span class="built_in">Trim</span>();
        <span class="keyword">To</span> = Regex.Matches(fc, <span class="string">"To: (.+)"</span>)[<span class="number">0</span>].ToString().<span class="built_in">Replace</span>(<span class="string">"To: "</span>, <span class="built_in">string</span>.<span class="literal">Empty</span>).<span class="built_in">Trim</span>();
        Subject = Regex.Matches(fc, <span class="string">"Subject: (.+)"</span>)[<span class="number">0</span>].ToString().<span class="built_in">Replace</span>(<span class="string">"Subject: "</span>, <span class="built_in">string</span>.<span class="literal">Empty</span>).<span class="built_in">Trim</span>();
        Urls = <span class="built_in">string</span>.<span class="literal">Empty</span>;
        foreach (Match m <span class="keyword">in</span> Regex.Matches(fc, @<span class="string">"https?://([a-zA-Z\.]+)/"</span>))
        {
            Urls += m.ToString() + <span class="comment">' ';</span>
        }
    }
}</code></pre>
<p>It&#39;s a fairly basic class which you just need to understand the structure of the eml file, I used some regexes to break it apart. They may be a bit brittle (my regex skills aren&#39;t crash hot) and I don&#39;t support reading the body (as you really need to customise that for plain text vs HTML, and yeah, good luck there :P).</p>
<p>Now all that we need to do is pass in the file name of the email which was generated. </p>
<p>The problem is that there isn&#39;t really a good way to determine the email (someone know a way?), so you can just use LINQ to locate the file ordered by created date or something, but for this example I&#39;m going to assume that there aren&#39;t any other files in there anyway. So lets update our test method:</p>
<pre class="highlighted"><code class="avrasm">[TestMethod]
public void EmailSender() {
    var mail = new MailMessage()<span class="comment">;</span>
    mail<span class="preprocessor">.To</span><span class="preprocessor">.Add</span>(<span class="string">"example@somewhere.com"</span>)<span class="comment">;</span>
    mail<span class="preprocessor">.From</span> = new MailAddress(<span class="string">"example2@somewhere.com"</span>)<span class="comment">;</span>
    mail<span class="preprocessor">.Subject</span> = <span class="string">"Testing Email"</span><span class="comment">;</span>
    mail<span class="preprocessor">.Body</span> = <span class="string">"Sending Email. Woo!"</span><span class="comment">;</span>
    var smtp = new SmtpClient()<span class="comment">;</span>
    smtp<span class="preprocessor">.Send</span>(mail)<span class="comment">;</span>

    var emailSettings = (MailSettingsSectionGroup)ConfigurationManager
                 <span class="preprocessor">.OpenExecConfiguration</span>(ConfigurationUserLevel<span class="preprocessor">.Now</span>)
                 <span class="preprocessor">.GetSectionGroup</span>(<span class="string">"system.net/mailSettings"</span>)<span class="comment">;</span>
    var folder = emailSettings<span class="preprocessor">.MailSettings</span><span class="preprocessor">.Smtp</span><span class="preprocessor">.SpecifiedPickupDirectory</span><span class="preprocessor">.PickupDirectoryLocation</span><span class="comment">;</span>
    var eml = new EmlHelper(new DirectoryInfo(folder)<span class="preprocessor">.GetFiles</span>()<span class="preprocessor">.First</span>()<span class="preprocessor">.FullName</span>)<span class="comment">;</span>

    //Assert
    Assert<span class="preprocessor">.AreEqual</span>(mail<span class="preprocessor">.ToAddresses</span>[<span class="number">0</span>]<span class="preprocessor">.Address</span>, eml<span class="preprocessor">.To</span>)<span class="comment">;</span>
    Assert<span class="preprocessor">.AreEqual</span>(mail<span class="preprocessor">.Subject</span>, eml<span class="preprocessor">.Subject</span>)<span class="comment">;</span>
    //<span class="keyword">and</span> so on
}</code></pre>
<p>So there you have it, it&#39;s very basic to use and make testable email sending.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/testable-email-sending';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Solving DocPad's excessive memory usage - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Solving DocPad's excessive memory usage</h1>
                <h2>18th June 2013</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/docpad.html"><span>docpad</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th June 2013</span>
                            <h3><a href="/posts/2013-06-10-new-blog-less-funnelweb.html">New blog, less FunnelWeb</a></h3>
                        </header>
                        <p>It&#39;s time for a refresh, my blog has made a move, this time away from FunnelWeb.</p>
<p>But why, how and what for the future of FunnelWeb?</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/funnelweb.html"><span>funnelweb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/docpad.html"><span>docpad</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>Since I decide to <a href="/posts/2013-06-10-new-blog-less-funnelweb.html">move my site from FunnelWeb to DocPad</a> I also decided to deploy to <a href="http://www.heroku.com">Heroku</a> since I like them as a host. So I <a href="https://github.com/aaronpowell/aaronpowell.github.io">built my site</a>, <a href="/posts/2013-06-11-funnelweb-to-git.html">got everything into Git</a> and then I did a <code>git push heroku master</code>.</p>
<p><strong>And then it fell over.</strong></p>
<p>As soon as the push completed Heroku kicked off and started to spin up the dyno, but when I hit the site it said it&#39;d crashed.</p>
<p>Crashed, seriously? It&#39;s a bunch of HTML files, how on earth can that crash?</p>
<p>So I crack out the Heroku toolbox and inspect the log files and find the crash, it crashed because <em>it exceeded the allocated memory</em>.</p>
<p><strong>Exceeded the allocated memory?!</strong> IT&#39;S A STATIC SITE!</p>
<p>Ok, fine, let&#39;s have a look at what could be wrong, how a static site could be blowing out the memory allowance (512mb it&#39;s allocated). I fire up the <code>docpad run</code> command which is what is done on Heroku and this is what I get:</p>
<p><img src="/get/docpad-memory-usage.PNG" alt="DocPad memory usage"></p>
<p>That&#39;s nearly 700mb memory usage for a static site! I&#39;ve seen it peak at over 900mb, run idle around 850mb, all kinds of wacky memory usage.</p>
<h1>The not so static static site</h1>
<p>So it would seem that I made a false assumption about DocPad, it&#39;s not quite as static as I thought it was. While yes, it generates all these flat HTML files on disk it also keeps all the content in memory:</p>
<p><blockquote class="twitter-tweet"><p><a href="https://twitter.com/slace">@slace</a> <a href="https://twitter.com/shiftkey">@shiftkey</a> we put all the files in memory for generation and keep them there for quick access, so not a bad thing</p>&mdash; DocPad (@DocPad) <a href="https://twitter.com/DocPad/statuses/341171857317314562">June 2, 2013</a></blockquote></p>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Well that&#39;s kind of crap, I mean, I&#39;ve got ~400 files in my generated output so it&#39;s a lot of files that need to be stored in memory when really the requests can just be routed to a location on disk.</p>
<h1>Solving the memory problem</h1>
<p>I&#39;ve already made my choice to go with DocPad but since it&#39;s having some whacky memory consumption issues meaning that it&#39;s not really going to be a viable deployment option so how can I go about it?</p>
<p>Well why not use DocPad to generate the HTML and then just write my own routing layer using <a href="http://expressjs.com">Express.js</a>? After all DocPad is just sitting on top of Express.js to do a lot of its heavy lifting. In fact it&#39;s really simple to make a routing engine on top of Express.js:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);
<span class="keyword">var</span> app = express();

app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(__dirname + <span class="string">'/out'</span>));

app.listen(process.env.PORT || <span class="number">3000</span>);</code></pre>
<p>Yep that&#39;s it, we&#39;ve got our site going and now I can deploy it.</p>
<p><em>Note: There&#39;s still a bit of a limitation here, DocPad&#39;s memory will blow out mostly during its generation phase so this now means that I have to check the <code>/out</code> folder into my git repository, which makes it larger, but it&#39;s not that big a problem really.</em></p>
<h2>Maintaining old routes</h2>
<p>As I said in my last post I needed to ensure that I didn&#39;t break my SEO between my old routes and my new ones. When using DocPad&#39;s engine it&#39;ll look at the <code>urls</code> meta-data which it&#39;ll then 301 the response. Now you can see why DocPad does have some of its heavy memory usage, it actually does some on-the-fly mapping of routes. Still, I&#39;m pretty sure I can do this without the memory explosion.</p>
<p>My idea is that we can use the DocPad <a href="http://docpad.org/docs/plugins">plugin model</a> and from that generate a JSON object that represents all the alternate routes for our posts, then we can load that JSON into our Express.js app and map the routes.</p>
<p>My plugin can be found <a href="https://github.com/aaronpowell/aaronpowell.github.io/tree/master/plugins/docpad-plugin-staticroutes">here</a> and what it does is:</p>
<ul>
<li>Hook into the <code>writeAfter</code> event</li>
<li>Grab all <code>document</code> objects</li>
<li>Create an object that contains the URL we want and all the alternate URLs that we want to 301</li>
<li>Strip out any that don&#39;t have alternate URLs</li>
<li>Write this to the output folder</li>
</ul>
<p>Here&#39;s the code that&#39;ll create our route map:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> docs = <span class="keyword">this</span>.docpad.getCollection(<span class="string">'documents'</span>).toJSON();

<span class="keyword">var</span> routes = docs.map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
    <span class="keyword">return</span> {
        url: doc.url,
        redirects: doc.urls.filter(<span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span> <span class="keyword">return</span> x !== doc.url; })
    };
}).filter(<span class="function"><span class="keyword">function</span> <span class="params">(route)</span> {</span>
    <span class="keyword">return</span> !!route.redirects.length;
});</code></pre>
<p>So from that we can now update our Express.js file to look like so:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);
<span class="keyword">var</span> app = express();

app.get(<span class="string">'/routes.json'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> {</span>
    res.status(<span class="number">403</span>).send(<span class="string">'403 Forbidden'</span>);
})

app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(__dirname + <span class="string">'/out'</span>));
app.<span class="keyword">use</span>(<span class="string">'/get'</span>, express.<span class="keyword">static</span>(__dirname + <span class="string">'/src/files/get'</span>));

<span class="keyword">var</span> routes = <span class="keyword">require</span>(<span class="string">'./out/routes.json'</span>).routes;

<span class="keyword">var</span> redirector = <span class="function"><span class="keyword">function</span> <span class="params">(dest)</span> {</span>
    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> {</span>
        res.redirect(<span class="number">301</span>, dest);
    };
};

routes.map(<span class="function"><span class="keyword">function</span> <span class="params">(route)</span> {</span>
    <span class="keyword">if</span> (route.redirects) {
        <span class="keyword">return</span> route.redirects.map(<span class="function"><span class="keyword">function</span> <span class="params">(redirect)</span> {</span>
            <span class="keyword">return</span> app.get(redirect, redirector(route.url));
        });
    }
    <span class="keyword">return</span>;
});

app.listen(process.env.PORT || <span class="number">3000</span>);</code></pre>
<p>I&#39;ve also put a few other special routes, I&#39;m putting a 403 on the <code>routes.json</code> file since it sits in the root of my <code>out</code> folder and I don&#39;t really want it served out to the world (I&#39;m also serving my assets from a special folder to avoid duplicating them in the repo and making it huge).</p>
<h1>Conclusion</h1>
<p>DocPad appears to be a bit of a memory hog which can introduce some problems when you are looking at your hosting options, so make sure you look at that before signing any hosting agreement.</p>
<p>But that said if you want to invest a little bit of effort and not rely on DocPad as your routing engine then you can rely on just the HTML that is generated and use a middleware like Express.js to handle the routing with a minimal memory footprint.</p>
<p><em>For the record, my site now run around the 20mb memory footprint.</em></p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/posts/2013-06-18-solving-docpads-excessive-memory-usage.html';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
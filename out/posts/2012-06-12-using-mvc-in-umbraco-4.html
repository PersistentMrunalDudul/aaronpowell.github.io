<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Using ASP.NET MVC in Umbraco 4 - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Using ASP.NET MVC in Umbraco 4</h1>
                <h2>12th June 2012</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">27th November 2010</span>
                            <h3><a href="/posts/2010-11-27-umbraco-menu-with-ironruby.html">Creating a menu in Umbraco with IronRuby</a></h3>
                        </header>
                        <p>No more XSLT, DRL for the win</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/ironruby.html"><span>ironruby</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th September 2012</span>
                            <h3><a href="/posts/2012-09-05-text-casing-and-examine.html">Text casing and Examine</a></h3>
                        </header>
                        <p>A few times I&#39;ve seen questions posted on the Umbraco forums which ask how to deal with case insensitivity text with Examine, and itâ€™s also something that we&#39;ve had to handle a few times within our...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/examine.html"><span>examine</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">25th June 2012</span>
                            <h3><a href="/posts/2012-06-25-i-helped-kill-umbraco-5.html">I helped kill Umbraco 5</a></h3>
                        </header>
                        <p>Hi, my name&#39;s Aaron Powell and I was involved in killing Umbraco 5.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-5.html"><span>umbraco-5</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/opinionated.html"><span>opinionated</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">13th June 2012</span>
                            <h3><a href="/posts/2012-06-13-introducing-umbraco-contributor-list.html">Introducing the Umbraco contributor mailing list</a></h3>
                        </header>
                        <p>Keen discuss contributing to Umbraco&#39;s core, join the discussion now!</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">25th January 2012</span>
                            <h3><a href="/posts/2012-01-25-macros-in-packages.html">Macros in packages</a></h3>
                        </header>
                        <p>Wanting to include a Macro in your v5 package, where do you start?</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbaco.html"><span>umbaco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-5.html"><span>umbraco-5</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>By now you&#39;ve probably heard the decision of Umbraco HQ to no longer investing resources in Umbraco MVC and instead the focus (from both HQ and the community) is on making Umbraco 4 a better product.</p>
<p>One thing that  a lot of developers were waiting for with Umbraco was the ability to use MVC with Umbraco. Over the course of the retreat we looked at where this motivation came from any one of the things that we seemed to agree is that most Umbraco users aren&#39;t concerned about whether the underlying technology is MVC or not, the just want to be able to write clean mark up which MVC, or more importantly Razor allows you to do.</p>
<p>But there still is a valid reason for wanting to use MVC when building <strong>applications</strong> in Umbraco, and by that I mean if you&#39;re building say a booking platform you may prefer to write that part of your application in MVC. This application side of your website may not really need content management so the onus of Umbraco is very little. So how do you go about doing this, using MVC for your web application inside an Umbraco CMS?</p>
<h1>It&#39;s all ASP.NET</h1>
<p>If you&#39;ve been following the movements of ASP.NET of recent months you&#39;ll have seen a lot of emphasis by the ASP.NET team on the idea of <strong>One ASP.NET</strong>, that WebForms, MVC, WebAPI and WebPages are all part of the same stack and all can play nicely together. <a href="http://www.hanselman.com/">Scott Hanselman</a> has blogged in the past on creating <a href="http://www.hanselman.com/blog/IntegratingASPNETMVC3IntoExistingUpgradedASPNET4WebFormsApplications.aspx">hybrid ASP.NET applications</a> which allow you to host MVC along side WebForms and that&#39;s what I want to look at.</p>
<p>Simply put...</p>
<p><img src="https://dl.dropbox.com/u/9397363/memes/why-dont-we-have-both.png" alt="Why don&#39;t we have both?"></p>
<h1>Before we begin</h1>
<p>This is not a solution for everybody, what I&#39;m going to look at through the rest of this blog is very much a <strong>proof of concept</strong>, I haven&#39;t deployed a site doing this, I&#39;m writing this blog post in the back of a car while driving to Copenhagen. It&#39;s designed as an idea to hopefully inspire more people to get involved. It will also require you to open up Visual Studio and do some coding, but I expect that if you&#39;re planning on building an MVC application that&#39;s a known fact.</p>
<p>I&#39;m also going to make the assumption that you are familiar with MVC, if you&#39;re not please start by checking out the guides at <a href="http://www.asp.net/mvc">www.asp.net/mvc</a></p>
<p><a href="http://www.codinghorror.com/blog/2007/03/the-works-on-my-machine-certification-program.html">Finally</a>:</p>
<p><img src="https://dl.dropbox.com/u/9397363/memes/works-on-my-machine.png" alt="Works on my machine"></p>
<h1>Getting Started</h1>
<p>First things first I&#39;m going to create an empty ASP.NET site. I&#39;m using Visual Studio 2012 which comes with a completely empty project template:</p>
<p><img src="http://www.aaron-powell.com/get/umbraco/mvc-v4/001.PNG" alt="New project"></p>
<p>If you aren&#39;t running Visual Studio 2012 don&#39;t fear, you can always use one of the other web project types and delete the files, here&#39;s what my solution explorer looks like now:</p>
<p><img src="http://www.aaron-powell.com/get/umbraco/mvc-v4/002.PNG" alt="Solution overview"></p>
<p>Next up grab yourself a copy of Umbraco 4, I&#39;ve used <a href="http://umbraco.codeplex.com/releases/view/81011">Umbraco 4.7.2</a> for this but as newer versions come out some of this may change. Once you&#39;ve downloaded Umbraco 4.7.2 (you can use Web Platform Installer as well) copy all the files into the folder which your project resides in. <strong>Make sure you replace the web.config with the Umbraco provided one</strong>. Also you don&#39;t need to add any of the Umbraco files or folders to Visual Studio if you don&#39;t want.</p>
<p>You&#39;re now ready to go with creating your Umbraco instance, feel free to setup your database, document types, etc.</p>
<h1>Getting MVC installed</h1>
<p>So now that we&#39;ve got our Umbraco instance running we want to get our MVC application integrated. The first thing I want to do is to add MVC to the project, for this I&#39;m going to use <a href="http://nuget.org">NuGet</a> as it&#39;ll greatly reduce the effort in adding references, but you can do it manually if you require.</p>
<p>Go ahead an install the <code>Microsoft.AspNet.Mvc</code> NuGet package:</p>
<p><img src="http://www.aaron-powell.com/get/umbraco/mvc-v4/003.PNG" alt="Installing ASP.NET MVC"></p>
<p><em>Note: I used the Package Management Console, but you could just as easily use the GUI tool. Assuming you have NuGet installed both options are available from Tools &gt; Library Package Manager.</em></p>
<p>Now that that is done go ahead and create these folders:</p>
<ul>
<li>App_Start</li>
<li>Controllers</li>
<li>Views</li>
</ul>
<h1>Setting up our routes</h1>
<p>Generally speaking you will create your routes inside the <code>Global.asax</code> file. Umbraco has been pretty notorious about how it handles this file so I found it easier to <strong>not</strong> register my routes there, instead I&#39;m going to register my routes using the <a href="http://www.google.com.au/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0CFYQFjAA&amp;url=http%3A%2F%2Fmsdn.microsoft.com%2Fen-us%2Flibrary%2Fsystem.web.preapplicationstartmethodattribute.aspx&amp;ei=-kbXT-DfDYXRtAa8zc3lDw&amp;usg=AFQjCNHsinP1-aIRC9LaERAs6BS0x_dh6g&amp;sig2=ST3e-8kmro4SYFOZbb298w"><code>PreApplicationStartMethod</code></a> attribute and this is why we created the <code>App_Start</code> folder.</p>
<p>Start off by creating an empty class in there:</p>
<pre class="highlighted"><code class="vala"><span class="class"><span class="keyword">namespace</span> <span class="title">WebApplication2</span>.<span class="title">App_Start</span>
{</span>
    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteSetup</span>
    {</span>
    }
}</code></pre>
<p>Now add a new method that will be used by the <code>PreApplicationStartMethod</code> attribute:</p>
<pre class="highlighted"><code class="vala"><span class="class"><span class="keyword">namespace</span> <span class="title">WebApplication2</span>.<span class="title">App_Start</span>
{</span>
    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteSetup</span>
    {</span>
        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Setup()
        {

        }
    }
}</code></pre>
<p><em>Note: This method must be both <code>public</code> and <code>static</code>.</em></p>
<p>Next up, add the attribute:</p>
<pre class="highlighted"><code class="vala"><span class="keyword">using</span> System.Web;    
[assembly: PreApplicationStartMethod(typeof(WebApplication2.App_Start.RouteSetup), <span class="string">"Setup"</span>)]
<span class="class"><span class="keyword">namespace</span> <span class="title">WebApplication2</span>.<span class="title">App_Start</span>
{</span>
    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteSetup</span>
    {</span>
        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Setup()
        {

        }
    }
}</code></pre>
<p>What we&#39;ve done here is told ASP.NET that we have a class which has a method we want to run when the application is starting up, and with this we can start injecting some routes:</p>
<pre class="highlighted"><code class="objectivec">using System<span class="variable">.Web</span>;
using System<span class="variable">.Web</span><span class="variable">.Mvc</span>;
using System<span class="variable">.Web</span><span class="variable">.Routing</span>;

[assembly: PreApplicationStartMethod(typeof(WebApplication2<span class="variable">.App_Start</span><span class="variable">.RouteSetup</span>), <span class="string">"Setup"</span>)]
namespace WebApplication2<span class="variable">.App_Start</span>
{
    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="id">RouteSetup</span></span>
    {
        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Setup()
        {
            RouteTable<span class="variable">.Routes</span><span class="variable">.MapRoute</span>(
                <span class="string">"Default"</span>, <span class="comment">// Route name</span>
                <span class="string">"{controller}/{action}/{id}"</span>, <span class="comment">// URL with parameters</span>
                new { controller = <span class="string">"Home"</span>, action = <span class="string">"Index"</span>, <span class="keyword">id</span> = UrlParameter<span class="variable">.Optional</span> } <span class="comment">// Parameter defaults</span>
            );
        }
    }
}</code></pre>
<p>I&#39;ve added a couple of <code>using</code> statements and I&#39;ve also added a single route, here you can define as many routes as you want, go as crazy as you need for your application routing. But there&#39;s still one more thing we need to do with the routing, we need to make sure Umbraco will also ignore it. The Umbraco routing engine is pretty greedy, it wants to handle everything, the problem is that this isn&#39;t an Umbraco route so we don&#39;t want it to be handled there. Luckily this is easy to do, open up the <code>Web.config</code> and we&#39;ll change the <code>umbracoReservedPaths</code> appSetting:</p>
<pre class="highlighted"><code class="xml"><span class="tag">&lt;<span class="title">add</span> <span class="attribute">key</span>=<span class="value">"umbracoReservedPaths"</span> <span class="attribute">value</span>=<span class="value">"~/umbraco,~/install/,~/home"</span> /&gt;</span></code></pre>
<p><em>Note: The more complex your routes the more you&#39;ll need to update this. It might be advisable to put all your routes behind a certain prefix. I&#39;ve also not tested this with MVC Areas so I have no idea if that&#39;ll work. Finally I have an idea on how to make the route registration simpler and more unobtrusive and I&#39;ll post a follow up blog post.</em></p>
<h1>Creating a controller and views</h1>
<p>So I&#39;m going to go ahead and create a really basic controller:</p>
<pre class="highlighted"><code class="python">using System.Web.Mvc;

namespace WebApplication1.Controllers
{
    public <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> :</span> Controller
    {
        public ActionResult Index()
        {
            <span class="keyword">return</span> View();
        }
    }
}</code></pre>
<p>This is just a standard MVC controller, go as nuts with it as needed. Now we&#39;ll add the view:</p>
<pre class="highlighted"><code class="xml">@{
    Layout = null;
    ViewBag.Title = "Home";
}
<span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;<span class="title">html</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.w3.org/1999/xhtml"</span>&gt;</span>
<span class="tag">&lt;<span class="title">head</span>&gt;</span>
    <span class="tag">&lt;<span class="title">title</span>&gt;</span>@ViewBag.Title<span class="tag">&lt;/<span class="title">title</span>&gt;</span>
<span class="tag">&lt;/<span class="title">head</span>&gt;</span>
<span class="tag">&lt;<span class="title">body</span>&gt;</span>
    <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Hello I'm a razor view.<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
<span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span></code></pre>
<p><em>Note: This view is <strong>stupidly</strong> simple, but this is just a proof of concept :P.</em></p>
<p><em>Note #2: You may not get the nice Visual Studio menu options for creating contollers and views, you also might find that the razor file has a lot of red squigglies, when this happens it&#39;s because your Visual Studio project type is not an MVC project, there&#39;s a GUID you can change in the csproj file but I&#39;ll leave that to you to experiment with.</em></p>
<p>We&#39;re just about ready to host our MVC application!</p>
<h1>Web.config for all</h1>
<p>In this demo, because I used NuGet I&#39;m using MVC 4.0 which also means you have Razor 2.0, this means we need to do some changes to the Umbraco web.config file to support this.</p>
<p><strong>Change #1</strong></p>
<p>You need to add your own <code>Web.config</code> for the MVC views, this will reside at <code>/Views/Web.config</code> in your project. The easiest way to get the contents is to grab it from a new MVC project. If you do that you need to remove a part though, as Umbraco already has some Razor support it will want to take over for the MVC side as well. Because of this you need to remove this part:</p>
<pre class="highlighted"><code class="xml"><span class="tag">&lt;<span class="title">sectionGroup</span> <span class="attribute">name</span>=<span class="value">"system.web.webPages.razor"</span> <span class="attribute">type</span>=<span class="value">"System.Web.WebPages.Razor.Configuration.RazorWebSectionGroup, System.Web.WebPages.Razor, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35"</span>&gt;</span>
  <span class="tag">&lt;<span class="title">section</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">type</span>=<span class="value">"System.Web.WebPages.Razor.Configuration.HostSection, System.Web.WebPages.Razor, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35"</span> <span class="attribute">requirePermission</span>=<span class="value">"false"</span> /&gt;</span>
  <span class="tag">&lt;<span class="title">section</span> <span class="attribute">name</span>=<span class="value">"pages"</span> <span class="attribute">type</span>=<span class="value">"System.Web.WebPages.Razor.Configuration.RazorPagesSection, System.Web.WebPages.Razor, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35"</span> <span class="attribute">requirePermission</span>=<span class="value">"false"</span> /&gt;</span>
<span class="tag">&lt;/<span class="title">sectionGroup</span>&gt;</span></code></pre>
<p>This section is actually defined in the Umbraco Web.config for Razor support so declaring it a second time will result in an error.</p>
<p><strong>Change #2</strong></p>
<p>As I said I&#39;m using MVC 4.0 here which also uses Razor 2.0 and because of this we need to convert Umbraco up to Razor 2.0. So you&#39;ll need to identify the above mentioned config section in the Umbraco web.config and change the <code>Version=1.0.0.0</code> to <code>Version=2.0.0.0</code>.</p>
<h1>Done!</h1>
<p>Yep with that all completed you&#39;re done, you can now route to your MVC application side-by-side with your Umbraco CMS pages.</p>
<h1>Conclusion</h1>
<p>So over the course of this blog post we&#39;ve looked at how you can get a MVC application working along with an Umbraco CMS in the same IIS/ website. There&#39;s a few things to remember:</p>
<ul>
<li>We&#39;re using MVC for the application side of our website only</li>
<li>Umbraco is still handling all the content pages and you have to use traditional Umbraco practices (you know, like Razor!)</li>
<li>You don&#39;t have Umbraco content on the MVC pages <em>but</em> you have the Umbraco API so you could always do calls to get editor data</li>
<li>This was a proof-of-concept, implement it at your own risk</li>
</ul>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/umbraco/using-mvc-in-umbraco-4';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
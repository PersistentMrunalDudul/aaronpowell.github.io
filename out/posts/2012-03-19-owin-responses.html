<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>OWIN Responses - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">OWIN Responses</h1>
                <h2>19th March 2012</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/owin.html"><span>owin</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th January 2013</span>
                            <h3><a href="/posts/2013-01-14-ie10-console-thoughts.html">Making the Internet Explorer JavaScript tools better, again</a></h3>
                        </header>
                        <p>A look at what&#39;s changed since I last pointed out the failings of the IE dev tools</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web-dev.html"><span>web-dev</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">18th October 2012</span>
                            <h3><a href="/posts/2012-10-18-dbjs-chrome.html">Chrome support for db.js</a></h3>
                        </header>
                        <p>A little word on the db.js support for Chrome</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/chrome.html"><span>chrome</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">8th October 2012</span>
                            <h3><a href="/posts/2012-10-08-reverse-order-unique-indexes.html">Reverse order unique queries in IndexedDB</a></h3>
                        </header>
                        <p>The quirk of reverse index querying in IndexedDB and in turn db.js</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In the last post we looked at <a href="http://www.aaron-powell.com/web/owin-routing">Routing in OWIN</a> as we built up a simple little route engine. Today I want to look at how to bring power to our responses by making it easier to respond with different types.</p>
<p>In ASP.Net MVC you&#39;re probabily use to write code like this:</p>
<pre class="highlighted"><code class="nginx"><span class="title">public</span> ActionResult Index() {
    <span class="title">return</span> Json(new { <span class="title">FirstName</span> = <span class="string">"Aaron"</span>, LastName = <span class="string">"Powell"</span> });
}</code></pre>
<p>Here our Action (which comes from our Route) is defining that we want to output JSON to the response and it gives us a nice way which we can do it. Let&#39;s see about adding something similar to our application.</p>
<h1>Responding with JSON</h1>
<p>We&#39;ll start with an easy task, we&#39;ll make it easier to respond with JSON. To do this there&#39;s two things which we need to do:</p>
<ul>
<li>Ensure the appropriate content type is set on the response</li>
<li>Put a value into the response that is valid JSON</li>
</ul>
<p>With those two requirements in mind we need to think about is just how we want the API to work, do we want an extension method on the <code>IAppBuilder</code> interface? If so how do we handle different request types, are we going to have a lot of boilerplate code to cover all that? Or maybe we should go with the <a href="http://nancyfx.org">Nancy</a> approach and have a return value from our delegate. At the moment our delegate just executes some code; well maybe we could have it return instead. This would be advantageous as it would be somewhat familiar to MVC developers.</p>
<p>But neither of these options are really ideal in my opinion as they require a lot of code to make them work. We&#39;d be constantly writing extension methods to handle this and when we get to another type (say XML) we&#39;d either have to create yet another extension method or ensure we have a viable base type that we can return (which is what <code>ActionResult</code> does for MVC). Admittedly this is may be a symptom of our design thus far, but keep in mind that this is more about exploring the various concepts without adding huge amounts of overhead.</p>
<p>So this leaves us with one final option, augment the <code>Response</code> object to have these methods on it. This is the approach I want to go with as it feels cleaner (and it&#39;s more familiar to me coming from <a href="http://expressjs.com/">Express.js</a>). Rather than super-classing the <code>Response</code> object which we already have (like we did with the <code>Request</code> object) I&#39;m going to stick with good ol&#39; fashioned extension methods. This makes it much easier to include the methods and also avoids having to change our delegate signatures (like we did when we introduced <code>RoutedRequest</code>) so we&#39;ll spin up a new class:</p>
<pre class="highlighted"><code class="actionscript"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteExtensions</span> 
{</span>
    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Json(<span class="keyword">this</span> Response res, <span class="keyword">dynamic</span> obj, bool useJavaScriptNaming = <span class="literal">true</span>)
    {
        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
    }
}</code></pre>
<p>This is the basis for our extension method, I&#39;m taking in two arguments, one of which is optional. The <em>main</em> argument, <code>obj</code> will represent the value which we want to serialize and send down to the client. I&#39;m also having an optional boolean argument (defaulted to true) which will indicate whether we want to use JavaScript naming conventions (more on that in a second).</p>
<p>For the serialization we&#39;re going to be using the <a href="http://json.codeplex.com/">JSON.Net</a> serializer as it really is awesome.</p>
<p>The first things we want to do in our extension method are setting the content type and status code (since we can assume here that it&#39;ll be successful by this being called; you could pass in the status code if you wanted but for simplicities sake we&#39;ll hard code it):</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Json(<span class="keyword">this</span> Response res, <span class="keyword">dynamic</span> obj, <span class="keyword">bool</span> useJavaScriptNaming = <span class="literal">true</span>)
{
    res<span class="variable">.ContentType</span> = <span class="string">"application/json"</span>;
    res<span class="variable">.Status</span> = <span class="string">"200 OK"</span>;

       <span class="keyword">throw</span> new NotImplementedException();
}</code></pre>
<p>Lovely, now to think about serialization. As I said I&#39;m going to use JSON.Net and the reason I&#39;m having the optional boolean argument is because .NET naming conventions are different to JavaScript (.NET uses PascalCase where as JavaScript is all about camelCase) so I want to force the conversion myself but allow people to opt-out of it if they want (which is something we&#39;ve needed on the project I&#39;m on at the moment). Luckily JSON.Net allows us to do this very easily:</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Json(<span class="keyword">this</span> Response res, <span class="keyword">dynamic</span> obj, <span class="keyword">bool</span> useJavaScriptNaming = <span class="literal">true</span>)
{
    res<span class="variable">.ContentType</span> = <span class="string">"application/json"</span>;
    res<span class="variable">.Status</span> = <span class="string">"200 OK"</span>;

    var serializer = new JsonSerializer();

    <span class="keyword">if</span> (useJavaScriptNaming)
        serializer<span class="variable">.ContractResolver</span> = new CamelCasePropertyNamesContractResolver();

    res<span class="variable">.End</span>(JObject<span class="variable">.FromObject</span>(obj, serializer)<span class="variable">.ToString</span>());
}</code></pre>
<p>See, quite easy. We start by creating a serializer, check the boolean argument and add a contract resolver of <code>CamelCasePropertyNamesContractResolver</code> if we want to do JavaScript naming and finish off by ending the response with a serialized object.</p>
<p><em>There may be an easier way to do this, I&#39;m hardly a JSON.Net expert this is just the way I&#39;ve come across doing it and it works fine for my needs.</em></p>
<h1>Sending out JSON</h1>
<p>Once importing the namespace for our extension methods we can get cracking on using it:</p>
<pre class="highlighted"><code class="avrasm">builder<span class="preprocessor">.Get</span>(<span class="string">"/json"</span>, (req, res) =&gt; {
    res<span class="preprocessor">.Json</span>(new { FirstName = <span class="string">"Aaron"</span>, LastName = <span class="string">"Powell"</span> })<span class="comment">;</span>
})<span class="comment">;</span></code></pre>
<p>Yeah it&#39;s just that simple! And since this is all within the scope of the request you can access any of the properties you have on your request (such as your named arguments) and work them into the response:</p>
<pre class="highlighted"><code class="avrasm">builder<span class="preprocessor">.Get</span>(<span class="string">"/json/:name"</span>, (req, res) =&gt; {
    res<span class="preprocessor">.Json</span>(new { Name = req<span class="preprocessor">.UrlSegments</span><span class="preprocessor">.name</span> })<span class="comment">;</span>
})<span class="comment">;</span></code></pre>
<h1>Conclusion</h1>
<p>So this wraps up a quick look at how we can start enriching our responses by adding different response types. Using the method described above you could easily create methods to return text, XML, or even a VCard, basically anything you want from your application.</p>
<p>It&#39;s all starting to come together nicely but there&#39;s something quite important missing... HTML. In our next instalment we&#39;ll look at producing a View Engine to respond with HTML.</p>
<p>As always you can check out the full code up on the <a href="https://github.com/aaronpowell/Owin.HelloWorld">GitHub repository</a>.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/web/owin-responses';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
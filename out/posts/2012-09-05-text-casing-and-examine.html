<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Text casing and Examine - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Text casing and Examine</h1>
                <h2>5th September 2012</h2>
                <ul class="tags">
    
        
            <li><a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a></li>
        
            <li><a class="icon icon-tag" href="/tagged/examine.html"><span>examine</span></a></li>
        
            <li><a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a></li>
        
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">11th July 2012</span>
                            <h3><a href="/posts/2012-07-11-using-mvc-in-umbraco-4-revisited.html">Revisiting using ASP.NET MVC in Umbraco 4</a></h3>
                        </header>
                        <p>An update on using ASP.NET MVC with Umbraco 4.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">25th June 2012</span>
                            <h3><a href="/posts/2012-06-25-i-helped-kill-umbraco-5.html">I helped kill Umbraco 5</a></h3>
                        </header>
                        <p>Hi, my name&#39;s Aaron Powell and I was involved in killing Umbraco 5.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-5.html"><span>umbraco-5</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/opinionated.html"><span>opinionated</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">13th June 2012</span>
                            <h3><a href="/posts/2012-06-13-introducing-umbraco-contributor-list.html">Introducing the Umbraco contributor mailing list</a></h3>
                        </header>
                        <p>Keen discuss contributing to Umbraco&#39;s core, join the discussion now!</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">12th June 2012</span>
                            <h3><a href="/posts/2012-06-12-using-mvc-in-umbraco-4.html">Using ASP.NET MVC in Umbraco 4</a></h3>
                        </header>
                        <p>How to combine ASP.Net MVC applications with an Umbraco project</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">25th January 2012</span>
                            <h3><a href="/posts/2012-01-25-macros-in-packages.html">Macros in packages</a></h3>
                        </header>
                        <p>Wanting to include a Macro in your v5 package, where do you start?</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbaco.html"><span>umbaco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-5.html"><span>umbraco-5</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>A few times I&#39;ve seen questions posted on the Umbraco forums which ask how to deal with case insensitivity text with Examine, and it’s also something that we&#39;ve had to handle a few times within our own company.</p>
<p>Here&#39;s a scenario:</p>
<ul>
<li>You have a site search</li>
<li>You use examine</li>
<li>You want to show the results looking exactly the same as it was before it went into Examine</li>
</ul>
<p>If you&#39;re running a standard install you’ll notice that the content always ends up lowercased!</p>
<p>This is a bit of a problem, page titles will be lowercase, body content will be lowercase, etc. Part of this will be due to a mistake in Examine, part of it is due to the design of Lucene.</p>
<p>In this article I’ll have a look at what you need to do to make it work as you&#39;d expect.</p>
<h2>First, some background</h2>
<p>Before we dive directly into what to do to fix it you really should understand what is happening. If you don&#39;t care feel free to skip over this bit though :P.</p>
<p>Searching is a tricky thing, and when searching the statement <code>Examine == examine == false</code>; To get around this searching is best done in a case insensitive manner. To make this work Examine did a forced lowercase of the content before it was pushed into Lucene.Net. This was to ensure that everything was exactly the same when it was searched against. 
In hindsight this is not really a great idea, it really should be the responsibility of the Lucene Analyzer to handle this for you.</p>
<p>Many of the common Lucene.Net analyzers actually do automatic lowercasing of content, these analysers are:</p>
<ul>
<li>StandardAnalyzer</li>
<li>StopAnalyzer</li>
<li>SimpleAnalyzer</li>
</ul>
<p>So if you&#39;re using the standard Examine config you&#39;ll find yourself using the StandardAnalyzer and still have your content lowercased.</p>
<p>This means that there&#39;s no need to Lucene to concern itself about case sensitivity when searching, everything is parsed by the analyzer (field terms and queries) and you&#39;ll get more matches.</p>
<h2>So how do I get around this?</h2>
<p>Now that we&#39;ve seen why all your content is generally lower case, how can we work with it in the original format and display it back to the UI?</p>
<p>Well we need some way in which we can have the field data stored without the analyzer screwing around with it.</p>
<p><em>Note: This doesn&#39;t need to be done if you&#39;re using an analyzer which doesn&#39;t have a <code>LowerCaseTokenizer</code> or <code>LowercaseFilter</code>. If you’re using a different analyzer, like <code>KeywordAnalyzer</code> then this post wont cover what you&#39;re after (since the <code>KeywordAnalyzer</code> isn&#39;t lowercasing, you&#39;re actually using an out-dated version of Examine, I recommend you grab the latest release :)). More information on Analyzers can be found at <a href="http://www.aaron-powell.com/lucene-analyzer"><a href="http://www.aaron-powell.com/lucene-analyzer">http://www.aaron-powell.com/lucene-analyzer</a></a></em></p>
<p>Luckily we&#39;ve got some hooks into Examine to allow us to do what we need here, it&#39;s in the form of an event on the <code>Examine.LuceneEngine.Providers.LuceneIndexer</code>, called <code>DocumentWriting</code>. Note that this event is on the <code>LuceneIndexer</code>, not the <code>BaseIndexProvider</code>. This event is Lucene.Net specific and not logical on the base class which is agnostic of any other framework.</p>
<p>What we can do with this event is interact directly with Lucene.Net while Examine is working with it. 
You&#39;ll need to have a bit of an understanding of how to work with a Lucene.Net Document (and for that I’d recommend having a read of this article from me: <a href="http://www.aaron-powell.com/documents-in-lucene-net"><a href="http://www.aaron-powell.com/documents-in-lucene-net">http://www.aaron-powell.com/documents-in-lucene-net</a></a>), cuz what you’re able to do is play with Lucene.Net... Feel the power!</p>
<p>So we can attach the event handler the same way as you would do any other event in Umbraco, using an Action Handler:</p>
<pre class="highlighted"><code class="python">public <span class="class"><span class="keyword">class</span> <span class="title">UmbracoEvents</span> :</span> ApplicationBase
{
        public UmbracoEvents()
        {
            var indexer = (LuceneIndexer)ExamineManager.Instance.IndexProviderCollection[<span class="string">"DefaultIndexer"</span>];

            indexer.DocumentWriting +=new System.EventHandler(indexer_DocumentWriting);
        }
}</code></pre>
<p>To do this we&#39;ve got to cast the indexer so we&#39;ve got the Lucene version to work with, then we’re attaching to our event handler. Let’s have a look at the event handler</p>
<pre class="highlighted"><code class="applescript">void indexer_DocumentWriting(object sender, DocumentWritingEventArgs e)
{
        //grab out lucene document <span class="keyword">from</span> <span class="keyword">the</span> event arguments
        var doc = e.Document;

        //<span class="keyword">the</span> e.Fields dictionary <span class="keyword">is</span> all <span class="keyword">the</span> fields which are <span class="keyword">about</span> <span class="keyword">to</span> be inserted <span class="keyword">into</span> Lucene.Net
        //we'll grab out <span class="keyword">the</span> <span class="string">"bodyContent"</span> one, <span class="keyword">if</span> there <span class="keyword">is</span> one <span class="keyword">to</span> be indexed
        <span class="keyword">if</span>(e.Fields.ContainsKey(<span class="string">"bodyContent"</span>)) 
        {
                <span class="type">string</span> content = e.Fields[<span class="string">"bodyContent"</span>];
                //Give <span class="keyword">the</span> field a <span class="property">name</span> which you'll be able <span class="keyword">to</span> easily remember
                //also, we're telling Lucene <span class="keyword">to</span> just <span class="keyword">put</span> this data <span class="keyword">in</span>, nothing more
                doc.Add(new Field(<span class="string">"__bodyContent"</span>, content, Field.Store.YES, Field.Index.NOT_ANALYZED));
        }
}</code></pre>
<p>And that’s how you can push data in. I&#39;d recommend that you do a conditional check to ensure that the property you’re looking for does exist in the Fields property of the event args, unless you&#39;re 100% sure that it appears on all the objects which you’re indexing.</p>
<p>Lastly we need to display that on the UI, well it&#39;s easy, rather accessing the <code>bodyContent</code> property of the <code>SearchResults</code>, use the <code>__bodyContent</code> and you’ll get your unanalyzed version.</p>
<h2>Conclusion</h2>
<p>Here we&#39;ve looked at how we can use the Examine events to interact with the Lucene.Net Document. We’ve decided that we want to push in unanalyzed text, but you could use this idea to really tweak your Lucene.Net document. But really playing with the Document is not recommended unless you <em>really</em> know what you’re doing ;).</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/text-casing-and-examine';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
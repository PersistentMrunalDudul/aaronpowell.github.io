<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Reflection And Generics - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Reflection And Generics</h1>
                <h2>8th April 2010</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/reflection.html"><span>reflection</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/searing-pain.html"><span>searing-pain</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">25th April 2010</span>
                            <h3><a href="/posts/2010-04-25-why-does-this-code-work.html">Why does this code work?</a></h3>
                        </header>
                        <p>A neat trick with operators in .NET</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/operator-overload.html"><span>operator-overload</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">30th March 2011</span>
                            <h3><a href="/posts/2011-03-30-binding.html">Fun with Expression Trees and property binding</a></h3>
                        </header>
                        <p>The client I&#39;m currently working for is using an MVP pattern with WebForms (not [WebFormsMVP][1] but an internally developed one) which is using an active view pattern. What this means is that the ...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-4.html"><span>c#-4</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/expression-tree-fun.html"><span>expression-tree-fun</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">28th August 2010</span>
                            <h3><a href="/posts/2010-08-28-a-linq-observation.html">A LINQ observation</a></h3>
                        </header>
                        <p>Well I&#39;m making good headway with LINQ to Umbraco, in the next few days I&#39;ll be doing a very interesting check in (which I&#39;ll also blog here about). My tweet-peeps already have an idea of what it e...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/linq.html"><span>linq</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2010</span>
                            <h3><a href="/posts/2010-07-05-dynamics-library.html">Dynamics Library</a></h3>
                        </header>
                        <p>A series of helper methods for working with the DLR in C# 4.0</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/dynamic.html"><span>dynamic</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">28th June 2010</span>
                            <h3><a href="/posts/2010-06-28-dynamic-dictionaries-with-csharp-4.html">Dynamic Dictionaries with C# 4.0</a></h3>
                        </header>
                        <p>Using the C# dynamic features to make it easier to work with Dictionary objects</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/dynamic.html"><span>dynamic</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>Or to name this another way… <strong>Oh my god the pain</strong>.</p>
<p>Anyone who’s been brave enough to delve into the bowels of the Umbraco Interaction Layer will have been able to see just how much Reflection I’m using, for those who haven’t think about this.
With the UIL I needed a way to find all the properties of a generated class and be able to either populate all of them or save from all of them. To do that I’ve got some custom attributes which decorate the properties which I look out for.</p>
<p>Now this in itself isn’t a problem, all my properties are strongly typed, it’s all sweet. The problem was around the populating of the data when you open an existing Umbraco document object. I have two generic methods in my Helper library (which have many an appearance in my Umbraco Membership class too!) which have the construct:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">static</span> T GetPropertyValue&lt;T&gt;(Document doc, <span class="keyword">string</span> key);
<span class="keyword">public</span> <span class="keyword">static</span> T GetPropertyValue&lt;T&gt;(Document doc, <span class="keyword">string</span> key, T defaultValue);</code></pre>
<p>ou’ll notice that one is an overload, and the overload parameter is a generic. This is where the problem arises.</p>
<p>Because the generic is defined at use-time there’s no type in the .NET framework which can represent something as a generic like you can with an Int32 or a String, and this is where the problem arises, how do you find the overloaded method using reflection, and once it’s found how do you invoke it!?</p>
<h2>First things first, finding the method</h2>
<p>There’s no simple way in which you do this, in fact, it’s actually rather hacky. If you’re not familiar with finding methods with Reflection you should probably have a read of this <a href="http://msdn.microsoft.com/en-us/library/system.reflection.aspx"><a href="http://msdn.microsoft.com/en-us/library/system.reflection.aspx">http://msdn.microsoft.com/en-us/library/system.reflection.aspx</a></a>.</p>
<p>You’d be mistaken for thinking that you can just pass in the method name, cuz it’s an overload Reflection doesn’t know what you want. So the most likely one you need is <a href="">Type.GetMethod Method (String, BindingFlags, Binder, array[]()[], array[\</a>[])]<a href="http://msdn.microsoft.com/en-us/library/5fed8f59.aspx">2</a>, but you notice something, you need to pass in the type of ALL the parameters for the method.
Crap, one is a generic type, so it can’t be specified!
This is where I hit a snag, and from all my research the only solution was a dirty little hack.</p>
<p>We know what’s different between the two methods, one has two parameters, the other has three, and this is how we’re going to find the sucker. On the Type class there’s another method, Type.GetMethods() or as I prefer to use (to improve performance) Type.GetMethods(BindingFlags bindingAttr). This will get you an array of methods with the right access levels.</p>
<p>Now let’s pull out our old friend LINQ and find the sucker in the array, we end up with something like this:</p>
<pre class="highlighted"><code class="haskell"><span class="type">MethodInfo</span> method = <span class="typedef">typeof<span class="container">(<span class="type">Helper</span>)</span>.<span class="type">GetMethods</span><span class="container">(<span class="type">BindingFlags</span>.<span class="type">Public</span> | <span class="type">BindingFlags</span>.<span class="type">Static</span>)</span>.<span class="type">First</span><span class="container">(<span class="title">m</span> =&gt; <span class="title">m</span>.<span class="type">Name</span> == "<span class="type">GetPropertyValue</span>" &amp;&amp; <span class="title">m</span>.<span class="type">GetParameters</span>()</span>.<span class="type">Count</span><span class="container">()</span> == 3);</span></code></pre>
<h2>Invoking the method</h2>
<p>Ok, so we found the method but how do we invoke it if it’s generic? That’s actually quite easy:</p>
<pre class="highlighted"><code class="haskell"><span class="title">int</span> methodResult = (int)method.<span class="type">MakeGenericMethod</span>(<span class="typedef">typeof<span class="container">(<span class="title">int</span>)</span>).<span class="type">Invoke</span><span class="container">(<span class="title">null</span>, <span class="title">new</span> <span class="title">object</span>[] { <span class="title">doc</span>, “<span class="type">SomeAlias</span>” })</span>; </span></code></pre>
<p>So I make a generic instance of the method using a specified type as the generic type and then invoke it! This is the best and most optimised solution I’ve been able to come up with so far, if anyone can think of something better I’d love to hear it!</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/reflection-and-generics';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
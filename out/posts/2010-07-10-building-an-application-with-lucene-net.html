<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Building an application with Lucene.Net | LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Building an application with Lucene.Net</h1>
                <h2>10th July 2010</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/lucene.html"><span>lucene</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">27th May 2010</span>
                            <h3><a href="/posts/2010-05-27-lucene-analyzer.html">Analyzers in Lucene.Net</a></h3>
                        </header>
                        <h2>What is an Analyzer?</h2>
<p>When you want to insert data into a Lucene index, or when you want to get the data back out of the index you will need to use an Analyzer to do this.</p>
<p>Lucene ships with ma...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/examine.html"><span>examine</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-examine.html"><span>umbraco-examine</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">24th September 2012</span>
                            <h3><a href="/posts/2012-09-24-check-if-file-exists.html">How to check if a file exists in Windows 8</a></h3>
                        </header>
                        <p>Ever wondered how to check if a file exists in Windows 8?</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/windows8.html"><span>windows8</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/winjs.html"><span>winjs</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/winrt.html"><span>winrt</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">28th August 2010</span>
                            <h3><a href="/posts/2010-08-28-testable-email-sending.html">Testable email sending</a></h3>
                        </header>
                        <p>Creating an integration test of sending an email</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/testing.html"><span>testing</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2010</span>
                            <h3><a href="/posts/2010-07-05-dynamics-library.html">Dynamics Library</a></h3>
                        </header>
                        <p>A series of helper methods for working with the DLR in C# 4.0</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/dynamic.html"><span>dynamic</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">3rd July 2010</span>
                            <h3><a href="/posts/2010-07-03-documents-in-lucene-net.html">Documents in Lucene.Net</a></h3>
                        </header>
                        <p>As you&#39;re most likely already aware Lucene.Net is a Document Database, which means that it&#39;s essentially a key/ value store, with the crux of the interaction through <em>Documents</em></p>
<h2>But what is a Do...</h2>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>For this article we&#39;re going to go through building a small application with uses Lucene.Net as a storage model. I read a lot of blogs so I&#39;m often find that when I&#39;m working I want to refer back to a blog that I read in the past. The problem is that finding that particular blog can be tricky, navigating through a few thousand posts can be fairly tedious. So let&#39;s build an application which we can quickly search and find the posts that I&#39;m interested in.</p>
<h2>Designing for Lucene</h2>
<p>Although Lucene is a Document Database it&#39;s also a search engine. This means that Lucene can actually be used as a mid-point in the application you&#39;re designing. This can be used to turn our data for the UI without having to go to your underlying data store. This <em>can</em> provide speed boosts (and generally does) if you&#39;re using Lucene well.</p>
<h2>To Store or not to Store...</h2>
<p>So I&#39;m wanting a way which I can quickly find blogs which are matching particular search terms, but I want it to be fast and I want it to be small. The blog posts are available on the web, so I can access them if/ when I need, but do I really need to have my application showing all the data too? I don&#39;t think so, it would mean that my application needs to act a bit like a web browser, and this seems to be a bit silly. It also adds a dependency which I don&#39;t really want in my application.</p>
<p>Well this means that I don&#39;t really need to store much data at all, I just need to store the indexes! Now all I need to work out is what I want to show on my UI.</p>
<p>I&#39;ve decided that I want only a very basic little UI, I just want to have a link to the article and the name of it. This means that I can save some space by not storing the content of the blog post in my index, after all, if you want to read the content you&#39;re going out to the web.</p>
<p>This kind of split approach with Lucene is a common way to use Lucene. When working with Lucene the most performance intensive part of the process is actually getting the data back out of the index. Searching against Lucene is really fast, it&#39;s what Lucene is designed for. So we have Lucene to mainly just store our analyzed version of our data, and then we have our underlying data store to retrieve all of the data.</p>
<h2>Building the BlogManager</h2>
<p>I&#39;m going to be making this little application using WPF (yep, the web developer is trying WPF, and it&#39;s going... ok :P). First off I want a way to add RSS feeds to be able to search against:</p>
<p><img src="/get/csharp/blogmanager/blogmanager001.PNG" alt=""></p>
<p>So there we go, we&#39;re able to provide the URL for a blog and we&#39;re going to push some data into our index. I&#39;m actually using Lucene to store the URL&#39;s as well as the actual blogs to search against. Remember that a Document Database doesn&#39;t have a schema, so you can stick anything in there that you want. Let&#39;s see some code:</p>
<pre class="highlighted"><code class="avrasm">public MainWindow()
{
    InitializeComponent()<span class="comment">;</span>

    var path = new DirectoryInfo(Path<span class="preprocessor">.Combine</span>(new FileInfo(Assembly<span class="preprocessor">.GetExecutingAssembly</span>()<span class="preprocessor">.Location</span>)<span class="preprocessor">.Directory</span><span class="preprocessor">.FullName</span>, <span class="string">"LuceneIndex"</span>))<span class="comment">;</span>
    if (!path<span class="preprocessor">.Exists</span>)
    {
        path<span class="preprocessor">.Create</span>()<span class="comment">;</span>
        path<span class="preprocessor">.Refresh</span>()<span class="comment">;</span>
    }

    this<span class="preprocessor">.directory</span> = new SimpleFSDirectory(path)<span class="comment">;</span>
    this<span class="preprocessor">.analyzer</span> = new StandardAnalyzer(Lucene<span class="preprocessor">.Net</span><span class="preprocessor">.Util</span><span class="preprocessor">.Version</span><span class="preprocessor">.LUCENE</span>_29)<span class="comment">;</span>
    this<span class="preprocessor">.writer</span> = new IndexWriter(directory, analyzer, IndexWriter<span class="preprocessor">.MaxFieldLength</span><span class="preprocessor">.UNLIMITED</span>)<span class="comment">;</span>
    this<span class="preprocessor">.searcher</span> = new IndexSearcher(directory, true)<span class="comment">;</span>
}</code></pre>
<p>This is just my setup method, and I&#39;m setting up a few default objects which I want to persist within my application. I&#39;m using the <a href="http://lucene.apache.org/java/2_9_2/api/all/org/apache/lucene/analysis/standard/StandardAnalyzer.html">StandardAnalyzer</a> (<a href="/lucene-analyzer">here&#39;s more info on analyzers</a>) and the <a href="http://lucene.apache.org/java/2_9_2/api/all/index.html?org/apache/lucene/store/SimpleFSDirectory.html">SimpleFSDirectory</a> as my storage model. It&#39;s all just setup, not very interesting code, but it can&#39;t hurt to show you this stuff :P.</p>
<p>To get the data from the feed I&#39;m using the <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.syndication.syndicationfeed.aspx">SyndicationFeed</a> from the .NET framework, but you could parse the XML yourself, or use any other library if you really wanted, but this done a good enough job for what I need. You just use it like this:</p>
<pre class="highlighted"><code class="sql">XmlReader xmlReader = XmlReader.<span class="operator"><span class="keyword">Create</span>(url);</span>
var feed = SyndicationFeed.<span class="operator"><span class="keyword">Load</span>(xmlReader);</span></code></pre>
<p>Now lets put our data into the index:</p>
<pre class="highlighted"><code class="avrasm">var doc = new Document()<span class="comment">;</span>
doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"name"</span>, feed<span class="preprocessor">.Title</span><span class="preprocessor">.Text</span>, Field<span class="preprocessor">.Store</span><span class="preprocessor">.YES</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.NO</span>))<span class="comment">;</span>
doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"url"</span>, url, Field<span class="preprocessor">.Store</span><span class="preprocessor">.YES</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.NO</span>))<span class="comment">;</span>
doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"type"</span>, <span class="string">"BlogUrl"</span>, Field<span class="preprocessor">.Store</span><span class="preprocessor">.NO</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.ANALYZED</span>))<span class="comment">;</span>

writer<span class="preprocessor">.AddDocument</span>(doc)<span class="comment">;</span></code></pre>
<p>For this I&#39;m storing the title of the feed and the URL of it, this is because I&#39;m wanting to show them in a data grid (so I can get an overview of what feeds I&#39;m indexing). And since I don&#39;t want to be searching this data I&#39;m leaving it unindexed. But so I can easily find this data I&#39;m adding a meta-data property, in the form of the <code>type</code> field. This is something that is just meta data, so I don&#39;t want to display it, but I do need to be able to search on it. That&#39;s why I&#39;m leaving it unstored and analyzed. Lastly I add this to my <code>IndexWriter</code> instance and we&#39;re nearly done.</p>
<p>Next we need to push in the blogs which we&#39;ve found from here:</p>
<pre class="highlighted"><code class="avrasm">foreach (var item <span class="keyword">in</span> feed<span class="preprocessor">.Items</span>)
{
    doc = new Document()<span class="comment">;</span>
    doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"title"</span>, item<span class="preprocessor">.Title</span><span class="preprocessor">.Text</span>, Field<span class="preprocessor">.Store</span><span class="preprocessor">.YES</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.ANALYZED</span>))<span class="comment">;</span>
    doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"content"</span>, StripHtml(item<span class="preprocessor">.Summary</span><span class="preprocessor">.Text</span>), Field<span class="preprocessor">.Store</span><span class="preprocessor">.NO</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.ANALYZED</span>))<span class="comment">;</span>
    doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"categories"</span>, string<span class="preprocessor">.Join</span>(<span class="string">" "</span>, item<span class="preprocessor">.Categories</span><span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Name</span>)), Field<span class="preprocessor">.Store</span><span class="preprocessor">.NO</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.ANALYZED</span>))<span class="comment">;</span>
    doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"url"</span>, item<span class="preprocessor">.Links</span><span class="preprocessor">.First</span>()<span class="preprocessor">.Uri</span><span class="preprocessor">.ToString</span>(), Field<span class="preprocessor">.Store</span><span class="preprocessor">.YES</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.NO</span>))<span class="comment">;</span>
    doc<span class="preprocessor">.Add</span>(new Field(<span class="string">"type"</span>, <span class="string">"BlogPost"</span>, Field<span class="preprocessor">.Store</span><span class="preprocessor">.NO</span>, Field<span class="preprocessor">.Index</span><span class="preprocessor">.ANALYZED</span>))<span class="comment">;</span>

    writer<span class="preprocessor">.AddDocument</span>(doc)<span class="comment">;</span>
}</code></pre>
<p>Here is pretty much the same as what we had previously, we&#39;re just grabbing some properties and then putting them into the Document which is then written to the index. I&#39;m setting a no-store on the content of the post and it&#39;s categories since these are just things that I&#39;m going to be searching against, but not ever showing it on the UI.</p>
<p>Now we just do a commit to our index:</p>
<pre class="highlighted"><code class="sql">writer.<span class="operator"><span class="keyword">Commit</span>();</span></code></pre>
<p>Our blog has been added into our index, woo! Now it&#39;ll be listed below in the data grid:</p>
<p><img src="/get/csharp/blogmanager/blogmanager002.PNG" alt=""></p>
<h2>Searching the blogs</h2>
<p>Now that we&#39;ve got some stuff in our index let&#39;s try and get at it. I&#39;ve got another awesome example of UI design for that:</p>
<p><img src="/get/csharp/blogmanager/blogmanager003.PNG" alt=""></p>
<p>Here I&#39;ve got a big text box which I can enter a Lucene query using the <a href="http://lucene.apache.org/java/2_3_2/queryparsersyntax.html">Lucene Query Parser Syntax</a> so I can just get at the data. Lets say that I want all the posts which had Umbraco in the title:</p>
<p><img src="/get/csharp/blogmanager/blogmanager004.PNG" alt=""></p>
<p>Or maybe I&#39;ll get all the ones which contain Umbraco or Lucene.Net:</p>
<p><img src="/get/csharp/blogmanager/blogmanager005.PNG" alt=""></p>
<p>And here&#39;s the underlying code:</p>
<pre class="highlighted"><code class="avrasm">var queryParser = new MultiFieldQueryParser(Version<span class="preprocessor">.LUCENE</span>_29, new[] { <span class="string">"title"</span>, <span class="string">"content"</span>, <span class="string">"categories"</span>, <span class="string">"type"</span> }, analyzer)<span class="comment">;</span>
var query = new BooleanQuery()<span class="comment">;</span>
query<span class="preprocessor">.Add</span>(queryParser<span class="preprocessor">.Parse</span>(this<span class="preprocessor">.QueryText</span><span class="preprocessor">.Text</span>), BooleanClause<span class="preprocessor">.Occur</span><span class="preprocessor">.MUST</span>)<span class="comment">;</span>
query<span class="preprocessor">.Add</span>(queryParser<span class="preprocessor">.GetFieldQuery</span>(<span class="string">"type"</span>, <span class="string">"blogpost"</span>), BooleanClause<span class="preprocessor">.Occur</span><span class="preprocessor">.MUST</span>)<span class="comment">;</span>

var results = searcher<span class="preprocessor">.Search</span>(query, null, searcher<span class="preprocessor">.MaxDoc</span>())<span class="comment">;</span></code></pre>
<p>It&#39;s quite simple actually, I&#39;m creating a <code>[MultiFieldQueryParser][11]</code> since the user may be searching across multiple different fields in the index. I&#39;m specifying the fields which I defined earlier then taking the text which the user entered and parsing that into a <code>Query</code> object. I&#39;m also doing a addition of the <em>type</em> field, so the actual query that you&#39;ll end up with actually looks like this:</p>
<pre class="highlighted"><code class="brainfuck"><span class="literal">+</span><span class="comment">(title:umbraco)</span> <span class="literal">+</span><span class="comment">type:blogpost</code></pre>
<p>I&#39;m actually wrapping any query the user puts in so that I can postfix the type query but not override anything that they are supplying (ie - any OR conditionals will be cancelled out if the AND for the type is used).</p>
<p>I&#39;m not supporting paging in the datagrid so I&#39;m just getting back all the results. <strong>This is not recommended</strong> as it will put a lot more strain on the Lucene index than is really needed. You should only request the number of documents you actually require.</p>
<p>And all that&#39;s left is to hydrate the entities:</p>
<pre class="highlighted"><code class="avrasm">results<span class="preprocessor">.scoreDocs</span><span class="preprocessor">.Select</span>(<span class="built_in">x</span> =&gt;
{
    var doc = searcher<span class="preprocessor">.Doc</span>(<span class="built_in">x</span><span class="preprocessor">.doc</span>)<span class="comment">;</span>
    return new
    {
        Title = doc<span class="preprocessor">.Get</span>(<span class="string">"title"</span>),
        Url = doc<span class="preprocessor">.Get</span>(<span class="string">"url"</span>),
        Score = <span class="built_in">x</span><span class="preprocessor">.score</span>
    }<span class="comment">;</span>
})<span class="comment">;</span></code></pre>
<p>Then you can push that onto your UI to get the lovely results we saw earlier.</p>
<h2>Conclusion</h2>
<p>This is a very quick look at how you can use Lucene.Net to make an application that actually works across multiple data stores. Here I&#39;m using a Lucene index for nothing but searching. I&#39;m pushing data into it but really the <em>end result</em> display is all handled by my other data store, web servers.</p>
<p>I&#39;ll publish the source code in a little while, along with a downloadable version of this application, but at the moment there&#39;s a few things I need to do, like updating the index as new posts are added and properly binding the data to the UI :P.</p>
<p>But hopefully this gives you a view at how you can use Lucene in your own applications.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/building-an-application-with-lucene-net';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
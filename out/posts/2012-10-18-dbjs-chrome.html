<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Chrome support for db.js - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Chrome support for db.js</h1>
                <h2>18th October 2012</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/chrome.html"><span>chrome</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">30th May 2013</span>
                            <h3><a href="/posts/2013-05-30-libraries.html">Flight Mode - Libraries</a></h3>
                        </header>
                        <p>Throughout the last few posts we&#39;ve looked at the different ways which we can store data offline in browsers and then created a basic little API that will help is with doing that. The <code>FlightMode</code> ...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/localStorage.html"><span>localStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/sessionStorage.html"><span>sessionStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">27th May 2013</span>
                            <h3><a href="/posts/2013-05-27-indexeddb.html">Flight Mode - IndexedDB</a></h3>
                        </header>
                        <p>The next stop in our offline storage adventure is to look at the big daddy of offline storage, <a href="http://www.w3.org/TR/IndexedDB/">IndexedDB</a>. Now I&#39;ve [blogged about <code>IndexedDB</code> in the past](http://...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th April 2013</span>
                            <h3><a href="/posts/2013-04-10-wdc13.html">IndexedDB at Web Directions Code 13</a></h3>
                        </header>
                        <p>Upcoming speaking on IndexedDB</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/speaking.html"><span>speaking</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>I recently had a <a href="https://github.com/aaronpowell/db.js/issues/14">bug opened</a> on <a href="https://github.com/aaronpowell/db.js">db.js</a> which is related to Chrome operating differently to the other browsers.</p>
<p>After spending some time digging into the problem I came to realise that the problem was to do with the way older versions of Google&#39;s Chrome implement IndexedDB (where older versions are any version prior to Chrome 23).</p>
<p>Prior to Chrome 23 Chrome didn&#39;t support the final specification for IndexedDB completely, in fact they were still implementing the spec from <a href="http://www.w3.org/TR/2011/WD-IndexedDB-20110419">April 2011</a> and the root of the problem was how changing database versions worked.</p>
<h1>TL; DR</h1>
<p>db.js will not be supporting Chrome 22 or lower, even if they have <code>webkitIndexedDB</code> defined.</p>
<h1>Longer story</h1>
<p>To understand the problem we need to understand what changed in the specification between April 2011 and today. The change that is causing the most problems is how IndexedDB handles new versions of each database. In case you missed it, when you open a database with db.js (or well just IndexedDB) you need to provide a version number for the schema. This is because a database can change across versions and IndexedDB allows you to maintain the old schema.</p>
<p>Initially the way version changes were handled was using a <a href="http://www.w3.org/TR/2011/WD-IndexedDB-20110419/#widl-IDBDatabase-setVersion"><code>setVersion</code></a> method, like so:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> req = indexedDB.open(<span class="string">'db'</span>);
req.onsuccess = success;
req.onerror = fail;

<span class="function"><span class="keyword">function</span> <span class="title">success</span><span class="params">(e)</span> {</span>
    <span class="keyword">var</span> db = e.target.result;
    <span class="keyword">var</span> req = db.setVersion(<span class="string">"1"</span>);
    req.onsuccess = createSchema;
    req.onerror = fail;
}

<span class="function"><span class="keyword">function</span> <span class="title">createSchema</span><span class="params">(e)</span> {</span>
    <span class="comment">//create schema</span>
}</code></pre>
<p>The problem is that this was changed, instead of using this method to change a schema version it was added to the <code>open</code> call and is used in conjunction with a <a href="http://www.w3.org/TR/IndexedDB/#widl-IDBOpenDBRequest-onupgradeneeded"><code>onupgradeneeded</code></a> event off the request, like so:</p>
<pre class="highlighted"><code class="haskell"><span class="title">var</span> req = indexedDB.open('db', <span class="number">1</span>);
<span class="title">req</span>.onupgradeneeded = createSchema;
<span class="title">req</span>.onsuccess = success;
<span class="title">req</span>.onerror = fail;</code></pre>
<p>Personally I&#39;m quite glad that they made this change, I think it makes for a much cleaner API as you don&#39;t have nested database requests. But ultimately this was a very radical change to the way the API worked.</p>
<h2>The Chrome problem</h2>
<p>Chrome was the last browser to adopt this change, drilling down through the changeset history, issue history and mailing list archive it was apparent that the Chrome team was reluctant to just <em>drop</em> the support for <code>setVersion</code> like the other browsers because they were concerned about existing implementations and this is a fair enough justification, no one wants to introduce breaking changes.</p>
<p>The problem was there was no good way to tests for this change. Initially db.js <em>did</em> have attempted smarts as to how it will handle database version changes <em>but</em> the problem was that there was no way to detect for the existence of the <code>onupgradeneeded</code> event, only the <code>setVersion</code> method. Interestingly enough even through Chrome 23+ <em>does</em> support the <code>onupgradeneeded</code> it <strong>also</strong> has <code>setVersion</code>. As you can expect this added a lot more complexity to the code!</p>
<p>Ultimately what it came down to was it was overly complex to support <em>both</em> versioning methods, so I made the decision that any implementation that uses <code>setVersion</code> and not <code>onupgradeneeded</code> it won&#39;t work as in the time it would take to resolve the problems I was seeing Chrome 23 will make it to the stable channel.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/web/dbjs-chrome';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
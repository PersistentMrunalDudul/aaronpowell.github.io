<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>OWIN and View Engines, Part 2 - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">OWIN and View Engines, Part 2</h1>
                <h2>2nd April 2012</h2>
                <ul class="tags">
    
        
            <li><a class="icon icon-tag" href="/tagged/owin.html"><span>owin</span></a></li>
        
            <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
        
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th January 2013</span>
                            <h3><a href="/posts/2013-01-14-ie10-console-thoughts.html">Making the Internet Explorer JavaScript tools better, again</a></h3>
                        </header>
                        <p>A look at what&#39;s changed since I last pointed out the failings of the IE dev tools</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web-dev.html"><span>web-dev</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">18th October 2012</span>
                            <h3><a href="/posts/2012-10-18-dbjs-chrome.html">Chrome support for db.js</a></h3>
                        </header>
                        <p>A little word on the db.js support for Chrome</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/chrome.html"><span>chrome</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">8th October 2012</span>
                            <h3><a href="/posts/2012-10-08-reverse-order-unique-indexes.html">Reverse order unique queries in IndexedDB</a></h3>
                        </header>
                        <p>The quirk of reverse index querying in IndexedDB and in turn db.js</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In the last post we had a bit of a look at <a href="http://www.aaron-powell.com/web/owin-view-engines">View Engines for OWIN</a> and in this one I want to take the idea just a little bit further.</p>
<p>Most web frameworks you come across will allow you to choose your own View Engine. ASP.Net MVC allows for this (although it can be tricky) and frameworks like Express.js or Nancy make it quite easy to drop in your own one.</p>
<p>You may be wondering why you would want to do this? Apart from the &quot;because you can&quot; and &quot;freedom of choice&quot; reasons there is a slightly more valid reason. Most view engines while being generic often have a level of speciality to them; the developers who write it don&#39;t know about every scenario you&#39;d want to use it in. Let&#39;s say you&#39;re a Node.js programmer who has a love for CoffeeScript. You might want to use the <a href="http://coffeekup.org/">CoffeeKup</a> View Engine since it allows you to write in you <em>native</em> language (I don&#39;t want to debate the merits of this it&#39;s a valid scenario) but the problem with CoffeeKup is it can&#39;t do XML (at least the last time I used it it couldn&#39;t). This may not be really that big a deal for the majority of your application but what if you&#39;ve got an RSS feed? Well then you can&#39;t really expose that through your chosen View Engine so you&#39;d want for that specific route to be able to change to a different View Engine.</p>
<h1>Teasing out our View Engine</h1>
<p>The first step to making our View Engine more extensible is I&#39;m going to pull out an interface from the <code>RazorViewEngine</code> we have:</p>
<pre class="highlighted"><code class="vala"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IViewEngine</span>
{</span>
    <span class="keyword">string</span> Parse(<span class="keyword">string</span> viewName);
    <span class="keyword">string</span> Parse&lt;T&gt;(<span class="keyword">string</span> viewName,<span class="constant"> T </span>model);
}</code></pre>
<p>Now I would just have to implement that interface to create a View Engine and not take a dependency on Razor at all.</p>
<p>You obviously want to update the other references to <code>RazorViewEngine</code> to just be the interface, such as on our singleton and generic argument constraints. Now everywhere we&#39;ll just deal with the interface and never the concrete class.</p>
<h1>Enabling multiple View Engines</h1>
<p>Essentially what we&#39;re doing there is enabling multiple View Engines and I&#39;m going to do this via two methods on my <code>ViewEngineActivator</code> called <code>RegisterViewEngine</code> and <code>ResolveViewEngine</code>:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> RegisterViewEngine(<span class="keyword">string</span> viewEngineId, Func&lt;IViewEngine&gt; viewEngineActivator)
{
    <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
}

<span class="keyword">public</span> <span class="keyword">static</span> IViewEngine ResolveViewEngine(<span class="keyword">string</span> viewEngineId)
{
    <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
}</code></pre>
<p>I&#39;m choosing to do a lazy invocation of the View Engine, meaning that you provide a function to create it rather than a created instance. The reason I&#39;ve done this is just so we don&#39;t create it until we do actually require it. But because I only want to create it once anyway I&#39;m going to store the created View Engine once the function executes. For storage I&#39;m going to maintain a private variable like so:</p>
<pre class="highlighted"><code class="xml">private static Dictionary<span class="tag">&lt;<span class="title">string,</span> <span class="attribute">Tuple</span>&lt;<span class="attribute">Func</span>&lt;<span class="attribute">IViewEngine</span>&gt;</span>, IViewEngine&gt;&gt; viewEngines = new Dictionary<span class="tag">&lt;<span class="title">string,</span> <span class="attribute">Tuple</span>&lt;<span class="attribute">Func</span>&lt;<span class="attribute">IViewEngine</span>&gt;</span>, IViewEngine&gt;&gt;();</code></pre>
<p>And now we&#39;ll update our registration method:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> RegisterViewEngine(<span class="keyword">string</span> viewEngineId, Func&lt;IViewEngine&gt; viewEngineActivator)
{
    viewEngines.Add(viewEngineId, <span class="keyword">new</span> Tuple&lt;Func&lt;IViewEngine&gt;, IViewEngine&gt;(viewEngineActivator, (IViewEngine)<span class="keyword">null</span>));
}</code></pre>
<p>As I said I&#39;m staging the instance until it&#39;s needed so inside the tuple I&#39;m just storing a null value. You&#39;ll also have noticed that I&#39;m passing in an ID for the View Engine, this is so we can easily find it later on.</p>
<p>Now we&#39;ll go ahead and implement our resolution method:</p>
<pre class="highlighted"><code class="nginx"><span class="title">public</span> static IViewEngine ResolveViewEngine(string viewEngineId)
{
    <span class="title">if</span> (string.IsNullOrEmpty(viewEngineId))
    {
        <span class="title">throw</span> new ArgumentNullException(<span class="string">"viewEngineId"</span>, <span class="string">"A ViewEngine ID needs to be provided for resolution"</span>);
    }

    <span class="title">if</span> (!viewEngines.ContainsKey(viewEngineId))
    {
        <span class="title">throw</span> new KeyNotFoundException(string.Format(<span class="string">"The ViewEngine ID {0} has not been registered, ensure it is registered before use"</span>, viewEngineId));
    }

    <span class="title">var</span> engine = viewEngines[viewEngineId];

    <span class="title">if</span> (engine.Item2 == null)
    {
        <span class="title">var</span> activator = engine.Item1;
        <span class="title">engine</span> = viewEngines[viewEngineId] = new Tuple&lt;Func&lt;IViewEngine&gt;, IViewEngine&gt;(activator, engine.Item1());
    }

    <span class="title">return</span> engine.Item2;
}</code></pre>
<p>What we&#39;re doing here is:</p>
<ul>
<li>Ensuring that we are being provided an ID for the View Engine and that it does exist in the store</li>
<li>Pulling out the tuple</li>
<li>If we haven&#39;t created the View Engine yet (stored in <code>Item2</code>) we&#39;ll create it</li>
<li>Return the View Engine</li>
</ul>
<p>Now I need to make a way to register each View Engine. You <em>can</em> do this by accessing the <code>ViewEngineActivator</code> itself but that&#39;s not quite as fluent when you&#39;re working with the <code>IAppBuilder</code> so we&#39;ll chuck an extension method on there:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">static</span> IAppBuilder RegisterViewEngine(<span class="keyword">this</span> IAppBuilder builder, Func&lt;IViewEngine&gt; viewEngine, <span class="keyword">string</span> viewEngineId)
{
    ViewEngineActivator.RegisterViewEngine(viewEngineId, viewEngine);
    <span class="keyword">return</span> builder;
}</code></pre>
<p>Noting really special with this other than making our API read nicely:</p>
<pre class="highlighted"><code class="coffeescript">builder
    .DefaultViewEngine&lt;RazorViewEngine&gt;()
    .RegisterViewEngine(() =&gt; <span class="keyword">new</span> XmlViewEngine(), <span class="string">"xml"</span>)
    <span class="regexp">//</span> <span class="keyword">and</span> so <span class="literal">on</span></code></pre>
<h1>Accessing the right View Engine</h1>
<p>So we&#39;ve seen how to get a View Engine by an ID but we want to make it easier. Generally speaking you&#39;re going to be only using a single View Engine for most of your routes. To this end I want to have a <em>default</em> View Engine which will be loaded up, which is what our singleton was doing for us before; I&#39;m going to rename it to <code>DefaultViewEngine</code> to make it more discoverable and change it from being a standard get/ set to look like this:</p>
<pre class="highlighted"><code class="nginx"><span class="title">public</span> static IViewEngine DefaultViewEngine
{
    <span class="title">get</span>
    {
        <span class="title">if</span> (defaultViewEngine == null)
            defaultViewEngine = ResolveViewEngine(<span class="string">"defaultViewEngine"</span>);

        <span class="title">return</span> defaultViewEngine;
    }
    <span class="title">set</span>
    {
        <span class="title">defaultViewEngine</span> = value;
    }
}</code></pre>
<p>Now I&#39;ve got a backing field and I&#39;m also going to be working under the assumption that there&#39;s a View Engine called <code>defaultViewEngine</code>. This means that you can set it as before or alternatively set it through lazy loading (which the if condition will take care of).</p>
<h1>Using an alternate View Engine</h1>
<p>We&#39;ve made it to allow you to specify a default View Engine, specify alternate View Engines so let&#39;s look at how to use them.</p>
<p>There&#39;s two ways you could go about this, you could either add a new parameter to the route registration which is the View Engine to use or you can put it on the actual call to the View Engine. Personally I like approach two more as the View Engine isn&#39;t really related to the route but to the route handler and it also means that as I want to do some overloads for the route methods its not going to mean a lot of duplicate code (which is the same reason that we went with the <code>View</code> extension method to begin with if you remember).</p>
<p>This gives us an extension method like this:</p>
<pre class="highlighted"><code class="avrasm">public static void View(this Response res, string view, string viewEngineId)
{
    var viewEngine = ViewEngineActivator<span class="preprocessor">.ResolveViewEngine</span>(viewEngineId)<span class="comment">;</span>
    var output = viewEngine<span class="preprocessor">.Parse</span>(view)<span class="comment">;</span>

    res<span class="preprocessor">.ContentType</span> = <span class="string">"text/html"</span><span class="comment">;</span>
    res<span class="preprocessor">.Status</span> = <span class="string">"200 OK"</span><span class="comment">;</span>
    res<span class="preprocessor">.End</span>(output)<span class="comment">;</span>
}</code></pre>
<p>(And I&#39;ll leave the model-based one to your imagination)</p>
<p>It&#39;s pretty simple as you can see, mostly just a set of pass through method calls and it means our handler could be like:</p>
<pre class="highlighted"><code class="avrasm"><span class="preprocessor">.View</span>(<span class="string">"/foo"</span>, (req, res) =&gt; {
    res<span class="preprocessor">.View</span>(<span class="string">"fooEngine"</span>)<span class="comment">;</span>
})</code></pre>
<p>While it&#39;s true I&#39;m hard-coding <code>text/html</code> as the content type that&#39;s something you can change yourself, or even make it so that the View Engine knows more about the content type that is being returned; I&#39;ll leave those as your exercises.</p>
<h1>Conclusion</h1>
<p>This wrap up our look at View Engines; we&#39;ve seen how to create something simple to support a single View Engine and then expanded on the concept to enable us to use a different View Engine if and when required.</p>
<p>As always you can check out the full code up on the <a href="https://github.com/aaronpowell/Owin.HelloWorld">GitHub repository</a>.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/web/owin-view-engines-part-2';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
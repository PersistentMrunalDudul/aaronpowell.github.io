<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Animating with JavaScript - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Animating with JavaScript</h1>
                <h2>13th March 2011</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th July 2013</span>
                            <h3><a href="/posts/2013-07-10-implementing-indexers-in-javascript.html">Implementing "indexers" in JavaScript</a></h3>
                        </header>
                        <p>My colleague Luke Drumm challenged me to implement C# style indexers in JavaScript.</p>
<p>So let&#39;s have a look at how you can do that, and how you can make some very interesting JavaScript objects that are self replicating. We&#39;ll build on the knowledge of using <code>bind</code> and <code>apply</code> from the last two posts.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2013</span>
                            <h3><a href="/posts/2013-07-05-javascript-binding-currying-and-arrows.html">JavaScript bind, currying and arrow functions</a></h3>
                        </header>
                        <p>After confusing my colleagues with how to invoke functions with a modifided set of arguments at a single time the next evolutionary point was to confuse them with creating functions that are always called with a different state.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">4th July 2013</span>
                            <h3><a href="/posts/2013-07-04-javascript-call-and-apply.html">JavaScript call and apply</a></h3>
                        </header>
                        <p>After having confused one of my colleagues with some code that used the JavaScript <code>apply</code> method and giving them an answer that didn&#39;t leave them completely bemused I thought I&#39;d share my explanation with the world.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">21st June 2013</span>
                            <h3><a href="/posts/2013-06-21-walking-a-javascript-object.html">Walking a JavaScript object</a></h3>
                        </header>
                        <p>Ever had a path to a path to a property on a JavaScript object that you want to walk? Something along the lines of <code>foo.bar.baz</code>.</p>
<p>Recently I was trying to solve this problem and came across a nifty little trick</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>I&#39;ve always considered the <a href="http://api.jquery.com/animate/">animation</a> aspect of jQuery to be a bit of black magic (and well I still do :P) but at the same time I want to know how it works.</p>
<p>Recent a client had a need for some really basic animation (changing some elements dimentions) and they aren&#39;t using jQuery (and aren&#39;t in a position to add it as a dependency) so I needed to work out another solution. This gave me the opportunity I&#39;d wanted, a chance to delve into what it would take to make animation work.</p>
<p>Well turns out it&#39;s not really that complex, in fact it can be done in about 60 lines of code. Rather building suspense <a href="http://hg.slace.biz/javascript-tools/src/3322dbbdc2fe/JavaScriptTools/Scripts/slace.animator.js">here is the code</a> that I&#39;ll be going over.</p>
<p>Now that you&#39;ve seen the full code let&#39;s see about breaking it down.</p>
<h1>Creating a starting point</h1>
<p>I&#39;m going to use a self executing function to setup what we need, let&#39;s create a skeleton like so:</p>
<pre class="highlighted"><code class="coffeescript"><span class="reserved">var</span> animator = (<span class="reserved">function</span>() {
    <span class="keyword">return</span> <span class="reserved">function</span>(el, opts) {
        <span class="regexp">//</span><span class="keyword">do</span> stuff
    };
})();</code></pre>
<p>There&#39;s two input arguments, an element to target and a set of options which will be the CSS properties we want to manipulate.</p>
<p>We&#39;ll do some basic validation, ensuring there was either an element or an ID selector (no I&#39;m <strong>not</strong> building a selector engine too :P) and ensuring that we did receive some CSS rules. Then a type check is done against <code>el</code> to see if it was a DOM element or a selector (and yeah it&#39;s pretty basic) but the ulimate goal is to get a single DOM element which we can work against.</p>
<p>Next let&#39;s setup some variables we&#39;ll need:</p>
<pre class="highlighted"><code class="sql">var <span class="operator"><span class="keyword">start</span> = +new <span class="keyword">Date</span>,
    duration = opts.duration || <span class="number">600</span>,
    <span class="keyword">end</span> = <span class="keyword">start</span> + duration,
    calc = el.currentStyle || getComputedStyle(el, <span class="keyword">null</span>),
    style = buildStyles(opts.css),
    data = {};</span></code></pre>
<p><em>Here&#39;s a trick, you can do <code>+new Date</code> to grab the ticks right now ;).</em></p>
<p>We&#39;re grabing a few values such as the start and end time periods, the duration for an animation (or a default of 600 miliseconds), the styles of the element (using <code>currentStyle</code> or <code>getComputedStyle</code> depending on whether you&#39;re in a current generation browser or not). The current styles are going to be important when we get to the actual animation stage. The property (or method) returns an array which contains all the CSS rules applied to the element. Why do we need this? Well when we&#39;re doing the animation we need to know how far we have to &#39;travel&#39;. If say you&#39;re going from <code>padding-top:10px</code> to <code>padding-top:30px</code> we don&#39;t want to cover 30px in total, just 20px, and if we know the starting point then we wont break the existing UI.</p>
<p>Next we&#39;re going to build up the styles. For this we&#39;re going to jump out to a method to handle that.</p>
<h1>Building the style rules</h1>
<p>First we need a list of CSS properties which we&#39;ll support:</p>
<pre class="highlighted"><code class="vhdl">var supported = (<span class="attribute">'padding</span>-top,padding-bottom,padding-left,padding-right,font-size,line-height,margin-top,margin-bottom,'
                + <span class="attribute">'margin</span>-left,margin-right,border-top,border-bottom,border-left,border-right,width,height').split(',');</code></pre>
<p>This I&#39;m doing as a comma-separated string which is then split (I just find it more readable) and as you can see it just supports dimention-based manipulation.</p>
<p>We&#39;ll next build up a string which represents the full style rule set that we&#39;re wanting to create:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> buildStyles = <span class="function"><span class="keyword">function</span> <span class="params">(style)</span> {</span>
    <span class="keyword">var</span> s = <span class="string">''</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">in</span> style) {
        s += <span class="string">' '</span> + x + <span class="string">':'</span> + (<span class="keyword">typeof</span> style[x] == <span class="string">'function'</span> ? style[x]() : style[x]) + <span class="string">';'</span>;
    }</code></pre>
<p>As you can see here we&#39;re also supporting functions for the style rules, it allows you to create funky rules based on calculations too :D. Basically it will take this:</p>
<pre class="highlighted"><code class="css"><span class="rules">{ 
    <span class="rule"><span class="attribute">css</span>:<span class="value"> {
        <span class="string">'font-size'</span>: <span class="string">'30px'</span>,
        <span class="string">'padding-top'</span>: <span class="string">'10px'</span>
    }</span></span></span>
}</code></pre>
<p>And produce this:</p>
<pre class="highlighted"><code class="css">     <span class="tag">font</span>-<span class="tag">size</span><span class="pseudo">:30px</span>; <span class="tag">padding</span>-<span class="tag">top</span><span class="pseudo">:10px</span>;</code></pre>
<p>Next we need to get tricky and filter out the rules which are not supported by out little library:</p>
<pre class="highlighted"><code class="xml">var el = document.createElement('div');
el.innerHTML = '<span class="tag">&lt;<span class="title">div</span> <span class="attribute">style</span>=<span class="value">"' + s + '"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span>';
var res = {};
for (var i = 0, l = supported.length; i <span class="tag">&lt; <span class="attribute">l</span>; <span class="attribute">i</span>++) {
    <span class="attribute">if</span> ((<span class="attribute">x</span> = <span class="attribute">el.firstChild.style</span>[<span class="attribute">supported</span>[<span class="attribute">i</span>]])) {
        <span class="attribute">res</span>[<span class="attribute">supported</span>[<span class="attribute">i</span>]] = <span class="attribute">parse</span>(<span class="attribute">x</span>);
    }
}
<span class="attribute">return</span> <span class="attribute">res</span>;</code></pre>
<p>Here we&#39;re producing a DOM element, then adding a child with the full rule set that was request. We&#39;ll then go through all the supported rules, see if it was specified and then build up an object to return which has the rule set we desire. We&#39;ve also got a little <code>parse</code> method here which uses float parsing and regex to return <code>30px</code> into <code>30</code> which we can calculate against.</p>
<p>That completes our building of the styles and now we can go back to the core method.</p>
<h1>Handling the styles</h1>
<p>Now that we&#39;ve got the styles that we need to animate we have to make a clone of the style rules but set the values to that of the DOM element we&#39;re naimating:</p>
<pre class="highlighted"><code class="erlang"><span class="function"><span class="title">for</span> <span class="params">(var p in style)</span> {
    <span class="title">data</span>[<span class="title">p</span>] = <span class="title">parse</span><span class="params">(calc[p])</span>;
}</code></pre>
<p>This is going back to the <code>currentStyles</code> (or <code>getComputedStyles</code>) object we found earlier.</p>
<h1>Making it animate</h1>
<p>So this sees all the boilerplate code out of the way we&#39;ve:</p>
<ul>
<li>Got our start, end and duration</li>
<li>Know what styles we originally had</li>
<li>Know what styles we need to get to</li>
</ul>
<p>Well let&#39;s actually make it work!</p>
<p>For this I&#39;m going to use a recursive setTimeout pattern (which I covered <a href="http://www.aaron-powell.com/doing-it-wrong/blink">in more details here</a>).</p>
<p>This is the code that we&#39;re going to need:</p>
<pre class="highlighted"><code class="haskell">    setTimeout(function go() {
        var now = +new <span class="type">Date</span>,
        pos = now &gt; end ? <span class="number">1</span> : (now - start) / duration;
        <span class="keyword">if</span> (now &gt;= end) {
            return;
        }
        for (var p <span class="keyword">in</span> style) {
            el.style[p] = (<span class="typedef"><span class="keyword">data</span>[p] + <span class="container">(<span class="title">style</span>[<span class="title">p</span>] - <span class="title">data</span>[<span class="title">p</span>])</span> * <span class="container">((-<span class="type">Math</span>.<span class="title">cos</span>(<span class="title">pos</span> * <span class="type">Math</span>.<span class="type">PI</span>)</span> / 2) + 0.5)) + 'px';</span>
        }
        setTimeout(go, <span class="number">10</span>);
    }, <span class="number">10</span>);</code></pre>
<p>Now let&#39;s break it down. We&#39;re grabbing the current ticks and working out just how much more ground there is to cover.</p>
<p>But first off we need to check if we&#39;ve hit the time period to do the animation in, and if so, just exit out of the timeout.</p>
<p>If we are to keep going though we&#39;ll get a bit crazy. So we&#39;ll itterate through all the properties in the style settings we have been told to animate. But this is the crazy part:</p>
<pre class="highlighted"><code class="haskell">(<span class="typedef"><span class="keyword">data</span>[p] + <span class="container">(<span class="title">style</span>[<span class="title">p</span>] - <span class="title">data</span>[<span class="title">p</span>])</span> * <span class="container">((-<span class="type">Math</span>.<span class="title">cos</span>(<span class="title">pos</span> * <span class="type">Math</span>.<span class="type">PI</span>)</span> / 2) + 0.5))</span></code></pre>
<p>I don&#39;t recall where I got this code from but I believe it was from within the jQuery source somewhere. Basically it&#39;s some funky maths to determine a stable incrementation value based on the time remaining for the animation. And this is the most important part, you want to be able to animate at a consistent rate across the duration of the animation. By using the <code>pos</code> (which is defined earlier in the method) we can accurately assume the distance each animation step has to cover.</p>
<p>Once all style properties have been processed a timeout of 10 miliseconds is placed to re-execute the animation loop.</p>
<h1>Conclusion</h1>
<p>To wrap we&#39;ve looked at a way to make a really small and simple animation library. This is <em>not</em> a replacement for jQuery (or any other animation library) but just a good chance to shed some light on how something a little bit black magic works.</p>
<p>There&#39;s plenty of things missing from this implementation, such as:</p>
<ul>
<li>using CSS3 animations</li>
<li>supporting animation chaining (eg: <code>animate(&#39;h1&#39;, { css: {&#39;padding-top&#39;:&#39;30px&#39;} }); animate(&#39;h1&#39;, { css: {&#39;padding-top&#39;: &#39;10px&#39;} });</code>)</li>
<li>notification of animiation completing (aka <code>$.Deferred</code>)</li>
</ul>
<p>But hopefully it does give you some interesting things to think about and <a href="http://jsfiddle.net/slace/mVrN2/">if you want to have a play I&#39;ve put a jsfiddle up for it</a>.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/javascript-animation';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Creating Controllers-as-plugins using MVC3 | LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Creating Controllers-as-plugins using MVC3</h1>
                <h2>25th January 2011</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/mvc3.html"><span>mvc3</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/autofac.html"><span>autofac</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/funnelweb.html"><span>funnelweb</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">26th May 2011</span>
                            <h3><a href="/posts/2011-05-26-data-attribute-mvc3-forms.html">Adding data attributes to MVC3 forms with HtmlHelpers</a></h3>
                        </header>
                        <p>In a site I&#39;m working on I wanted to add a data attribute, you know, <code>data-*</code>, to a form that was being generated from a controller action in MVC3. So I have the code like this:</p>
<pre class="highlighted"><code class="brainfuck"><span class="comment">@using(Html</span>.<span class="comment">Begin</span>.<span class="string">.</span><span class="string">.</span></code></pre>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/mvc3.html"><span>mvc3</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">20th February 2011</span>
                            <h3><a href="/posts/2011-02-20-creating-a-nuget-plugin-engine.html">Creating a NuGet-based plugin engine</a></h3>
                        </header>
                        <p>How to create a plugin engine using NuGet as the distribution format</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/nuget.html"><span>nuget</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/funnelweb.html"><span>funnelweb</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">9th June 2010</span>
                            <h3><a href="/posts/2010-06-09-supporting-valuetypes-in-autofac.html">Supporting ValueTypes in Autofac</a></h3>
                        </header>
                        <p>Autofac doesn&#39;t support injection of value types as properties, here&#39;s how to support it.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/autofac.html"><span>autofac</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">8th April 2010</span>
                            <h3><a href="/posts/2010-04-08-problems-with-assembly-trust.html">Problems with Assembly Trust</a></h3>
                        </header>
                        <p>Something to be careful of with downloading assemblies</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/trust-level.html"><span>trust-level</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/autofac.html"><span>autofac</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/fail.html"><span>fail</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <h1>Overview</h1>
<p>While working on the plugin engine for <a href="http://funnelweblog.com">FunnelWeb</a> we decided that we wanted to add the ability for people to create their own extnesions which are Controllers and routes. Seems like a pretty simple idea, and it makes it really easy to add external functionality into FunnelWeb at a Controller level without rolling your own instace.</p>
<p>But there&#39;s a catch...</p>
<h1>Some background</h1>
<p>We&#39;re using MVC3 for FunnelWeb, and part of MVC3 is this lovely new way to do <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>, the <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.idependencyresolver.aspx">IDependencyResolver</a> interface. We&#39;re using <a href="http://code.google.com/p/autofac">Autofac</a> in FunnelWeb and it&#39;s latest release (2.4) has MVC3 and IDependencyResolver support.</p>
<p>The main role of the IDependencyResolver is so that you can do Dependency Injection without having to reimplement a lot of the MVC core. Previously you had to create custom Controller Factories, and a bunch of other stuff (depending what you wanted to DI), but not any more!</p>
<h1>Implementing Dependency Resolver</h1>
<p>So this is actually really simple to use, all you need to do to use your own custom resolver is this:</p>
<pre class="highlighted"><code class="avrasm">var builder = new ContainerBulder()<span class="comment">;</span>
builder<span class="preprocessor">.RegisterControllers</span>(Assembly<span class="preprocessor">.GetExecutingAssembly</span>())<span class="comment">;</span>
// do other registrations
var container = builder<span class="preprocessor">.Build</span>()<span class="comment">;</span>
DependencyResolver<span class="preprocessor">.SetResolver</span>(new AutofacDependencyResolver(container))<span class="comment">;</span></code></pre>
<p>That&#39;s all you have to do, and now any Controller which you&#39;ve registered will be resolved via Autofac, not <code>Activator.CreateInstance</code>, meaning you don&#39;t have to have a default constructor.</p>
<p>But there&#39;s a problem, how do you add the Controllers which are not in the current assembly, to Autofac and to be resolved?</p>
<h1>Extending the plugin framework</h1>
<p>Well to add the new Controller-based extension point I set about expanding how our plugins worked. Previously we had a <code>IFunnelWebExtension</code> interface which you implemented, and it has a single method that initialized it.</p>
<p>That was fine for what we originally wanted, but how were we going to register new routes?</p>
<p><strong>Enter the RoutableFunnelWebExtension.</strong></p>
<p>To do this I&#39;ve created a new <code>abstract</code> class, <code>RoutableFunnelWebExtension</code> and it has some additional information on it, first off it has the <code>RouteCollection</code> so you can register routes, but it also has a method which will resolve Controllers for you. But don&#39;t worry, we&#39;ve done the heavy lifting and you don&#39;t need to register them yourself, we handle it for you :).</p>
<p>So we have this method:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">virtual</span> <span class="keyword">void</span> RegisterControllers(ContainerBuilder builder)
{
    builder.RegisterControllers(GetType().Assembly)
        ;
}</code></pre>
<p>Cool, that&#39;ll handle our registrations, let&#39;s assume we have a route setup up, our extension is in <code>/bin/Extensions</code>, and we&#39;re good to go right... right?</p>
<p><strong>Wrong.</strong></p>
<p>This is the point I got to where I started pulling out my hair, when I&#39;d hit the route I configured it resulted in a 404. This is quite strange, FunnelWeb has a <em>catch all</em> route, so that you can create any page URL you want, so a 404 really isn&#39;t possible.</p>
<p>After some digging it turns out that the route <strong>was</strong> being hit, and this was why the 404 was happening, the route was matching, but no Controller was being resolved. But hang on though, our plugin has registered the Controller right? If I inspect the container then yeah, I can see it, so why was it not found?</p>
<h2>Understanding how Controllers are found</h2>
<p>So as it turns out the <code>IDependencyResolver</code> isn&#39;t actually the silver bullet which I was expecting it to be, it turns out that the pesky <a href="http://msdn.microsoft.com/en-us/library/system.web.compilation.buildmanager.aspx">BuildManager</a> is back to spoil my fun.</p>
<p><em>Side note, <a href="http://shazwazza.com">Shannon Deminick</a> has also <a href="http://shazwazza.com/post/MVC-Controllers-as-plugins-with-MEF-and-Autofac.aspx">blogged about</a> <a href="http://shazwazza.com/post/Developing-a-plugin-framework-in-ASPNET-with-medium-trust.aspx">plugin engines</a> and the problems which the BuildManager can produce.</em></p>
<p>When a route is found MVC goes to the <code>IControllerFactory</code> and asks it to create the Controller instance. Out of the box this heads over to the <code>DefaultControllerFactory</code> class, and it eventually goes out to your <code>IDependencyResolver</code> to find it. The catch is, MVC first finds the type of the Controller whihc matches the route. This is handled by the <code>GetControllerType</code> method, and this is where we&#39;re hitting a problem.</p>
<p>In the default instance this will look into the <code>BuildManager</code> and find out what the type is. Now that&#39;s <em>generally</em> fine, <strong>provided your Controller is in the <code>/bin</code> folder</strong>, but the Controller isn&#39;t in there, our extensions are in <code>/bin/Extensions</code>, and the <code>BuildManager</code> isn&#39;t smart enough to look there. This means that when the Controller type tries to be found it returns null, and in turn MVC assumes that <em>these are not the Controllers you are looking for</em>.</p>
<p><strong>Crap.</strong></p>
<p>As it turns out the default Controller Factory isn&#39;t smart enough to look into the DI container (and well that&#39;s expected, it&#39;s kind of a rough requirement to force on the DI container), so it looks like we have to implement our own anyway.</p>
<p>Luckily we don&#39;t need to do a full Controller Factory, we can just extend the default one. What you want to do is extend the <code>GetControllerType</code> method to also go to the DI container.</p>
<p>To be able to efficiently locate our Controller type I first want to make it better described in Autofac, so I&#39;ll augment our <code>RegisterControllers</code> method in the plugin framework:</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">protected</span> internal virtual <span class="keyword">void</span> RegisterControllers(ContainerBuilder builder)
{
    builder<span class="variable">.RegisterControllers</span>(GetType()<span class="variable">.Assembly</span>)
        <span class="variable">.Named</span>&lt;IController&gt;(t =&gt; t<span class="variable">.Name</span><span class="variable">.Replace</span>(<span class="string">"Controller"</span>, string<span class="variable">.Empty</span>))
        ;
}</code></pre>
<p>Now our Controllers are <a href="http://code.google.com/p/autofac/wiki/TypedNamedAndKeyedServices">Named registrations</a>, and we can find them by their Controller name:</p>
<pre class="highlighted"><code class="nginx"><span class="title">public</span> class FunnelWebControllerFactory : DefaultControllerFactory
{
    <span class="title">private</span> readonly IContainer _container;

    <span class="title">public</span> FunnelWebControllerFactory(IContainer container)
    {
        <span class="title">_container</span> = container;
    }
    <span class="title">protected</span> override Type GetControllerType(RequestContext requestContext, string ControllerName)
    {
        <span class="title">var</span> Controller = base.GetControllerType(requestContext, ControllerName);
        <span class="title">if</span> (Controller == null)
        {
            <span class="title">object</span> x;
            <span class="title">if</span> (_container.TryResolveNamed(ControllerName, typeof(IController), out x))
                Controller = x.GetType();
        }

        <span class="title">return</span> Controller;
    }
}</code></pre>
<p>As you can see here we&#39;re overriding the <code>GetControllerType</code> method. If the base implementation doesn&#39;t return a Controller, which it wont if a) the Controller isn&#39;t in the <code>BuildManager</code> or b) if you&#39;re not routing to a Controller, we&#39;ll see if Autofac knows about it.</p>
<p>If Autofac did know about it then we can return the type of it and we&#39;re going to be right now... right?</p>
<p><strong>Sigh.</strong></p>
<p>So my Controller plugin has a constructor argument which I need to be injected, but I&#39;m seeing a lovely YSOD saying that <code>Activator.CreateInstance</code> is unable to create the Controller as there is no default constructor (a constructor with no arguments). Wait, what? Isn&#39;t the <code>IDependencyResolver</code> meant to be resolving it?</p>
<p>Well yes, but there&#39;s still a problem, once <code>GetControllerType</code> is called the returned type is passed into our <code>IDependencyResolver.GetService</code> method, and Autofac will resolve it, or return null if it can&#39;t find it, and when <code>null</code> is returned the Controller Factory will fall back to <code>Activator.CreateInstance</code>.</p>
<p>The reason that the type isn&#39;t found is because the Controller isn&#39;t registered using the type of the Controller, so it can&#39;t be found in Autofac. Well that&#39;s a very easy one to fix, we&#39;ll just ensure that the registration is registered by it&#39;s type too:</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">protected</span> internal virtual <span class="keyword">void</span> RegisterControllers(ContainerBuilder builder)
{
    builder<span class="variable">.RegisterControllers</span>(GetType()<span class="variable">.Assembly</span>)
        <span class="variable">.Named</span>&lt;IController&gt;(t =&gt; t<span class="variable">.Name</span><span class="variable">.Replace</span>(<span class="string">"Controller"</span>, string<span class="variable">.Empty</span>))
        <span class="variable">.AsSelf</span>()
        ;
}</code></pre>
<p>Now we&#39;re registering the types as their actual type, and now we can resolve it from Autofac using that. And you know what, hitting the route now calls the Controller action correctly.</p>
<h1>Conclusion</h1>
<p>Which MVC3 is yet aother good step towards simple extensibility there&#39;s a few pain points when you&#39;re wanting to do stuff that is <em>edge case</em>. And yet again the major pain point which we&#39;re coming across is the BuildManager.</p>
<p>But with a few code tweaks and a custom Controller Factory you too can load a Controller from a folder that isn&#39;t <code>/bin/</code>.</p>
<p>I hope in future versions of ASP.Net the BuildManager can be made a bit smarter, and work better with types outside <code>/bin</code>.</p>
<p>If you&#39;re looking for an alternate way to do plugins I suggest you check out Shannon&#39;s posts.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/controller-plugins-with-mvc3';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
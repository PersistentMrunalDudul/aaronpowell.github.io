<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>The JavaScript new operator - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">The JavaScript new operator</h1>
                <h2>14th July 2013</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th July 2013</span>
                            <h3><a href="/posts/2013-07-10-implementing-indexers-in-javascript.html">Implementing "indexers" in JavaScript</a></h3>
                        </header>
                        <p>My colleague Luke Drumm challenged me to implement C# style indexers in JavaScript.</p>
<p>So let&#39;s have a look at how you can do that, and how you can make some very interesting JavaScript objects that are self replicating. We&#39;ll build on the knowledge of using <code>bind</code> and <code>apply</code> from the last two posts.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2013</span>
                            <h3><a href="/posts/2013-07-05-javascript-binding-currying-and-arrows.html">JavaScript bind, currying and arrow functions</a></h3>
                        </header>
                        <p>After confusing my colleagues with how to invoke functions with a modifided set of arguments at a single time the next evolutionary point was to confuse them with creating functions that are always called with a different state.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">4th July 2013</span>
                            <h3><a href="/posts/2013-07-04-javascript-call-and-apply.html">JavaScript call and apply</a></h3>
                        </header>
                        <p>After having confused one of my colleagues with some code that used the JavaScript <code>apply</code> method and giving them an answer that didn&#39;t leave them completely bemused I thought I&#39;d share my explanation with the world.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">21st June 2013</span>
                            <h3><a href="/posts/2013-06-21-walking-a-javascript-object.html">Walking a JavaScript object</a></h3>
                        </header>
                        <p>Ever had a path to a path to a property on a JavaScript object that you want to walk? Something along the lines of <code>foo.bar.baz</code>.</p>
<p>Recently I was trying to solve this problem and came across a nifty little trick</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd January 2013</span>
                            <h3><a href="/posts/2013-01-22-hello-mathy.html">Hello mathy</a></h3>
                        </header>
                        <p>An introduction to another new library from me, this time it&#39;s mathy, a simple formula parser</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In the <a href="/posts/2013-07-10-implementing-indexers-in-javascript.html">last post</a> I was changing some C# code to JavaScript but there was one part that I just <em>dropped</em> and didn&#39;t explain why, and that was the use of the new operator.</p>
<p>While JavaScript isn&#39;t a classical language, it&#39;s prototypal, and doesn&#39;t have a notion of classes (<a href="http://wiki.ecmascript.org/doku.php?id=strawman:maximally_minimal_classes">yet</a>), but it does have a new operator. What&#39;s interesting is <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-11.2.2">it&#39;s an operator</a> like C# (see 14.5.10 of the spec, yep I looked it up :P), and operators tend to do something unique which is also the case with JavaScript new. If you&#39;re a spec-nut you can read what happens in the link above (and also the <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-13.2.2">[[Construct]]</a> method which is important), but if you&#39;re not it does a few things that are of note:</p>
<ul>
<li>It expects a function as the <em>thing</em> being new&#39;ed up</li>
<li>The result is a new object that has the prototype of the function that was new&#39;ed, but also potentially their own values (such as values provided as the arguments)</li>
</ul>
<p>So let&#39;s make a simple &quot;class&quot; which consists of a constructor function:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> Person = <span class="function"><span class="keyword">function</span> <span class="params">(firstName, lastName)</span> {</span>
    <span class="keyword">this</span>.firstName = firstName;
    <span class="keyword">this</span>.lastName = lastName;
}; </code></pre>
<p>We can then add members to all instances by modifying the prototype:</p>
<pre class="highlighted"><code class="objectivec">Person<span class="variable">.prototype</span><span class="variable">.fullName</span> = function () {
    <span class="keyword">return</span> <span class="keyword">this</span><span class="variable">.firstName</span> + <span class="string">" "</span> + <span class="keyword">this</span><span class="variable">.lastName</span>;
}</code></pre>
<p>Now if we run the following we&#39;ll get two different people:</p>
<pre class="highlighted"><code class="vhdl">var aaron = <span class="keyword">new</span> Person(<span class="attribute">'Aaron</span>', <span class="attribute">'Powell</span>');
var john = <span class="keyword">new</span> Person(<span class="attribute">'John</span>', <span class="attribute">'Smith</span>');

console.<span class="keyword">assert</span>(aaron == john); //fails</code></pre>
<p>The two people we&#39;ve created are different objects, which is exactly what we expect, but if we did:</p>
<pre class="highlighted"><code class="avrasm">console<span class="preprocessor">.assert</span>(aaron<span class="preprocessor">.fullName</span> == john<span class="preprocessor">.fullName</span>)<span class="comment">;</span></code></pre>
<p>The assert won&#39;t fail since they are the same method <em>reference</em>, but on two different objects.</p>
<p>Another important part of the Person constructor has a this scope (which we&#39;ve learnt to manipulate in the past) and what would we expect it to be? Well functions inherit the scope of their parent (unless you modify it) which means that our parent scope of Person will be the global object (window in the browser) or null in ES5 Strict Mode.</p>
<p>But that&#39;s not the case when you use the new operator, the new operator is yet another way we can modify this, under this scenario it becomes a completely new object literal, it&#39;s similar to doing this:</p>
<pre class="highlighted"><code class="javascript">Person = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> obj = {};
    <span class="keyword">var</span> Person = <span class="function"><span class="keyword">function</span> <span class="params">(firstName, lastName)</span> {</span>
        <span class="keyword">this</span>.firstName = firstName;
        <span class="keyword">this</span>.lastName = lastName;
    };
    Person.apply(obj, arguments);
    <span class="keyword">return</span> obj;
};</code></pre>
<p>Well that&#39;s close, it doesn&#39;t maintain the prototype chain or setup the constructor properly, what it does do is create a new object that is then returned, meaning each invocation of Person will result in a different object, much like the new operator.</p>
<h2>Is it new or not?</h2>
<p>The problem with the new operator is that it&#39;s applied to a function, it can be applied to <em>any</em> function, but it can also be omitted. This means you can create yourself a function that&#39;s intended to be a constructor but not used with a new operator, and doing this would mean that you&#39;re augmenting a this scope you probably shouldn&#39;t be, such as the global object.</p>
<p>So how do we know if someone used the new operator? You&#39;re probably not writing your own pre-parser to check the code before it&#39;s executed so it&#39;s not like you know the omitted it at a code level. Well there&#39;s an alternative <em>check the constructor</em>.</p>
<p>One thing I omitted from the above pseudo-new implementation is setting up the obj.constructor property, this is something that the new operator does, and it&#39;s the easiest way to check if a function was invoked with a new operator:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> Person = <span class="function"><span class="keyword">function</span> <span class="params">(firstName, lastName)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.constructor !== Person) {
        <span class="keyword">return</span> <span class="keyword">new</span> Person(firstName, lastName);
    }
    <span class="comment">//setup properties</span>
}</code></pre>
<p>Here we&#39;re checking the constructor against the type we expect the constructor to be. If the function wasn&#39;t invoked with the new operator it won&#39;t receive the right constructor type which means we can assume that function was invoked normally and expects a return, a return which can then be a new instance.</p>
<p>This can be a very useful trick if you&#39;re exposing something that&#39;s to be constructible but you don&#39;t trust your consumers to do the right thing.</p>
<h2>Wrap up</h2>
<p>The new operator is an interesting one, it&#39;s a great way to create objects that have unique instances but still share a common root (being the prototype). There&#39;s arguments all over the internet about whether you should use the new operator or not, whether your API should not require the new operator, whether not using new means a violation of the API or whether your API should just be smart enough to deal with both usages.</p>
<p>But why would you use it? Well that&#39;s a story for another day ;).</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/posts/2013-07-14-javascript-new-operator.html';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
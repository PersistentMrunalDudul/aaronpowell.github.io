<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Hello OWIN - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Hello OWIN</h1>
                <h2>14th March 2012</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/owin.html"><span>owin</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">8th March 2011</span>
                            <h3><a href="/posts/2011-03-08-serverhere.html">ServerHere - When you just need a webserver</a></h3>
                        </header>
                        <p>A tool for when you just want to server some files.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th January 2013</span>
                            <h3><a href="/posts/2013-01-14-ie10-console-thoughts.html">Making the Internet Explorer JavaScript tools better, again</a></h3>
                        </header>
                        <p>A look at what&#39;s changed since I last pointed out the failings of the IE dev tools</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web-dev.html"><span>web-dev</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">18th October 2012</span>
                            <h3><a href="/posts/2012-10-18-dbjs-chrome.html">Chrome support for db.js</a></h3>
                        </header>
                        <p>A little word on the db.js support for Chrome</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/chrome.html"><span>chrome</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">8th October 2012</span>
                            <h3><a href="/posts/2012-10-08-reverse-order-unique-indexes.html">Reverse order unique queries in IndexedDB</a></h3>
                        </header>
                        <p>The quirk of reverse index querying in IndexedDB and in turn db.js</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>Long time readers of my blog will probably be aware that I&#39;ve become quite a fan of <a href="http://nodejs.org">Node.js</a>. One of the things that I&#39;ve liked about working with it is that it&#39;s very bare bones so you&#39;re working very closely with the HTTP pipeline, something that you don&#39;t do with ASP.Net (WebForms in particular, MVC is much closer but still a reasonable abstraction).</p>
<p>About 18 months ago a .NET project popped up on the radar though, a project called <a href="http://owin.org">OWIN</a>. OWIN isn&#39;t really a coding project though, it&#39;s a specification that defines how web applications and .NET web servers should communicate with each other. The nice thing about this is that is is really bare bones, like with Node.js OWIN defines a very thin layer on top of HTTP which can be very powerful.</p>
<h1>Hello OWIN</h1>
<p>So you&#39;ve decided you want to get started with OWIN, well where do you start?</p>
<p>As I mentioned about OWIN is really just a specification and if you read the <a href="http://owin.org/#about">About</a> page it states:</p>
<blockquote>
<p>OWIN defines a single anonymous delegate signature, and therefore introduces no dependencies; there is no OWIN source code.</p>
</blockquote>
<p>That means that you don&#39;t <em>actually</em> build against OWIN*, you want to look at some of the modules built on top of it.</p>
<p><em>*Note this isn&#39;t entirely true, you can build against the OWIN NuGet package but it&#39;s painfully difficult to anything :P. Check out <a href="https://github.com/loudej/firefly/blob/541d0a77648dc1214fe280fa0b3a143e2d3a0373/src/sample/HelloWorld/Program.cs">this</a> for an example of a Hello World on just OWIN.</em></p>
<p>Instead you probably want to have a look at <a href="http://nuget.org/packages/gate">Gate</a>, which is a set of helpers that sits on top of OWIN and makes it a bunch nicer to work with and it&#39;s what I&#39;m going to use in this example.</p>
<p>The first thing I wanted to do was replicate the Node.js demo of creating a basic Hello World server:</p>
<pre class="highlighted"><code class="matlab">var http = require(<span class="string">'http'</span>);
<span class="transposed_variable">http.</span>createServer(<span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> {</span>
  <span class="transposed_variable">res.</span>writeHead(<span class="number">200</span>, <span class="cell">{<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>}</span>);
  <span class="transposed_variable">res.</span><span class="keyword">end</span>(<span class="string">'Hello World\n'</span>);
}).listen(<span class="number">1337</span>, <span class="string">'127.0.0.1'</span>);
<span class="transposed_variable">console.</span><span class="built_in">log</span>(<span class="string">'Server running at http://127.0.0.1:1337/'</span>);</code></pre>
<p>So if this is our goal how do we go about it with OWIN and Gate?</p>
<h2>Project Setup</h2>
<p>Since there&#39;s no Gate project template (that I&#39;ve found) we&#39;ll start with just a C# Class Library project. To this you&#39;ll want to add a dependency on Gate (and that&#39;ll include OWIN) and we&#39;re ready to go.</p>
<p>Most OWIN hosts (we&#39;ll talk about that in a minute) use a convention that to run there needs to be a public class named <code>Startup</code> in the root namespace of the assembly you&#39;re running, so we&#39;ll make one:</p>
<pre class="highlighted"><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Startup</span> {</span>
    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Configuration(IAppBuilder builder) {

    }
}</code></pre>
<p>Inside our <code>Startup</code> class we&#39;ve got a <code>Configuration</code> method (taking <code>IAppBuilder</code> which comes from OWIN). This method is where we will define how to handle the requests that are coming in, basically where we define our Hello World.</p>
<h2>Creating a configuration</h2>
<p>I&#39;m going to use the <code>RunDirect</code> extension method (which resides in the <code>Gate</code> namespace) as it&#39;s as close as we get to the above Node.js function structure, and it looks like this:</p>
<pre class="highlighted"><code class="avrasm">    public static void Configuration(IAppBuilder builder) {
        builder
            <span class="preprocessor">.RunDirect</span>((req, res) =&gt; {
                res<span class="preprocessor">.Status</span> = <span class="string">"200 OK"</span><span class="comment">;</span>
                res<span class="preprocessor">.ContentType</span> = <span class="string">"text/plain"</span><span class="comment">;</span>

                res<span class="preprocessor">.Write</span>(<span class="string">"Hello World!\r\n"</span>)
                    <span class="preprocessor">.End</span>()<span class="comment">;</span>
            })<span class="comment">;</span>
        }</code></pre>
<p>The code should be fairly easy to understand, we get two inputs and <code>Request</code> object and a <code>Response</code> object. These come from <code>Gate</code> (and this is why I recommend Gate over raw OWIN) and are really just dictionaries with a couple of helpful properties and methods for doings the simple stuff you&#39;d want to be doing. </p>
<h2>Hosting our application</h2>
<p>If you&#39;re still following along you&#39;ll remember me saying that OWIN is really just a specification, it defines what the communication interfaces look like but it doesn&#39;t define <em>how</em> they should work, for that you&#39;re going to need an OWIN host. The ideal way to do this is through <a href="http://whereslou.com/2012/02/20/ghost-exe-a-generic-host-for-owin-applications">ghost</a>. Ghost is just an executable that you can run against a class library and spin up your project. Unfortunately I&#39;ve been having <a href="https://github.com/owin/gate/issues/74">problems running ghost</a> so rather than looking at producing something that requires hosting we can look at making our application <strong>self hosting</strong>. For this I&#39;m going to use <a href="http://loudej.github.com/firefly">Firefly</a> as it&#39;s a nice and simple host for OWIN applications, so go and install it from NuGet.</p>
<p>Now we&#39;ve got the dependency on Firefly we need to make an executable rather than a class library. Start by adding a Program class and a Main method like so:</p>
<pre class="highlighted"><code class="vala"><span class="class"><span class="keyword">class</span> <span class="title">Program</span> {</span>
    <span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args) {

    }
}</code></pre>
<p>Then you can go into your project properties and change the output type to a Console Application and set the appropriate startup object. All easier than creating a new project I think ;).</p>
<p>I&#39;m also going to add a dependency on <code>Gate.Builder</code> which is another utility library that takes away some of the grunt work for setting up your application host. With this we&#39;re going to do 3 things:</p>
<ul>
<li>Create builder for our application (an implementation of <code>IAppBuilder</code>)</li>
<li>Create a Firefly server</li>
<li>Provide Firefly with our application</li>
</ul>
<p>This is what our <code>Main</code> method will now look like:</p>
<pre class="highlighted"><code class="cs">    <span class="keyword">static</span> <span class="keyword">void</span> Main(<span class="keyword">string</span>[] args)
    {
        <span class="keyword">var</span> builder = <span class="keyword">new</span> AppBuilder();
        <span class="comment">//Tell the builder to use our configuration</span>
        <span class="keyword">var</span> app = builder.Build(Startup.Configuration);

        <span class="comment">//Start up the server on port 1337</span>
        <span class="keyword">var</span> server = <span class="keyword">new</span> ServerFactory().Create(app, <span class="number">1337</span>);

        Console.WriteLine(<span class="string">"Server running at http://127.0.0.1:1337/"</span>);

        <span class="comment">//Stay running!</span>
        Console.ReadKey();
    }</code></pre>
<h1>Conclusion</h1>
<p>There we go hit F5 and your app will be running, just the same as our initial Node.js example and the full code can be found <a href="https://gist.github.com/2032972">here</a>.</p>
<p>It turns out that this isn&#39;t overly difficult to do, the trick is finding the various dependencies that you require, remember I use:</p>
<ul>
<li>Gate</li>
<li>Gate.Builder</li>
<li>Firefly</li>
</ul>
<p>In the next post we&#39;ll look at how to handle requests in a better fashion with a basic middleware implementation.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/web/hello-owin';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
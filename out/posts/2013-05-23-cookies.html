<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Flight Mode - Cookies | LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Flight Mode - Cookies</h1>
                <h2>23rd May 2013</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/cookies.html"><span>cookies</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">30th May 2013</span>
                            <h3><a href="/posts/2013-05-30-libraries.html">Flight Mode - Libraries</a></h3>
                        </header>
                        <p>Throughout the last few posts we&#39;ve looked at the different ways which we can store data offline in browsers and then created a basic little API that will help is with doing that. The <code>FlightMode</code> ...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/localStorage.html"><span>localStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/sessionStorage.html"><span>sessionStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">28th May 2013</span>
                            <h3><a href="/posts/2013-05-28-file-system.html">Flight Mode - FileSystem API</a></h3>
                        </header>
                        <p>The last piece of the puzzle when looking at offline storage options is a bit of a shift from what we&#39;ve been looking at so far. Generally speaking we&#39;ve been looking at how to store plain data, ei...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/file-system.html"><span>file-system</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">27th May 2013</span>
                            <h3><a href="/posts/2013-05-27-indexeddb.html">Flight Mode - IndexedDB</a></h3>
                        </header>
                        <p>The next stop in our offline storage adventure is to look at the big daddy of offline storage, <a href="http://www.w3.org/TR/IndexedDB/">IndexedDB</a>. Now I&#39;ve [blogged about <code>IndexedDB</code> in the past](http://...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">23rd May 2013</span>
                            <h3><a href="/posts/2013-05-23-local-session-storage.html">Flight Mode - local and session storage</a></h3>
                        </header>
                        <p>Last time we looked a <a href="/flight-mode/cookies">using cookies to store offline data</a> and we also saw that there&#39;s a number of problems with that approach. So let&#39;s move forward, let&#39;s look at what our...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/localStorage.html"><span>localStorage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/sessionStorage.html"><span>sessionStorage</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">23rd May 2013</span>
                            <h3><a href="/posts/2013-05-23-introduction.html">Flight Mode - Introduction</a></h3>
                        </header>
                        <p>So you&#39;ve got an idea to build an amazing new web application, it&#39;s going to make you tens of dollars, hundreds of cents, it&#39;s all web API&#39;ed and SPA. There&#39;s a responsive design so it&#39;s mobile fri...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/offline-storage.html"><span>offline-storage</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/flight-mode.html"><span>flight-mode</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In the beginning there was a simple way to store data offline in an application, or more accurately, across sessions, and that is the HTTP Cookie.</p>
<p>Cookies are used for everything, they can <a href="http://www.nczonline.net/blog/2009/05/12/cookies-and-security/">track you for spammers</a>, <a href="http://www.troyhunt.com/2013/03/c-is-for-cookie-h-is-for-hacker.html">expose your secure connections for hackers</a> and they can be used for legitimate purposes which I&#39;m going to look at here.</p>
<p>The Cookie is the oldest form of offline storage available on the web, first emerging <a href="http://en.wikipedia.org/wiki/HTTP_cookie">in the mid 90&#39;s with Netscape</a>. All browsers support them so it&#39;s your most easily accessible cross-browser storage solution.</p>
<h2>Benefits of Cookies for storage</h2>
<p>There are a few aspects to cookies that make them appealing for storing offline data so let&#39;s have a look at a few of them.</p>
<p>Since cookies are part of the HTTP Header they are included in every request that you make which can be useful if you want to sync the data that&#39;s been created while the application is offline back to the server when the user reconnects. There&#39;s no special AJAX request you&#39;d need to create to handle the sync, any request would do, it&#39;s just up to your server to handle said cookies. This has an obvious downside though, the more you store in cookies the bigger your request/response payload is going to be, so keep that in mind if you want to use cookies for storing data, particularly when limited data connections are applicable, such as on mobile devices).</p>
<p>Expiry is another benefit that cookies bring to the table. If you&#39;re storing data offline you may be wanting to get rid of it after a certain time period to prevent it from becoming stale. Cookies have an expiry date built into them when they are created, meaning that when you first set up your stored data you can determine just how long you want it to hang around. Admitted it won&#39;t &quot;magically&quot; disappear if the user is offline at the time, but it will expire through new requests that are done.</p>
<h2>Drawbacks of Cookies for storage</h2>
<p>Unsurprisingly there are some drawbacks to using cookies, some pretty major ones to be exact too, the first main drawback is that cookies are simply not designed to be used this way. While it might sound great to be able to have your offline data sent to the server without you needing to do anything it really starts to come apart when you want to store much data. Cookies can only handle <info in cookie size> which means that they&#39;re best used for little flags, maybe tracking a simple preference like which theme to use.</p>
<p>Another major drawback is that cookies have the laxest cross-origin restrictions of all the offline storage options we&#39;ll be looking at. As I mentioned earlier cookies were a common tool in the spammers toolbox and that was because you could very easy get data out of them without owning the domain, sure you still had to get <strong>your</strong> code into the page but if your serving ads then you&#39;re part of the way there already.</p>
<p>Finally the API for cookies really does leave a lot to be desired. Don&#39;t get me wrong there&#39;s a myriad of wrapper APIs for the <code>document.cookies</code> object that&#39;ll help you add/remove cookies but it doesn&#39;t solve the fundamental problem, <strong>cookies are only strings</strong>, meaning if you want to store an object of some description it&#39;s serializing to JSON for you. This really starts to fall over when you want to be able to <em>query</em> the data. If you&#39;ve got lots of objects you&#39;ll have to get them all back out and do in-memory querying of the data.</p>
<h2>Implementing Cookie storage</h2>
<p>While it&#39;s an exercise in <a href="http://www.codinghorror.com/blog/2009/02/dont-reinvent-the-wheel-unless-you-plan-on-learning-more-about-wheels.html">reinventing the wheel</a> we&#39;ll have a look at how to create a very simple key/value storage API on top of cookies.</p>
<p>We&#39;ll be using our <code>FlightMode</code> API and creating a new adapter which internally uses <a href="http://www.quirksmode.org/js/cookies.html">PPK&#39;s cookie API</a>.</p>
<p>First things first, how are we storing our data across <strong>two</strong> types cookies, one is going to be a cookie to track the IDs of the items in the store and the other will be storing the individual items. The reasons for this is we want to <a href="http://manicode.blogspot.it/2009/08/real-world-cookie-length-limits.html">avoid exceeding the limits</a> of what we can store in each cookie and additionally we want to be easily able to look up values based on a key.</p>
<p>When we create a new store we&#39;ll check if there&#39;s a <em>tracker</em> cookie, if not we&#39;ll create one:</p>
<pre class="highlighted"><code class="avrasm">var CookieAdapter = function (storeName) {
    this<span class="preprocessor">.storeName</span> = storeName<span class="comment">;</span>

    var cookie = readCookie(storeName)<span class="comment">;</span>

    if (!cookie) {
        cookie = []<span class="comment">;</span>
        createCookie(storeName, JSON<span class="preprocessor">.stringify</span>(cookie))<span class="comment">;</span>
    } else {
        cookie = JSON<span class="preprocessor">.parse</span>(cookie)<span class="comment">;</span>
    }

    this<span class="preprocessor">.cookie</span> = cookie<span class="comment">;</span>
}<span class="comment">;</span></code></pre>
<p>Now before we create an <code>add</code> method we&#39;ll need to be able to create IDs, we could do this a couple of ways, we could use the <code>length</code> of our tracking cookie or instead I&#39;m going to use a GUID, here&#39;s a simple function to generate one:</p>
<pre class="highlighted"><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">guid</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="string">'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxx'</span>.replace(<span class="regexp">/[xy]/g</span>, <span class="function"><span class="keyword">function</span> <span class="params">(c)</span> {</span>
        <span class="keyword">var</span> r = Math.random() * <span class="number">16</span> | <span class="number">0</span>;
        <span class="keyword">var</span> v = c == <span class="string">'x'</span> ? r : (r &amp; <span class="number">0x3</span> | <span class="number">0x8</span>);
        <span class="keyword">return</span> v.toString(<span class="number">16</span>);
    });
}</code></pre>
<p>Ultimately all we will be storing is JSON representations of the objects that we push into our store, here&#39;s how an <code>add</code> method would come together:</p>
<pre class="highlighted"><code class="objectivec">CookieAdapter<span class="variable">.prototype</span><span class="variable">.add</span> = function(obj) {
    var <span class="keyword">id</span> = guid();
    createCookie(<span class="keyword">id</span>, JSON<span class="variable">.stringify</span>(obj));
    <span class="keyword">this</span><span class="variable">.cookie</span><span class="variable">.push</span>(<span class="keyword">id</span>);
    createCookie(<span class="keyword">this</span><span class="variable">.storeName</span>, JSON<span class="variable">.stringify</span>(<span class="keyword">this</span><span class="variable">.cookie</span>));
    <span class="keyword">return</span> <span class="keyword">id</span>;
};</code></pre>
<p>First off we&#39;ll generate a new GUID, then insert the record as a new cookie using that ID as the cookie name. Finally we&#39;ll update tracker with the new value.</p>
<p>You can find the rest of the implementation <a href="https://github.com/aaronpowell/flight-mode-blog/src/adapters/cookie.js">in the github repository</a>.</p>
<h1>Conclusion</h1>
<p>In this part we&#39;ve taken a look at the idea of using cookies as a storage model for when our application is offline. We&#39;ve seen that they have the advantage of automatically being sent to our server as they are part of the HTTP header.</p>
<p>We&#39;ve also seen that there&#39;s some really big warning signs that say using cookies for more than just really simple state is a bad idea, they are all just stored as strings meaning that any manipulation has to be done in memory after deserializing all the data.</p>
<p>If you&#39;re curious to see an implementation of cookies for storage in the wild you can check out <a href="http://qantas.com.au">Qantas</a>, they use cookies to store information like your recent search options. There&#39;s a <code>usercontext</code> cookie that contains the information about where you are that could be wanting to start a flight from.</p>
<p>All in all cookies are not really a good option when it comes to store data for our offline application.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/flight-mode/cookies';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
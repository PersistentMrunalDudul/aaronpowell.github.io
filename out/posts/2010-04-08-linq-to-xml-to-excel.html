<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>LINQ to XML to... Excel? - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">LINQ to XML to... Excel?</h1>
                <h2>8th April 2010</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/linq.html"><span>linq</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/linq-to-xml.html"><span>linq-to-xml</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/excel.html"><span>excel</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">9th June 2010</span>
                            <h3><a href="/posts/2010-06-09-supporting-valuetypes-in-autofac.html">Supporting ValueTypes in Autofac</a></h3>
                        </header>
                        <p>Autofac doesn&#39;t support injection of value types as properties, here&#39;s how to support it.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/autofac.html"><span>autofac</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th May 2009</span>
                            <h3><a href="/posts/2009-05-19-query-syntax-vs-method-syntax.html">Query Syntax vs Method Syntax</a></h3>
                        </header>
                        <p>What&#39;s the difference with LINQ to using query syntax to pure lambda expressions?</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/linq.html"><span>linq</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">27th May 2010</span>
                            <h3><a href="/posts/2010-05-27-lucene-analyzer.html">Analyzers in Lucene.Net</a></h3>
                        </header>
                        <h2>What is an Analyzer?</h2>
<p>When you want to insert data into a Lucene index, or when you want to get the data back out of the index you will need to use an Analyzer to do this.</p>
<p>Lucene ships with ma...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/net.html"><span>.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/examine.html"><span>examine</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-examine.html"><span>umbraco-examine</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">28th August 2010</span>
                            <h3><a href="/posts/2010-08-28-testable-email-sending.html">Testable email sending</a></h3>
                        </header>
                        <p>Creating an integration test of sending an email</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/testing.html"><span>testing</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th July 2010</span>
                            <h3><a href="/posts/2010-07-10-building-an-application-with-lucene-net.html">Building an application with Lucene.Net</a></h3>
                        </header>
                        <p>A more in-depth look at how to use Lucene for storage and building a simple application</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene.html"><span>lucene</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>The other day one of the guys I work with was trying to work out the best way to generate an Excel document from .NET as the client had some wierd requirements around how the numerical data needed to be formatted (4 decimal places, but Excel treats a CSV to only show 2).</p>
<p>The next day my boss came across a link to a demo of how to use LINQ to XML to generate a XML file using the Excel schema sets which allow for direct opening in Excel.
One problem with the demo, it was using VB 9, and anyone who&#39;s seen VB 9 will know it has a really awesome way of handling XML literals in the IDE. This isn&#39;t a problem if you&#39;re coding in VB 9, but if you&#39;re in C# it can be.</p>
<p>The VB 9 video can be found here: <a href="http://msdn.microsoft.com/en-us/vbasic/bb927708.aspx"><a href="http://msdn.microsoft.com/en-us/vbasic/bb927708.aspx">http://msdn.microsoft.com/en-us/vbasic/bb927708.aspx</a></a></p>
<p>I recommend it be watched before progressing as it&#39;ll make a lot more sense against the following post. It&#39;ll also cover how to create the XML file, which I&#39;m going to presume is already done.</p>
<h2>In the beginning</h2>
<p>Because C# doesn&#39;t have a nice way to handle XML literals like VB 9 does we&#39;re going to have to do a lot of manual coding of XML, additionally we need to ensure that the appropriate namespaces are used on the appropriate nodes.</p>
<p>The Excel XML using 4 distinct namespaces, in 5 declarations (yes, I&#39;ll get to that shortly) so we&#39;ll start off by defining them like so:</p>
<pre class="highlighted"><code class="avrasm">XNamespace mainNamespace = XNamespace<span class="preprocessor">.Get</span>(<span class="string">"urn:schemas-microsoft-com:office:spreadsheet"</span>)<span class="comment">;</span>
XNamespace o = XNamespace<span class="preprocessor">.Get</span>(<span class="string">"urn:schemas-microsoft-com:office:office"</span>)<span class="comment">;</span>
XNamespace <span class="built_in">x</span> = XNamespace<span class="preprocessor">.Get</span>(<span class="string">"urn:schemas-microsoft-com:office:excel"</span>)<span class="comment">;</span>
XNamespace ss = XNamespace<span class="preprocessor">.Get</span>(<span class="string">"urn:schemas-microsoft-com:office:spreadsheet"</span>)<span class="comment">;</span>
XNamespace html = XNamespace<span class="preprocessor">.Get</span>(<span class="string">"http://www.w3.org/TR/REC-html40"</span>)<span class="comment">;</span></code></pre>
<p>Notice how the &#39;main namespace&#39; and &#39;ss&#39; are exactly the same, well this is how they are handled within the XML document. The primary namespace for the file is urn:schemas-microsoft-com:office:spreadsheet but in some locations it&#39;s also used as a prefix.</p>
<p>For this demo I&#39;m going to be using the obligatory Northwind database and I&#39;m going to just have a simple query against the customers table like so:</p>
<pre class="highlighted"><code class="avrasm">var dataToShow = from c <span class="keyword">in</span> ctx<span class="preprocessor">.Customers</span>
                 select new
                {
                    CustomerName = c<span class="preprocessor">.ContactName</span>,
                    OrderCount = c<span class="preprocessor">.Orders</span><span class="preprocessor">.Count</span>(),
                    Address = c<span class="preprocessor">.Address</span>
                }<span class="comment">;</span></code></pre>
<p>Now we have to start building our XML, the root element is named Workbook and then we have the following child groups:</p>
<ul>
<li>DocumentProperties</li>
<li>ExcelWorkbook</li>
<li>Styles</li>
<li>Worksheet</li>
<li>WorksheetOptions</li>
</ul>
<p>Each with variying child properties.</p>
<p>First thing we need to do is set up our XElement and apply the namespaces, like so:</p>
<pre class="highlighted"><code class="vbscript">XElement workbook = <span class="keyword">new</span> XElement(mainNamespace + <span class="string">"Workbook"</span>,
    <span class="keyword">new</span> XAttribute(XNamespace.Xmlns + <span class="string">"html"</span>, html),
    CreateNamespaceAtt(XName.<span class="keyword">Get</span>(<span class="string">"ss"</span>, <span class="string">"http://www.w3.org/2000/xmlns/"</span>), ss),
    CreateNamespaceAtt(XName.<span class="keyword">Get</span>(<span class="string">"o"</span>, <span class="string">"http://www.w3.org/2000/xmlns/"</span>),o),
    CreateNamespaceAtt(XName.<span class="keyword">Get</span>(<span class="string">"x"</span>, <span class="string">"http://www.w3.org/2000/xmlns/"</span>), x),
    CreateNamespaceAtt(mainNamespace),</code></pre>
<p>I&#39;m using a helper method to create the namespace attribute (which you&#39;ll be able to find in the attached source), but notice how the &quot;main&quot; namespace is the last one we attach, if we don&#39;t do it this way we&#39;ll end up with the XElement detecting the same namespace and only adding it once. Also, you need to ensure that you&#39;re prefixing the right namespace to the XElement tag!</p>
<h2>DocumentProperties and ExcelWorkbook</h2>
<p>These two node groups are not overly complex, they hold the various meta-data about the Excel document we are creating, I&#39;ll skip them as they aren&#39;t really interesting and can easily be found in the source.</p>
<h2>Styles</h2>
<p>This section is really important and handy for configuring custom looks within the document. There are way to many options to configure here to cover in the demo, it&#39;s easiest to generate the styles in Excel and save the file as an XML document (or read the XSD if you really want!). If you&#39;re doing custom styles make sure you note the ID you give the style so you can use it later in your document.</p>
<p>Also, these styles are workbook wide, not worksheet so you can reuse them on each worksheet you create. I have a very simple bold header.</p>
<h2>Generating a Worksheet</h2>
<p>Here is where the fun starts, we need to generate our worksheet. There are 4 bits of data we need to output here:</p>
<ul>
<li>Number of columns</li>
<li>Number of Rows</li>
<li>Header</li>
<li>Data Rows</li>
</ul>
<p>To illistrate the power of LINQ I&#39;ve actually dynamically generated the header row:
Update: You should get dataToShow.First() not dataToShow.ToList() so you can get the properties for the header</p>
<pre class="highlighted"><code class="cs"><span class="keyword">var</span> headerRow = <span class="keyword">from</span> p <span class="keyword">in</span> dataToShow.First().GetType().GetProperties()
                <span class="keyword">select</span> <span class="keyword">new</span> XElement(mainNamespace + <span class="string">"Cell"</span>,
                    <span class="keyword">new</span> XElement(mainNamespace + <span class="string">"Data"</span>,
                        <span class="keyword">new</span> XAttribute(ss + <span class="string">"Type"</span>, <span class="string">"String"</span>), 
                        p.Name
                        )
                    );</code></pre>
<p>This is just a little bit of fun using LINQ and Reflection to dynamically generate the column headers ;)</p>
<p>Next we need to output the number of columns and number of rows (keep in mind the rows is the data count + header row count):</p>
<pre class="highlighted"><code class="haskell"><span class="title">new</span> <span class="type">XAttribute</span>(ss + <span class="string">"ExpandedColumnCount"</span>, headerRow.<span class="type">Count</span>()),
<span class="title">new</span> <span class="type">XAttribute</span>(ss + <span class="string">"ExpandedRowCount"</span>, <span class="typedef">dataToShow.<span class="type">Count</span><span class="container">()</span> + 1),</span></code></pre>
<p>Now we put out the header cells:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">new</span> XElement(mainNamespace + <span class="string">"Row"</span>,
    <span class="keyword">new</span> XAttribute(ss + <span class="string">"StyleID"</span>, <span class="string">"Header"</span>),
    headerRow
),</code></pre>
<p>Then lastly we generate the data cells (note - this can be done like the header, just chose to do it differently to illistrate that it can be done several ways):</p>
<p><img src="http://www.aaron-powell.com/get/media/1198/linq_to_excel001.png" alt=""></p>
<p>(yes I used an image this time, the formatting is a real bitch in the Umbraco WYSIWYG editor!).</p>
<p>Lastly there needs to be a WorksheetOptions node, and then you can combine all the XElements together, add it to an XDocument object and save!</p>
<p>There you have it, how to create an Excel document using LINQ to XML and C#.</p>
<p><a href="/get/csharp/excelgenerator.zip">Download the source here.</a></p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/linq-to-xml-to-excel';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
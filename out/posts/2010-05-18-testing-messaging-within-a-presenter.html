<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Testing Messaging Within a Presenter - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Testing Messaging Within a Presenter</h1>
                <h2>18th May 2010</h2>
                <ul class="tags">
    
        
            <li><a class="icon icon-tag" href="/tagged/asp-net.html"><span>asp.net</span></a></li>
        
            <li><a class="icon icon-tag" href="/tagged/webforms-mvp.html"><span>webforms-mvp</span></a></li>
        
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th January 2011</span>
                            <h3><a href="/posts/2011-01-19-find-name-from-field.html">How to get the field name for a model property</a></h3>
                        </header>
                        <p>Ever needed to find the name that&#39;ll be generated for a property in MVC? Here&#39;s how</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/asp-net.html"><span>asp.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/mvc.html"><span>mvc</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">29th June 2010</span>
                            <h3><a href="/posts/2010-06-29-unit-testing-with-umbraco.html">Unit Testing with Umbraco</a></h3>
                        </header>
                        <p>A wrap up from my talk on doing unit tested ASP.NET with Umbraco</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net.html"><span>asp.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/unit-testing.html"><span>unit-testing</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/webformsmvp.html"><span>webformsmvp</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">16th June 2010</span>
                            <h3><a href="/posts/2010-06-16-aspnet-mvc-xml-action-result.html">ASP.NET MVC XML Action Result</a></h3>
                        </header>
                        <p>An easy way to return XML from ASP.NET MVC</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/asp-net.html"><span>asp.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/xml.html"><span>xml</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th June 2010</span>
                            <h3><a href="/posts/2010-06-14-aspnet-mvc-model-binding-with-implicit-operators.html">ASP.NET MVC Model binding with implicit operators</a></h3>
                        </header>
                        <p>Using implicit operators in model binding with ASP.NET MVC</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/asp-net.html"><span>asp.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/c-.html"><span>c#</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/model-binding.html"><span>model-binding</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">4th April 2010</span>
                            <h3><a href="/posts/2010-04-04-web-dev.html">Web Development</a></h3>
                        </header>
                        <p>Articles on the topic of web development</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net.html"><span>asp.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>Cross-Presenter messaging is a great way which you can have two presenters which don&#39;t know about each other, but may have a reliance on data from the other.</p>
<p>There&#39;s a <a href="http://wiki.webformsmvp.com/index.php?title=SC009">good demo</a> up on the WebForms MVP wiki which shows how it can be implemented.</p>
<p>One really handy feature of this is that you can have something happen when the message never arrives. Lets say for example we have a presenter which shows a set of promotions pulled from a global store. But I also want the ability to set the promotions on a per-page basis. So if there&#39;s no promo&#39;s for this page I want to see the global ones.</p>
<h2>Setup</h2>
<p>I&#39;ll have my promotions presenter like this:</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="id">PromoPresenter</span> : <span class="id">Presenter</span>&lt;<span class="id">IView</span>&lt;<span class="id">PromoModel</span>&gt;&gt; {</span>
    <span class="keyword">private</span> IPromoService service;
    <span class="keyword">public</span> PromoPresenter(IView&lt;PromoModel&gt; view, IPromoService service) : base(view) {
        <span class="keyword">this</span><span class="variable">.service</span> = service;
        <span class="keyword">this</span><span class="variable">.View</span><span class="variable">.Load</span> += View_Load;
    }

    <span class="keyword">void</span> View_Load(object sender, EventArgs e) {
        <span class="comment">//TODO</span>
    }

    <span class="keyword">public</span> <span class="keyword">void</span> ReleaseView() {
        <span class="keyword">this</span><span class="variable">.View</span><span class="variable">.Load</span> -= View_Load;
    }
}</code></pre>
<p>Now I need to add some functionality to the <code>View_Load</code> method so that it loads in from either the messages or not (ignore the implementation of IPromoService, it&#39;s not important for this demo).</p>
<pre class="highlighted"><code class="objectivec">    <span class="keyword">void</span> View_Load(object sender, EventArgs e) {
        Messages<span class="variable">.Subscribe</span>&lt;IEnumerable&lt;IPromo&gt;&gt;(promos =&gt; <span class="keyword">this</span><span class="variable">.View</span><span class="variable">.Model</span><span class="variable">.Promos</span> = promos, () =&gt; <span class="keyword">this</span><span class="variable">.View</span><span class="variable">.Model</span><span class="variable">.Promos</span> = <span class="keyword">this</span><span class="variable">.service</span><span class="variable">.GetGlobalPromos</span>());
    }</code></pre>
<p>So we also need a <code>PagePresenter</code> which may have promo boxes that are in-context to display.</p>
<pre class="highlighted"><code class="objectivec"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="id">PagePresenter</span> : <span class="id">Presenter</span>&lt;<span class="id">IView</span>&lt;<span class="id">PageModel</span>&gt;&gt; {</span>
    <span class="keyword">private</span> IContentService service;

    <span class="keyword">public</span> PagePresenter(IView&lt;PageModel&gt; view, IContentService service) : base(view) {
        <span class="keyword">this</span><span class="variable">.service</span> = service;
        <span class="keyword">this</span><span class="variable">.View</span><span class="variable">.Load</span> += View_Load;
    }

    <span class="keyword">void</span> View_Load(object sender, EventArgs e) {
        var page = <span class="keyword">this</span><span class="variable">.service</span><span class="variable">.CurrentPage</span>();
        <span class="comment">//set some model stuff about the page</span>
        Messages<span class="variable">.Publish</span>&lt;IEnumerable&lt;IPromo&gt;&gt;(page<span class="variable">.Promotions</span>);
    }

    <span class="keyword">public</span> <span class="keyword">void</span> ReleaseView() {
        <span class="keyword">this</span><span class="variable">.View</span><span class="variable">.Load</span> -= View_Load;
    }
}</code></pre>
<h2>Unit Testing</h2>
<p>This is pretty simple, and it <em>should just work</em>, but I&#39;m a good developer, so how do I setup the unit tests to ensure that the right methods are called?</p>
<p>We need to simulate the underlying MessageBus of WebForms MVP, but that&#39;s nothing you need to worry about when working with WebForms MVP, it does that on our behalf.</p>
<p>And this is a situation I found myself in, I wanted to test both the message received and message not received functionality. So I started off looking into the source for WebForms MVP, they have tests kind of doing what I wanted, but not the full end-to-end which I required.</p>
<p>So let&#39;s look at how to do it:</p>
<p><em>A few assumptions, I&#39;m using MS Test and RhinoMocks</em></p>
<pre class="highlighted"><code class="avrasm">[TestMethod]
public void PromoPresenterTests_From_Service_When_No_Message_Published() {
    //Arrange
    var view = MockRepository<span class="preprocessor">.GenerateStub</span>&lt;IView&lt;PromoModel&gt;&gt;()<span class="comment">;</span>
    view<span class="preprocessor">.Model</span> = new PromoModel()<span class="comment">;</span>
    var service = MockRepository<span class="preprocessor">.GenerateMock</span>&lt;IContentService&gt;()<span class="comment">;</span>
    service<span class="preprocessor">.Expect</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.GetGlobalPromos</span>())<span class="preprocessor">.Return</span>(MockRepository<span class="preprocessor">.CreateStub</span>&lt;IEnumerable&lt;IPromo&gt;&gt;())<span class="comment">;</span>

    var presenter = new PromoPresenter(view, service)<span class="comment">;</span>
    var messageCoordinator = new MessageCoordinator()<span class="comment">;</span>
    presenter<span class="preprocessor">.Messages</span> = messageCoordinator<span class="comment">;</span>

    //Act
    view<span class="preprocessor">.Raise</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Load</span> += null, null, null)<span class="comment">;</span>
    presenter<span class="preprocessor">.ReleaseView</span>()<span class="comment">;</span>
    messageCoordinator<span class="preprocessor">.Close</span>()<span class="comment">;</span>

    //Assert
    Assert<span class="preprocessor">.IsNotNull</span>(view<span class="preprocessor">.Model</span><span class="preprocessor">.Promos</span>)<span class="comment">;</span>
    service<span class="preprocessor">.VerifyAllExpectations</span>()<span class="comment">;</span>
}</code></pre>
<p>There&#39;s not much different I&#39;d have done if it was just a standard WebForms MVP test (or any other test for that matter) but I&#39;m putting an expectation of my IContentService that I am calling the <code>GetGlobalPromos</code> method. What comes back is not important, just that something comes back.</p>
<p>Next you need to setup a <code>MessageCoordinator</code>. This is what is responsible for the MessageBus, handling the publishing and subscription of the events.</p>
<p>You can either make a mock version if you want to be really explicit and set an expectation on the <code>Messages.Subscribe</code> call, but I&#39;m not wanting that. I&#39;ll just use the <code>MessageCoordinator</code> class which comes from WebForms MVP itself. This also means that I&#39;m getting it operate pretty much the same as if it was really running.</p>
<p>Since this test is verifying the <em>no messages published</em> operation I just want to close the MessageCoordinator as soon as I&#39;ve raised the <code>View.Load</code> event, (which is where the subscription happens).</p>
<p>Next we&#39;ll test the <code>Message.Publish</code> will work like we expect it to:</p>
<pre class="highlighted"><code class="avrasm">[TestMethod]
public void PromoPresenterTests_No_Service_When_Published() {
    //Arrange
    var view = MockRepository<span class="preprocessor">.GenerateStub</span>&lt;IView&lt;PromoModel&gt;&gt;()<span class="comment">;</span>
    view<span class="preprocessor">.Model</span> = new PromoModel()<span class="comment">;</span>
    var service = MockRepository<span class="preprocessor">.GenerateMock</span>&lt;IContentService&gt;()<span class="comment">;</span>

    var presenter = new PromoPresenter(view, service)<span class="comment">;</span>
    var messageCoordinator = new MessageCoordinator()<span class="comment">;</span>
    presenter<span class="preprocessor">.Messages</span> = messageCoordinator<span class="comment">;</span>

    //Act
    view<span class="preprocessor">.Raise</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Load</span> += null, null, null)<span class="comment">;</span>
    presenter<span class="preprocessor">.ReleaseView</span>()<span class="comment">;</span>
    messageCoorindator<span class="preprocessor">.Publish</span>(MockRepository<span class="preprocessor">.CreateStub</span>&lt;IEnumerable&lt;IPromo&gt;&gt;())<span class="comment">;</span>
    messageCoordinator<span class="preprocessor">.Close</span>()<span class="comment">;</span>

    //Assert
    Assert<span class="preprocessor">.IsNotNull</span>(view<span class="preprocessor">.Model</span><span class="preprocessor">.Promos</span>)<span class="comment">;</span>
    service<span class="preprocessor">.AssertWasNotCalled</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.GetGlobalPromos</span>())<span class="comment">;</span>
}    </code></pre>
<p>This test is basically the same as the last one, but instead of setting an expectation on the <code>GetGlobalPrommos</code> method I&#39;m putting an <code>AssertWasNotCalled</code> which is an extension method from RhinoMocks.</p>
<p>Also, we&#39;re doing a <code>Publish</code> via our MessageCoordinator, before we close it off, which is how we would expect it to run in the web implementation (yes, you could setup an expectation on your mock objects if you want to go deeply into it).</p>
<h3>PagePresenter?</h3>
<p>You&#39;ll notice that the tests here are only covering the <code>PromoPresenter</code>, not the <code>PagePresenter</code>. Well to do a full test you would need something like this:</p>
<pre class="highlighted"><code class="avrasm">[TestMethod]
public void PromoPresenterTests_Published_From_Other_Presenter() {
    //Arrange
    var promoView = MockRepository<span class="preprocessor">.GenerateStub</span>&lt;IView&lt;PromoModel&gt;&gt;()<span class="comment">;</span>
    promoView<span class="preprocessor">.Model</span> = new PromoModel()<span class="comment">;</span>
    var service = MockRepository<span class="preprocessor">.GenerateMock</span>&lt;IContentService&gt;()<span class="comment">;</span>

    var promoPresenter = new PromoPresenter(promoView, service)<span class="comment">;</span>
    var messageCoordinator = new MessageCoordinator()<span class="comment">;</span>
    promoPresenter<span class="preprocessor">.Messages</span> = messageCoordinator<span class="comment">;</span>

    var pageView = MockRepository<span class="preprocessor">.GenerateStub</span>&lt;IView&lt;PageModel&gt;&gt;()<span class="comment">;</span>
    var page = MockRepository<span class="preprocessor">.GenerateStub</span>&lt;IPage&gt;()<span class="comment">;</span>
    page<span class="preprocessor">.Stub</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Promotions</span>)<span class="preprocessor">.Return</span>(MockRepository<span class="preprocessor">.CreateStub</span>&lt;IEnumerable&lt;IPromo&gt;&gt;())<span class="comment">;</span>
    service<span class="preprocessor">.Stub</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.CurrentPage</span>())<span class="preprocessor">.Return</span>(page)<span class="comment">;</span>
    var pagePresenter = new PagePresenter(pageView, service)<span class="comment">;</span>

    //Act
    promoView<span class="preprocessor">.Raise</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Load</span> += null, null, null)<span class="comment">;</span>
    pageView<span class="preprocessor">.Raise</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.Load</span> += null, null, null)<span class="comment">;</span>
    promoPresenter<span class="preprocessor">.ReleaseView</span>()<span class="comment">;</span>
    pagePresenter<span class="preprocessor">.ReleaseView</span>()<span class="comment">;</span>
    messageCoordinator<span class="preprocessor">.Close</span>()<span class="comment">;</span>

    //Assert
    Assert<span class="preprocessor">.IsNotNull</span>(view<span class="preprocessor">.Model</span><span class="preprocessor">.Promos</span>)<span class="comment">;</span>
    service<span class="preprocessor">.AssertWasNotCalled</span>(<span class="built_in">x</span> =&gt; <span class="built_in">x</span><span class="preprocessor">.GetGlobalPromos</span>())<span class="comment">;</span>
}</code></pre>
<p>Here we&#39;re creating both presenters, using their views and raising their load events so that the Messages should be passed around correctly.</p>
<h2>Conclusion</h2>
<p>The Messaging system of WebForms MVP is really powerfully, and hopefully this has show you just how you can do all your unit testing around it.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/testing-messaging-within-a-presenter';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
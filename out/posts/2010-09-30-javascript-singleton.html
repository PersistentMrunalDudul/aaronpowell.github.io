<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>JavaScript functions that rewrite themselves for a Singleton pattern | LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">JavaScript functions that rewrite themselves for a Singleton pattern</h1>
                <h2>30th September 2010</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
    
        <li><a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">9th August 2011</span>
                            <h3><a href="/posts/2011-08-09-a-story.html">JavaScript: A story</a></h3>
                        </header>
                        <p>Everyone use to notice the old war veteran that sat on the corner. His uniform was tatty and he’s always be spouting about his heyday with lines like “Don’t  you remember my role in the first brows...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/random.html"><span>random</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">19th April 2013</span>
                            <h3><a href="/posts/2013-04-19-ie-useragents.html">Internet Explorer userAgents</a></h3>
                        </header>
                        <p>A new program from the IE team</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th January 2013</span>
                            <h3><a href="/posts/2013-01-14-ie10-console-thoughts.html">Making the Internet Explorer JavaScript tools better, again</a></h3>
                        </header>
                        <p>A look at what&#39;s changed since I last pointed out the failings of the IE dev tools</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/internet-explorer.html"><span>internet-explorer</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web-dev.html"><span>web-dev</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">7th January 2013</span>
                            <h3><a href="/posts/2013-01-07-thoughts-on-typescript.html">Thoughts on TypeScript</a></h3>
                        </header>
                        <p>Some of my impressions from trying to implement something in TypeScript</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/typescript.html"><span>typescript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">18th October 2012</span>
                            <h3><a href="/posts/2012-10-18-dbjs-chrome.html">Chrome support for db.js</a></h3>
                        </header>
                        <p>A little word on the db.js support for Chrome</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/indexeddb.html"><span>indexeddb</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/chrome.html"><span>chrome</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/web.html"><span>web</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>Recently I was building a JavaScript application which was quite complex and involved a bit of server interaction with some AJAX requests. The AJAX was just doing some one-time data loading, and the reason I was using AJAX was to lazy-load some of the information on the page.</p>
<p>Since the methods going back to the server were to be called multiple times and I wanted caching of the server response I needed to have the method a bit aware that the server call had responded and not to do it again. Essentially what I was wanting to do was have a <a href="http://en.wikipedia.org/wiki/Singleton_pattern">Singleton</a> implemented, but this is really just a method call, so we need to Singleton a method... hmm...</p>
<p>Well let&#39;s have a look at how to do that.</p>
<h1>Functions writing functions</h1>
<p>Let&#39;s think about what we&#39;re trying to do here, we&#39;re trying to make a function run and then run again but perform a bit differently the next time around, and there&#39;s a few different ways to do this. One of the ways you can do this is with logic branches, <code>if something then ... else ... endif</code>, sure that&#39;s easy, but it&#39;s totally not crazy enough for me, could we do <code>if something then replace function else call original endif</code>? Well the answer is yes, and that&#39;s what we&#39;re going to do, the function is going to <strong>rewrite itself during its execution!</strong></p>
<h1>It&#39;s exploitation I tell you!</h1>
<p>So what we&#39;re wanting to do is take advantage of the way that JavaScript closure works. I&#39;m not going to go into detail about explaining closure, <a href="http://stackoverflow.com/questions/111102/how-does-a-javascript-closure-work">if you&#39;re interested check this post out</a>, but what we&#39;re going to use is the fact that a variable defined outside a function can be assigned within that function.</p>
<p>Let&#39;s look at a very basic example:</p>
<pre class="highlighted"><code class="rust">var <span class="keyword">fn</span>;
<span class="function"><span class="keyword">fn</span> = <span class="title">function</span>(</span>) {
    <span class="function"><span class="keyword">fn</span> = <span class="title">function</span>(</span>) {
        console.<span class="keyword">log</span>(<span class="string">"I've been replaced!"</span>);
    };
    console.<span class="keyword">log</span>(<span class="string">"Thanks for the call"</span>);
};
<span class="keyword">fn</span>(); <span class="comment">//Thanks for the call</span>
<span class="keyword">fn</span>(); <span class="comment">//I've been replaced!</span></code></pre>
<p>If you run this in a browser (that supports <code>console.log</code>, eg: Firefox, Chrome and IE9)  the first time the function is called you&#39;ll get the output <strong>Thanks for the call</strong> and then every subsequent call will output <strong>I&#39;ve been replaced!</strong>.</p>
<p>Awesome!</p>
<p>The reason this works is because we&#39;re creating a variable called <code>fn</code> which we can access within the scope of then <code>fn</code> function body, and because we can access the variable we can reassign it! So when <code>fn</code> runs it rewrites itself, but it has its own function body that it executes.</p>
<p>This allows you to do some crazy things, like this:</p>
<pre class="highlighted"><code class="rust">var <span class="keyword">fn</span>;
<span class="function"><span class="keyword">fn</span> = <span class="title">function</span>(</span>) {
    <span class="function"><span class="keyword">fn</span> = <span class="title">function</span>(</span>) {
        <span class="keyword">fn</span>();
    };
    console.<span class="keyword">log</span>(<span class="string">"Thanks for the call"</span>);
};
<span class="keyword">fn</span>(); <span class="comment">//Thanks for the call</span>
<span class="keyword">fn</span>(); <span class="comment">//results in a stack overflow</span></code></pre>
<p>I wouldn&#39;t advise this, it&#39;s a good way to make a mess of some code :P. This was more just to illustrate a point.</p>
<h1>Real world scenario</h1>
<p>The example we&#39;ve seen above is fairly sandboxed, it doesn&#39;t really take into account the method being a method of a JavaScript object, doesn&#39;t take into account the AJAX or anything like that. It illustrates the point nicely, but let&#39;s expand on it.</p>
<p>First off let&#39;s create a little JavaScript object to play with:</p>
<pre class="highlighted"><code class="javascript">myObject = (<span class="keyword">function</span>() {
    <span class="keyword">var</span> _<span class="keyword">this</span>;
    _<span class="keyword">this</span> = {
        getData: <span class="keyword">function</span>(callback) {

        }
    };    
    <span class="keyword">return</span> _<span class="keyword">this</span>;
})();</code></pre>
<p>I&#39;m creating an object called <code>myObject</code> (imaginative I know) that will be sitting at the <code>window</code> level, and had a single public method <code>getData(callback)</code>. The method will take a function as an argument which we&#39;ll invoke when the server response is completed. Doing a callback for an AJAX request is an easy way to expose the successful response method without having to expose the AJAX API.</p>
<p>Now let&#39;s go about implementing the body of the function:</p>
<pre class="highlighted"><code class="haskell"><span class="title">myObject</span> = (function() {
    var _this;
    _this = {
        getData: function(callback) {
            $.ajax({
                <span class="typedef"><span class="keyword">type</span>: "<span class="type">POST</span>",</span>
                contentType: <span class="string">"application/json; charset=utf-8"</span>,
                url:<span class="string"> '/MyService.asmx/SomeMethod'</span>,
                success: function (<span class="typedef"><span class="keyword">data</span>) <span class="container">{
                    <span class="title">_this</span>.<span class="title">getData</span> = <span class="title">function</span>(<span class="title">callback</span>) {
                        <span class="title">callback</span>.<span class="title">apply</span>(<span class="title">_this</span>, [<span class="title">data</span>]);
                    }</span>;</span>

                    callback.apply(_this, [<span class="typedef"><span class="keyword">data</span>]);</span>
                }
            });
        }
    };    
    return _this;
})();</code></pre>
<p>Here we&#39;re using jQuery (it&#39;ll just make it a bit less verbose for the demo) and then we&#39;re calling a web service method, that is all fairly standard, the interesting stuff is within the body of the <em>success</em> property:</p>
<pre class="highlighted"><code class="haskell"><span class="title">success</span>: function (<span class="typedef"><span class="keyword">data</span>) <span class="container">{
    <span class="title">_this</span>.<span class="title">getData</span> = <span class="title">function</span>(<span class="title">callback</span>) {
        <span class="title">callback</span>.<span class="title">apply</span>(<span class="title">_this</span>, [<span class="title">data</span>]);
    }</span>;</span>

    callback.apply(_this, [<span class="typedef"><span class="keyword">data</span>]);</span>
}</code></pre>
<p>This is the function which jQuery will invoke when the server successfully returns (and we&#39;re assuming that it returns some data). When the method is called we&#39;ll execute the callback (and by using <code>callback.apply</code> we can specify the internal scope of the object, so the <code>this</code> scope will be the <code>myObject</code>).</p>
<p>And like we did in our early example here we&#39;re running a piece of code to rewrite the function when it executes. The thing is that we now have an object, so we can&#39;t use the trick we were using before, instead this time what we&#39;re doing is <strong>assigning the method on the object which was created</strong>. This is the key point here, if we don&#39;t have a reference back to the object then we can&#39;t reassign it. It is true that this demo could use <code>myObject.getData</code>, since it&#39;s a static method on the object, but I wanted the demo to cover if you are using a class implementation.</p>
<h1>Conclusion</h1>
<p>That wraps it all up, we&#39;ve see how we can create functions in JavaScript which will rewrite themselves to simulate a Singleton. The ultimate usefulness of this code is up for debate, but it is a good example of how you can do some really funky stuff with JavaScript.</p>
<p>Just be careful you don&#39;t make your rewriting functions too smart or they may become sentient!</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/javascript-singleton';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
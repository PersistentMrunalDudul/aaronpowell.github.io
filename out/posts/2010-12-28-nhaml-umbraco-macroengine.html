<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>NHaml Umbraco MacroEngine - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">NHaml Umbraco MacroEngine</h1>
                <h2>28th December 2010</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th September 2012</span>
                            <h3><a href="/posts/2012-09-05-text-casing-and-examine.html">Text casing and Examine</a></h3>
                        </header>
                        <p>A few times I&#39;ve seen questions posted on the Umbraco forums which ask how to deal with case insensitivity text with Examine, and itâ€™s also something that we&#39;ve had to handle a few times within our...</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/lucene-net.html"><span>lucene.net</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/examine.html"><span>examine</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">11th July 2012</span>
                            <h3><a href="/posts/2012-07-11-using-mvc-in-umbraco-4-revisited.html">Revisiting using ASP.NET MVC in Umbraco 4</a></h3>
                        </header>
                        <p>An update on using ASP.NET MVC with Umbraco 4.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">25th June 2012</span>
                            <h3><a href="/posts/2012-06-25-i-helped-kill-umbraco-5.html">I helped kill Umbraco 5</a></h3>
                        </header>
                        <p>Hi, my name&#39;s Aaron Powell and I was involved in killing Umbraco 5.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/umbraco-5.html"><span>umbraco-5</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/opinionated.html"><span>opinionated</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">13th June 2012</span>
                            <h3><a href="/posts/2012-06-13-introducing-umbraco-contributor-list.html">Introducing the Umbraco contributor mailing list</a></h3>
                        </header>
                        <p>Keen discuss contributing to Umbraco&#39;s core, join the discussion now!</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">12th June 2012</span>
                            <h3><a href="/posts/2012-06-12-using-mvc-in-umbraco-4.html">Using ASP.NET MVC in Umbraco 4</a></h3>
                        </header>
                        <p>How to combine ASP.Net MVC applications with an Umbraco project</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/umbraco.html"><span>umbraco</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/asp-net-mvc.html"><span>asp.net-mvc</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In a <a href="/custom-umbraco-macro-engines">previous post</a> I introduced the new <code>IMacroEngine</code> interface coming as part of Umbraco Juno (4.6) which will make it possible to create your own Macro Engines. In this article I&#39;ll look at what is required to create a custom Macro Engine which is actually useful.</p>
<h2>Implementing a Haml-based macro engine</h2>
<p>I&#39;m quite a fan of <a href="http://haml-lang.com">Haml</a>, it&#39;s a good abstraction on top of HTML (well, XML really) and it&#39;s quite popular if you&#39;re doing Ruby work (it&#39;s really popular in the Ruby community). </p>
<p>A Haml file would look something like this:</p>
<pre class="highlighted"><code class="applescript">.content
    this <span class="keyword">is</span> <span class="keyword">the</span> <span class="type">text</span> content <span class="keyword">of</span> a page
    a{:href =&gt; <span class="string">"http://aaron-powell.com"</span>} My Website</code></pre>
<p>And generates a snippet like this:</p>
<pre class="highlighted"><code class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"content"</span>&gt;</span>
    this is the text content of a page <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"http://aaron-powell.com"</span>&gt;</span>My Website<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre>
<p>There&#39;s a .NET port of Haml, <a href="http://code.google.com/p/nhaml/">NHaml</a>, so let&#39;s have a look at how we can implement a macro engine which allows us to use Haml as an Umbraco macro engine.</p>
<p>I&#39;ve started by grabbing the latest version of NHaml from their website, a copy of Umbraco Juno and fired up Visual Studio. I created a new .NET class library and added the following references:</p>
<ul>
<li>NHaml</li>
<li>cms</li>
<li>interfaces</li>
<li>businesslogic</li>
</ul>
<p>Next I created my Macro Engine:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">class</span> NHamlMacroEngine : IMacroEngine
{
    <span class="keyword">public</span> NHamlMacroEngine()
    {
        SupportedExtensions = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;
                                  {
                                      <span class="string">"nhaml"</span>,
                                      <span class="string">"haml"</span>
                                  };
    }
    <span class="keyword">public</span> <span class="keyword">bool</span> Validate(<span class="keyword">string</span> code, INode currentPage, <span class="keyword">out</span> <span class="keyword">string</span> errorMessage)
    {
        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
    }

    <span class="keyword">public</span> <span class="keyword">string</span> Execute(MacroModel macro, INode currentPage)
    {
        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplemented Exception
    }

    <span class="keyword">public</span> <span class="keyword">string</span> Name { <span class="keyword">get</span> { <span class="keyword">return</span> <span class="string">"Haml Macro Engine"</span>; } }
    <span class="keyword">public</span> List&lt;<span class="keyword">string</span>&gt; SupportedExtensions { <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; }
    <span class="keyword">public</span> Dictionary&lt;<span class="keyword">string</span>, IMacroGuiRendering&gt; SupportedProperties
    {
        <span class="keyword">get</span>
        {
            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
        }
    }
}</code></pre>
<p>With my macro engine I&#39;m going to support files with a <strong>haml</strong> and <strong>nhaml</strong> extension (so existing templates can be used) and it&#39;s specified in the constructor (you can set this as the return of the property but I don&#39;t see the need to create the List each time the property is accessed ;)).</p>
<h3>Implementing macro execution</h3>
<p>The crux of what we have to build for a Macro Engine is in the <code>Execute</code> method. This method is nicely providing us with the macro itself and the current page (which all current macro engines provide to users), so how do we go about it?</p>
<p>Now we&#39;re going to delve into NHaml and what is actually required to execute our file.</p>
<p>The heavy lifting for most of our work will be done via the <code>TemplateEngine</code> class from NHaml, but I&#39;m going to have a bit of a wrapper:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> <span class="keyword">class</span> NHamlTemplateEngine : ITemplateContentProvider
{
    <span class="keyword">public</span> IList&lt;<span class="keyword">string</span>&gt; PathSources { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    <span class="keyword">public</span> IViewSource GetViewSource(<span class="keyword">string</span> templateName)
    {
        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
    }
    <span class="keyword">public</span> IViewSource GetViewSource(<span class="keyword">string</span> templatePath, IList&lt;IViewSource&gt; parentViewSourceList)
    {
        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
    }
    <span class="keyword">public</span> <span class="keyword">void</span> AddPathSource(<span class="keyword">string</span> pathSource)
    {
        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();
    }
}</code></pre>
<p>I&#39;m going to ignore a lot of what this class does (partially cuz I couldn&#39;t be bothered working out what it does :P), instead I&#39;ll just be implementing the <code>GetViewSource</code> method:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">public</span> IViewSource GetViewSource(<span class="keyword">string</span> templateName)
{
    <span class="keyword">return</span> <span class="keyword">new</span> FileViewSource(<span class="keyword">new</span> FileInfo(templateName));
}</code></pre>
<p>What we&#39;re doing here is returning the standard OOTB IViewSource implementation, it&#39;ll read the Haml file in from the file system and perform its black magic.</p>
<p>There&#39;s currently no way which we can get the single string result back from the template to be used with the macro, so let&#39;s work on that.</p>
<p>First I&#39;m going to be adding a new method to the <code>NHamlTemplateEngine</code> which will return a string from our template to give back to the macro engine:</p>
<pre class="highlighted"><code class="avrasm">public string Render(MacroModel macro, INode node)
{
    var templateEngine = new TemplateEngine()<span class="comment">;</span>
    templateEngine<span class="preprocessor">.Options</span><span class="preprocessor">.TemplateContentProvider</span> = this<span class="comment">;</span>
    CompiledTemplate res = templateEngine<span class="preprocessor">.Compile</span>(IOHelper<span class="preprocessor">.MapPath</span>(SystemDirectories<span class="preprocessor">.Python</span> + <span class="string">"/"</span> + macro<span class="preprocessor">.ScriptName</span>))<span class="comment">;</span>

    using (var output = new StringWriter())
    {
        var instance = res<span class="preprocessor">.CreateInstance</span>()<span class="comment">;</span>
        instance<span class="preprocessor">.Render</span>(output)<span class="comment">;</span>
        return output<span class="preprocessor">.ToString</span>()<span class="comment">;</span>
    }
}</code></pre>
<p>Now we&#39;ll finish off our <code>IMacroEngine</code> implementation by implementing the <code>Execute</code> method:</p>
<pre class="highlighted"><code class="nginx"><span class="title">public</span> string Execute(MacroModel macro, INode currentPage)
{
    <span class="title">var</span> engine = new NHamlTemplateEngine();
    <span class="title">var</span> output = engine.Render(macro, currentPage);
    <span class="title">return</span> output;
}</code></pre>
<p>Compile, drop the assembling into a Juno install and create a sample little Macro:</p>
<pre class="highlighted"><code class="perl"><span class="variable">%p</span>
  some content here</code></pre>
<p>Add the macro to a page and booyeah, we are running our own template engine. You can now write Haml and output it within Umbraco.</p>
<h2>Extending our implementation</h2>
<p>Ok, so we&#39;ve done our implementation, but it&#39;s a bit limited, there&#39;s two things which we aren&#39;t really handling:</p>
<ul>
<li>How do I access the currentPage in the macro?</li>
<li>Can I use the new inline macro feature?</li>
</ul>
<h3>Supporting inline macros</h3>
<p>This is a rather easy feature to support, the <code>MacroModel</code> which has been passed in has a property which we can access that, this comes through the <code>ScriptCode</code> property of the macro.</p>
<p>But wait, we&#39;re passing in the phyisical template to NHaml, what are we going to do about that? Well I decided to do it a funky little way, we&#39;ll actually generate the file(s) as needed for our inline macros:</p>
<pre class="highlighted"><code class="avrasm">public string Render(MacroModel macro, INode node)
{
    var templateEngine = new TemplateEngine()<span class="comment">;</span>
    templateEngine<span class="preprocessor">.Options</span><span class="preprocessor">.TemplateContentProvider</span> = this<span class="comment">;</span>
    CompiledTemplate res<span class="comment">;</span>
    if (string<span class="preprocessor">.IsNullOrEmpty</span>(macro<span class="preprocessor">.ScriptCode</span>))
    {
        res = templateEngine<span class="preprocessor">.Compile</span>(IOHelper<span class="preprocessor">.MapPath</span>(SystemDirectories<span class="preprocessor">.Python</span> + <span class="string">"/"</span> + macro<span class="preprocessor">.ScriptName</span>))<span class="comment">;</span>
    }
    else
    {
        var hash = GetMd5Hash(macro<span class="preprocessor">.ScriptCode</span>)<span class="comment">;</span>
        var path = IOHelper<span class="preprocessor">.MapPath</span>(SystemDirectories<span class="preprocessor">.Data</span> + <span class="string">"/"</span> + hash + <span class="string">".haml"</span>)<span class="comment">;</span>
        if (!File<span class="preprocessor">.Exists</span>(path))
        {
            using (var writer = new StreamWriter(path))
            {
                writer<span class="preprocessor">.Write</span>(macro<span class="preprocessor">.ScriptCode</span>)<span class="comment">;</span>
            }
        }
        res = templateEngine<span class="preprocessor">.Compile</span>(path)<span class="comment">;</span>
    }
    using (var output = new StringWriter())
    {
        var instance = res<span class="preprocessor">.CreateInstance</span>()<span class="comment">;</span>
        instance<span class="preprocessor">.Render</span>(output)<span class="comment">;</span>
        return output<span class="preprocessor">.ToString</span>()<span class="comment">;</span>
    }
}</code></pre>
<p>This is adding basic caching into the templates, so it generates a MD5 hash from the code to use as a filename, if it exists in the &#39;data&#39; folder (ie - App_Data) it&#39;ll be used, otherwise a new file is created from it. Now we&#39;ve got a real file which we can pass into the NHaml engine.</p>
<p>That&#39;s it, now we&#39;ve got support for:</p>
<pre class="highlighted"><code class="xml"><span class="tag">&lt;<span class="title">umbraco:Macro</span> <span class="attribute">runat</span>=<span class="value">"server"</span> <span class="attribute">Language</span>=<span class="value">"haml"</span>&gt;</span>
.class
  woo, content!
<span class="tag">&lt;/<span class="title">umbraco:Macro</span>&gt;</span></code></pre>
<h3>Supporting currentPage</h3>
<p>Next on the check list of what our NHaml macro engine requires is the ability to access the <code>currentPage</code> object, and this is a bit trickier. Because Haml is just a markup layer it doesn&#39;t know anything about Umbraco, nor does it know anything about the data that exists. For this we&#39;ve got to create our own <code>Template</code> class which NHaml will use when executing the Haml file.</p>
<p>First off I&#39;m going to do some refactoring to move the NHaml template engine creation into the constructor of our engine:</p>
<pre class="highlighted"><code class="avrasm">private readonly TemplateEngine _templateEngine<span class="comment">;</span>

internal NHamlTemplateEngine()
{
    _templateEngine = new TemplateEngine()<span class="comment">;</span>
    _templateEngine<span class="preprocessor">.Options</span><span class="preprocessor">.TemplateContentProvider</span> = this<span class="comment">;</span>
    _templateEngine<span class="preprocessor">.Options</span><span class="preprocessor">.TemplateBaseType</span> = typeof(NHamlTemplate)<span class="comment">;</span>
}</code></pre>
<p>This is more of a .NET preference of mine to have stuff such as this to be done in the constructor of the object, what you&#39;ll notice is the new line:</p>
<pre class="highlighted"><code class="haskell"><span class="title">_templateEngine</span>.<span class="type">Options</span>.<span class="type">TemplateBaseType</span> = <span class="typedef">typeof<span class="container">(<span class="type">NHamlTemplate</span>)</span>;</span></code></pre>
<p>This is for our new template class which will have the currentPage object on it:</p>
<pre class="highlighted"><code class="python">public <span class="class"><span class="keyword">class</span> <span class="title">NHamlTemplate</span> :</span> Template
{
    public INode currentPage { get; set; }
}</code></pre>
<p>It&#39;s a pretty simple class which we&#39;ve implemented, and we&#39;ve got a single property on there which we have to set, easy, we just have to update the <code>Render</code> method:</p>
<pre class="highlighted"><code class="erlang"><span class="function"><span class="title">using</span> <span class="params">(var output = new <span class="variable">StringWriter</span>()</span>)
{
    <span class="title">var</span> <span class="title">instance</span> = <span class="params">(<span class="variable">NHamlTemplate</span>)</span><span class="title">res</span>.C<span class="title">reateInstance</span><span class="params">()</span>;
    <span class="title">instance</span>.<span class="title">currentPage</span> = <span class="title">node</span>;
    <span class="title">instance</span>.R<span class="title">ender</span><span class="params">(output)</span>;

    <span class="title">return</span> <span class="title">output</span>.T<span class="title">oString</span><span class="params">()</span>;
}</code></pre>
<p>When we create an instance of our template from the file we can cast it to the custom template class and then assign the property to the actual node for the current page.</p>
<p>Now we can create a template like this:</p>
<pre class="highlighted"><code class="objectivec"><span class="variable">.content</span>
  <span class="preprocessor">#{currentPage.GetProperty("bodyText").Value}</span></code></pre>
<p>But if you run this we&#39;ve got an error, NHaml doesn&#39;t know what the <code>INode</code> object is! We need to pass in the assembly to the NHaml engine, so let&#39;s update the constructor:</p>
<pre class="highlighted"><code class="avrasm">internal NHamlTemplateEngine()
{
    _templateEngine = new TemplateEngine()<span class="comment">;</span>
    _templateEngine<span class="preprocessor">.Options</span><span class="preprocessor">.AddReference</span>(typeof(INode)<span class="preprocessor">.Assembly</span>)<span class="comment">;</span>
    _templateEngine<span class="preprocessor">.Options</span><span class="preprocessor">.TemplateContentProvider</span> = this<span class="comment">;</span>
    _templateEngine<span class="preprocessor">.Options</span><span class="preprocessor">.TemplateBaseType</span> = typeof(NHamlTemplate)<span class="comment">;</span>
}</code></pre>
<h2>Conclusion</h2>
<p>So there we go, we&#39;ve got a custom macro engine which runs NHaml and allow you to work against Umbraco data. </p>
<p>I&#39;ve also <a href="http://hg.slace.biz/nhaml-umbraco-macroengine">pushed the code up to bitbucket</a> too so you can grab a copy of it if you want to see it working.</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/nhaml-umbraco-macroengine';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>
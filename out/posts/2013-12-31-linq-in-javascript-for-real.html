<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>LINQ in JavaScript, ES6 style, for real this time - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">LINQ in JavaScript, ES6 style, for real this time</h1>
                <h2>31st December 2013</h2>
                <ul class="tags">
    
        
            <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
        
            <li><a class="icon icon-tag" href="/tagged/linq.html"><span>linq</span></a></li>
        
            <li><a class="icon icon-tag" href="/tagged/es6.html"><span>es6</span></a></li>
        
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">2nd August 2013</span>
                            <h3><a href="/posts/2013-08-02-ajax-without-jquery.html">AJAX without jQuery</a></h3>
                        </header>
                        <p>When was the last time you wrote an AJAX request?</p>
<p>When was the last time you did it without relying on jQuery?</p>
<p>In this article we&#39;ll look at how do do just that, how do make an AJAX request without jQuery to better understand what&#39;s going on.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/ajax.html"><span>ajax</span></a>
                            
                                <a class="icon icon-tag" href="/tagged/jquery.html"><span>jquery</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd July 2013</span>
                            <h3><a href="/posts/2013-07-22-array-like-objects.html">Array-like objects</a></h3>
                        </header>
                        <p>Just because it looks like a duck, walks like a duck, quacks like a duck doesn&#39;t mean it&#39;s a duck. There&#39;s dangers with making assumptions of your JavaScript objects based on their surface area.</p>
<p>That said, a lot of power can be gleamed by these seemingly innocent assumptions.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th July 2013</span>
                            <h3><a href="/posts/2013-07-14-javascript-new-operator.html">The JavaScript new operator</a></h3>
                        </header>
                        <p>Time to revisit something that was overlooked in the last post, the <code>new</code> operator in JavaScript and what it does.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">10th July 2013</span>
                            <h3><a href="/posts/2013-07-10-implementing-indexers-in-javascript.html">Implementing "indexers" in JavaScript</a></h3>
                        </header>
                        <p>My colleague Luke Drumm challenged me to implement C# style indexers in JavaScript.</p>
<p>So let&#39;s have a look at how you can do that, and how you can make some very interesting JavaScript objects that are self replicating. We&#39;ll build on the knowledge of using <code>bind</code> and <code>apply</code> from the last two posts.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2013</span>
                            <h3><a href="/posts/2013-07-05-javascript-binding-currying-and-arrows.html">JavaScript bind, currying and arrow functions</a></h3>
                        </header>
                        <p>After confusing my colleagues with how to invoke functions with a modifided set of arguments at a single time the next evolutionary point was to confuse them with creating functions that are always called with a different state.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p>In a recent post I talked about writing <a href="/posts/2013-09-06-linq-in-javascript-es6.html">LINQ in JavaScript using ES6 iterators</a> but then had to <a href="/posts/2013-09-16-linq-in-javascript-es6-clarification.html">take my words back</a> after it was pointed out to me that I wasn&#39;t actually using ES6 generators.</p>
<p>Well some time has past and I&#39;ve reworked my previous library to actually use the <a href="http://wiki.ecmascript.org/doku.php?id=harmony:iterators">iterators and generators</a> from ES6, so let&#39;s have a look at how to get going with it.</p>
<h1 id="lazy-evaluating-collections">Lazy evaluating collections</h1>
<p>Let&#39;s start simple, let&#39;s take an array and make it lazy evaluated. To do this I&#39;m going to create a <em>generator function</em> that deals with the iterations through the array:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">let</span> lazyArray = <span class="keyword">function</span>* (...args) {
    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; args.length; i++) {
        <span class="keyword">yield</span> args[i];
    }
};</code></pre>
<p>There&#39;s a few new things here to look at:</p>
<ul>
<li><code>function*</code> - this is a new syntax as part of ES6 and what it is doing is telling the JavaScript runtime that this function is a <em>genreator function</em>. This is important if we want to use <code>yield</code> to return values as <code>yield</code> (and <code>yield*</code> which I won&#39;t be covering) can only be used inside a generator function. <em>Side note: At the time of writing Firefox Nightly allows you to use <code>yield</code> outside of generator functions, yay bleeding edge!</em></li>
<li><code>...args</code> - I&#39;ve used this mostly for convenience, splats are coming in ES6 and it&#39;s so much easier to get arguments as arrays this way</li>
<li><code>let</code> - as you should know JavaScript is <em>function scoped</em> not <em>block scoped</em> (which C# is) so when you declare a variable, regardless of where you declare it, it&#39;ll always be available in the function. Well that was before we had ES6 and <code>let</code>. <code>let</code> allows you to create block scoped variables and as I play with more ES6 I find that I prefer to use <code>let</code> over <code>var</code> for declaring variables as it brings a more sane scope to what I&#39;m declaring</li>
</ul>
<p>Now let&#39;s use it:</p>
<pre class="highlighted"><code class="nginx"><span class="title">let</span> arr = lazyArray(<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>);</code></pre>
<p>Awesome, we&#39;ve got our lazy array, not quite as nice as using <code>[0,1,2,3...]</code>, but it&#39;s acceptable, so now we can do stuff with it, like read the values out:</p>
<pre class="highlighted"><code class="erlang"><span class="function"><span class="title">for</span> <span class="params">(let x of arr)</span> {
    <span class="title">console</span>.<span class="title">log</span><span class="params">(x)</span>;
}</code></pre>
<p>Again we&#39;re seeing some new syntax, this time in the form of a <code>for-of</code> statement. This is used to iterate through the results of a generator function. Since this function is lazy evaluated we don&#39;t have array indexers or anything on it, instead we have a <code>next</code> method which tells it we want the next iteration of the function which is similar to <a href="http://msdn.microsoft.com/en-us/library/system.collections.ienumerator.aspx"><code>IEnumerator</code> and it&#39;s <code>MoveNext</code> method</a>. In fact we could write something like this:</p>
<pre class="highlighted"><code class="objectivec">console<span class="variable">.log</span>(arr<span class="variable">.next</span>()<span class="variable">.value</span>); <span class="comment">//0</span>
console<span class="variable">.log</span>(arr<span class="variable">.next</span>()<span class="variable">.value</span>); <span class="comment">//1</span>
<span class="comment">//and so on</span></code></pre>
<p>The result of <code>next()</code> returns us an object like so:</p>
<pre class="highlighted"><code class="cs">{
    done: <span class="keyword">true</span>|<span class="keyword">false</span>,
    <span class="keyword">value</span>: <span class="keyword">value</span>|undefined
}</code></pre>
<p>So to decompose our <code>for-of</code> look it&#39;s more like this:</p>
<pre class="highlighted"><code class="erlang"><span class="keyword">let</span> x;
<span class="function"><span class="title">while</span> <span class="params">(!(x = arr.<span class="function_name">next</span>())</span>.<span class="title">done</span>) {
    <span class="title">console</span>.<span class="title">log</span><span class="params">(x.value)</span>;
}</code></pre>
<p>What we&#39;re saying is &quot;While the generator isn&#39;t <code>done</code> get the next and output the value&quot;. Personally I think the <code>for-of</code> syntax is much nicer, but there&#39;s advantaged to accessing items at your choosing, just like using the <code>IEnumerator</code> interface in C# has its advantages.</p>
<h1 id="building-filtering-for-our-generator-function">Building filtering for our generator function</h1>
<p>The problem with our <code>lazyArray</code> is that we have no way which we would be able to filter it, although it&#39;s <em>array like</em> it&#39;s not an array and we can&#39;t make it an array without loosing our lazy evaluation. So instead we&#39;ll start augmenting the function prototype:</p>
<pre class="highlighted"><code class="applescript">lazyArray.prototype.<span class="keyword">where</span> = function* (fn) {
    <span class="keyword">for</span> (let <span class="property">item</span> <span class="keyword">of</span> this) {
        <span class="keyword">if</span> (fn(<span class="property">item</span>)) {
            yield <span class="property">item</span>;
        }
    }
};</code></pre>
<p>This works in a very smooth fashion, you&#39;ll see that we&#39;re doing <code>for (let item of this)</code>, that&#39;s because we&#39;re augmenting a generator function, so we are lazy evaluating our &quot;parent&quot; collection, we can just <code>for-of</code> loop over that.</p>
<p>And ultimately what it means is we can do this:</p>
<pre class="highlighted"><code class="applescript"><span class="keyword">for</span> (let x <span class="keyword">of</span> arr.<span class="keyword">where</span>(i =&gt; i % <span class="number">2</span>)) {
    console.<span class="command">log</span>(x);
}
//Note: I'm using <span class="keyword">the</span> fat arrow syntax <span class="keyword">from</span> ES6 <span class="keyword">to</span> make <span class="keyword">it</span> more lambda-esq, <span class="keyword">but</span> you can use a <span class="string">"normal function"</span> instead.</code></pre>
<p>Sweet, we&#39;re filtering down to only items that are odd numbers!</p>
<h1 id="transforming-the-items">Transforming the items</h1>
<p>What&#39;s <code>filter</code> without <code>map</code> (well... <code>where</code> without <code>select</code>)? Again that&#39;s pretty easy to add by just augmenting our <code>lazyArray</code> prototype:</p>
<pre class="highlighted"><code class="cs">lazyArray.prototype.<span class="keyword">select</span> = function* (fn) {
    <span class="keyword">for</span> (<span class="keyword">let</span> item of <span class="keyword">this</span>) {
        <span class="keyword">yield</span> fn(item);
    }
};</code></pre>
<p>So we could do something like creating squares of everything:</p>
<pre class="highlighted"><code class="erlang"><span class="function"><span class="title">for</span> <span class="params">(let x of arr.<span class="function_name">select</span>(i =&gt; i * i))</span> {
    <span class="title">console</span>.<span class="title">log</span><span class="params">(x)</span>;
}</code></pre>
<h1 id="chaining">Chaining</h1>
<p>Now being able to do a single manipulation on a collection that is lazy is good, but really you&#39;re more likely to do a <code>filter</code> then a <code>map</code>, well let&#39;s go ahead:</p>
<pre class="highlighted"><code class="matlab"><span class="keyword">for</span> (let x of <span class="transposed_variable">arr.</span>where(<span class="built_in">i</span> =&gt; <span class="built_in">i</span> <span class="comment">% 2).select(i =&gt; i * i)) {</span>
    <span class="transposed_variable">console.</span><span class="built_in">log</span>(x);
}</code></pre>
<p>Hmm that&#39;s a syntax error, apparently our <code>where</code> function doesn&#39;t have a <code>select</code> method, well you&#39;d be right on spotting that. The reason is we&#39;ve been manipulating the <code>lazyArray</code> prototype, but we also need to manipulate the prototype of these new functions too, but to do that we&#39;ll have to assign them to variables rather than having them as anonymous functions:</p>
<pre class="highlighted"><code class="cs"><span class="keyword">let</span> <span class="keyword">where</span> = function* <span class="keyword">where</span>(fn) {
    <span class="keyword">for</span> (<span class="keyword">let</span> item of <span class="keyword">this</span>) {
        <span class="keyword">if</span> (fn(item))
            <span class="keyword">yield</span> item;
    }
};

<span class="keyword">let</span> <span class="keyword">select</span> = function* <span class="keyword">select</span>(fn) {
    <span class="keyword">for</span> (<span class="keyword">let</span> item of <span class="keyword">this</span>) {
        <span class="keyword">yield</span> fn(item);
    }
};

lazyArray.prototype.<span class="keyword">where</span> = <span class="keyword">where</span>;
lazyArray.prototype.<span class="keyword">select</span> = <span class="keyword">select</span>;
<span class="keyword">where</span>.prototype.<span class="keyword">select</span> = <span class="keyword">select</span>;
<span class="keyword">where</span>.prototype.<span class="keyword">where</span> = <span class="keyword">where</span>;
<span class="keyword">select</span>.prototype.<span class="keyword">where</span> = <span class="keyword">where</span>;
<span class="keyword">select</span>.prototype.<span class="keyword">select</span> = <span class="keyword">select</span>;</code></pre>
<p>And then we can:</p>
<pre class="highlighted"><code class="matlab"><span class="keyword">for</span> (let x of <span class="transposed_variable">arr.</span>where(<span class="built_in">i</span> =&gt; <span class="built_in">i</span> <span class="comment">% 2).select(i =&gt; i * i)) {</span>
    <span class="transposed_variable">console.</span><span class="built_in">log</span>(x);
}</code></pre>
<p>Or even:</p>
<pre class="highlighted"><code class="matlab"><span class="keyword">for</span> (let x of <span class="transposed_variable">arr.</span>select(<span class="built_in">i</span> =&gt; <span class="built_in">i</span> * <span class="built_in">i</span>).select(<span class="built_in">i</span> =&gt; <span class="built_in">i</span> * <span class="built_in">i</span>)) <span class="cell">{
    console.log(x);
}</span></code></pre>
<p>Now using your imagination you can see how other LINQ methods can be implemented.</p>
<h1 id="multiple-enumerations">Multiple enumerations</h1>
<p>Now this is where it&#39;ll get tricky, unlike C# JavaScript generator functions can&#39;t be iterated over multiple times, once a generator is spent <em>it&#39;s spent</em>. This will be a problem if you want to do something like this:</p>
<pre class="highlighted"><code class="rust"><span class="keyword">if</span> (arr.<span class="keyword">any</span>()) {
    <span class="keyword">for</span> (<span class="keyword">let</span> x <span class="keyword">of</span> arr) {
        <span class="comment">//stuff</span>
    }
}</code></pre>
<p>For an <code>any()</code> to work you need to walk the generator, but when you&#39;ve walked it once you can&#39;t walk it again, so how can do address that? The easiest way is to do what ReSharper suggests to me all the time in C#, get the collection in to an array, but doing so looses the laziness of our collection.</p>
<p>Instead what I&#39;ve done with LINQ in JavaScript is wrapped the enumerable in another function so you have to invoke it to get the generator, like so:</p>
<pre class="highlighted"><code class="rust"><span class="keyword">if</span> (arr.<span class="keyword">any</span>()) {
    <span class="keyword">for</span> (<span class="keyword">let</span> x <span class="keyword">of</span> arr()) {
        <span class="comment">//stuff</span>
    }
}</code></pre>
<p>So our <code>arr</code> object is actually a non-generator function and you have to invoke it to use walk it, but to make it nicer to work with I&#39;ve made functions like <code>any()</code> take care of that for you so you don&#39;t have to <code>arr().any()</code> as I think that&#39;d be a code smell. But this does mean that the result of a call to <code>where</code> or <code>select</code> will need to be invoked like so:</p>
<pre class="highlighted"><code class="applescript"><span class="keyword">for</span> (let <span class="property">item</span> <span class="keyword">of</span> arr.<span class="keyword">where</span>(x =&gt; x % <span class="number">2</span>)()) {
    console.<span class="command">log</span>(<span class="property">item</span>);
}</code></pre>
<p>But really I&#39;m of the opinion you shouldn&#39;t be doing your lambda expressions inside of the <code>for-of</code> declaration anyway so I think that it&#39;s fine.</p>
<h1 id="wrapping-up">Wrapping up</h1>
<p>Well there we have it, how we can use ES6 generators to create LINQ in JavaScript which is <em>actually</em> lazy evaluated. I&#39;ve gone ahread and published the code which I&#39;ve been working on <a href="https://github.com/aaronpowell/linq-in-javascript">to my GitHub repo</a> and you can also get it <a href="https://npmjs.org/package/linq-es6">via npm</a> if you&#39;re using Node.js <code>0.11.4</code> or higher (and turn on the harmony features of v8). So go one, check out <a href="https://github.com/aaronpowell/linq-in-javascript/tree/master/tests">the tests</a> for some fun examples of what you can do like:</p>
<pre class="highlighted"><code class="matlab">describe(<span class="string">'Interesting API usages'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
   it(<span class="string">'should calc prime numbers'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        var range = <span class="transposed_variable">Enumerable.</span>range(<span class="number">3</span>, <span class="number">10</span>);

        var <span class="built_in">primes</span> = <span class="transposed_variable">range.</span>where(n =&gt; <span class="transposed_variable">Enumerable.</span>range(<span class="number">2</span>, <span class="transposed_variable">Math.</span><span class="built_in">floor</span>(<span class="transposed_variable">Math.</span><span class="built_in">sqrt</span>(n))).all(<span class="built_in">i</span> =&gt; n <span class="comment">% i &gt; 0));</span>

        var expectedPrimes = <span class="matrix">[<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>]</span>;
        var index = <span class="number">0</span>;
        <span class="keyword">for</span> (let prime of <span class="built_in">primes</span>()) <span class="cell">{
            expect(prime).to.equal(expectedPrimes[index]);
            index++;
        }</span>
    }); 
});</code></pre>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/posts/2013-12-31-linq-in-javascript-for-real.html';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>